<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chill Space - Spotify Integration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* K√çNH L·ªéNG (LIQUID GLASS) */
            --card-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-main: #fff; 
            --text-sub: #eee;
            --accent-color: #a29bfe;
            --radius: 24px;
            --font-main: 'Quicksand', sans-serif;
        }

        select, input { color: #333 !important; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); user-select: none; }
        
        body {
            height: 100vh; width: 100vw; overflow: hidden; background-color: #111; 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            display: flex; justify-content: space-between; padding: 25px;
            color: var(--text-main); 
            transition: background-image 1s ease-in-out, background-color 1s ease;
            position: relative;
        }

        /* --- VIDEO BACKGROUND --- */
        #video-bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden; background-color: #000; pointer-events: none;
            opacity: 0; transition: opacity 1s ease-in-out;
        }
        #video-bg-container.active { opacity: 1; }
        
        #bg-video-player {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scale(1.02); 
        }

        /* --- UI LAYERS --- */
        .left-sidebar, .right-area, .top-nav-container, #intro-overlay, #zen-overlay {
            position: relative; z-index: 10; 
        }
        .left-sidebar *, .right-area *, .top-nav-container * { pointer-events: auto; }
        #intro-overlay, #zen-overlay { pointer-events: auto !important; }
        .top-nav-container { position: absolute; } 

        /* --- PANEL STYLES (GLASS) --- */
        .cozy-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            border-radius: var(--radius);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            height: auto; min-height: fit-content; flex-shrink: 0; pointer-events: auto;
            color: white; 
        }
        .panel-header h3 { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .toggle-btn { color: rgba(255,255,255,0.9); }
        p { color: rgba(255,255,255,0.95) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .top-nav-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            top: 25px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 12px; padding: 8px; border-radius: 50px; z-index: 99999;
        }

        /* Elements */
        .panel-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 20px 25px; min-height: 70px; }
        .panel-content { transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); opacity: 1; max-height: 800px; padding: 0 25px 25px 25px; overflow: hidden; }
        .cozy-panel.collapsed .toggle-btn { transform: rotate(180deg); }
        .cozy-panel.collapsed .panel-content { opacity: 0; max-height: 0; padding: 0 25px; margin: 0; }
        .cozy-panel.collapsed { flex-grow: 0 !important; height: auto !important; padding-bottom: 0 !important; }
        .mini-display { font-size: 14px; margin-left: auto; margin-right: 15px; font-weight: bold; color: var(--accent-color); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; display: flex; align-items: center; gap: 6px; }
        .cozy-panel.collapsed .mini-display { opacity: 1; }

        /* Layout */
        .left-sidebar, .right-area { 
            width: 360px; display: flex; flex-direction: column; gap: 15px; 
            max-height: 100%; overflow-y: auto; padding-right: 5px; padding-bottom: 20px;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 10px; }
        :hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.8); }

        /* Controls */
        .learning-filter { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .filter-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        .fc-select { flex-grow: 1; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.8); color: #333; font-family: var(--font-main); font-size: 12px; font-weight: 600; outline: none; cursor: pointer; width: 0; }
        .btn-tool { width: 28px; height: 28px; border-radius: 8px; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 11px; flex-shrink: 0; }
        .btn-tool:hover { opacity: 0.9; transform: scale(1.05); }
        .btn-add-sub { background: #74b9ff; } .btn-del-sub { background: #ff7675; }
        .btn-add-lvl { background: #55efc4; } .btn-del-lvl { background: #fab1a0; }
        .btn-add-card { background: var(--accent-color); width: 100%; margin-top: 5px; border-radius: 10px;}
        .fc-delete-btn { position: absolute; top: 10px; right: 10px; color: #ff7675; cursor: pointer; font-size: 14px; padding: 5px; opacity: 0.5; transition: 0.2s; z-index: 5; }
        .custom-form { background: rgba(255,255,255,0.8); padding: 15px; border-radius: 16px; margin-bottom: 15px; display: none; flex-direction: column; gap: 10px; animation: slideDown 0.3s ease; border: 1px solid rgba(255,255,255,0.5); }
        @keyframes slideDown { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }
        .fc-input { padding: 10px; border: 1px solid rgba(255,255,255,0.5); background: white; border-radius: 8px; outline: none; font-size: 13px; font-family: var(--font-main); color: #333;}
        .btn-save-card { padding: 8px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .form-title { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; }

        .flashcard-container { perspective: 1000px; width: 100%; height: 180px; margin-bottom: 15px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .flashcard-container.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; border-radius: 16px; background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); }
        .flashcard-front { color: #333; }
        .flashcard-back { background: var(--accent-color); color: white; transform: rotateY(180deg); }
        .fc-category { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 10px; }
        .fc-content { font-size: 18px; font-weight: 700; line-height: 1.4; }
        .flashcard-back .fc-category { color: rgba(255,255,255,0.7); }
        .fc-controls { display: flex; gap: 10px; justify-content: center; }
        .btn-fc { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-fc-review { background: rgba(255,255,255,0.8); color: #333; }
        .btn-fc-master { background: var(--accent-color); color: white; }
        .fc-progress { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-bottom: 15px; overflow: hidden; }
        .fc-bar { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s ease; }

        /* Intro & Zen */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(30px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s ease; pointer-events: auto !important; }
        .intro-content { text-align: center; background: rgba(255, 255, 255, 0.9); padding: 40px 60px; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 800px; width: 90%; animation: float 3s ease-in-out infinite; color: #333;}
        .intro-title { font-size: 36px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .intro-sub { font-size: 16px; color: #666; margin-bottom: 30px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .mood-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; transition: all 0.3s ease; }
        .mood-icon { font-size: 32px; }
        .mood-text { font-weight: 700; color: #333; font-size: 14px;}
        .mood-btn:hover { transform: translateY(-5px); background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 10px 20px rgba(143, 170, 194, 0.3); }
        .mood-btn:hover .mood-text { color: white; }
        .hidden-intro { opacity: 0; visibility: hidden; pointer-events: none !important; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        #zen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 40, 50, 0.95); z-index: 9998; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.8s ease, visibility 0.8s ease; color: white; pointer-events: auto !important;}
        #zen-overlay.active { opacity: 1; visibility: visible; }
        .breathing-circle { width: 200px; height: 200px; background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%); border-radius: 50%; box-shadow: 0 0 50px rgba(168, 230, 207, 0.4); margin-bottom: 40px; transform: scale(1); }
        .breathing-anim { animation: breathe 8s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.5); opacity: 1; } }
        .zen-instruction { font-size: 24px; font-weight: 300; margin-bottom: 20px; letter-spacing: 2px; }
        .zen-quote { font-size: 18px; font-style: italic; max-width: 600px; text-align: center; line-height: 1.6; opacity: 0.9; margin-bottom: 40px; }
        .btn-close-zen { padding: 12px 30px; border: 2px solid rgba(255,255,255,0.3); border-radius: 30px; background: transparent; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-close-zen:hover { background: white; color: #333; }

        .nav-pill { padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 14px; cursor: pointer; color: #333; transition: all 0.3s; }
        .nav-pill.active { background: var(--accent-color); color: white; }
        .nav-pill.sos-btn { background: #ff7675; color: white; box-shadow: 0 4px 15px rgba(255, 118, 117, 0.4); animation: pulse-red 2s infinite; }
        .nav-pill.sos-btn:hover { background: #d63031; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .explore-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; padding-bottom: 5px;}
        .explore-item { font-size: 26px; cursor: pointer; text-align: center; padding: 8px; border-radius: 16px; background: rgba(255,255,255,0.5); transition: all 0.3s; }
        .explore-item.active { background: var(--accent-color); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .buddy-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .buddy-item { position: relative; height: 70px; border-radius: 12px; cursor: pointer; overflow: hidden; border: 2px solid transparent; background-size: cover; background-position: center; transition: all 0.3s; }
        .buddy-item:hover { transform: scale(1.02); }
        .buddy-item.active { border-color: var(--accent-color); transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .buddy-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; text-align: center; font-weight: bold;}

        .timer-display { font-size: 56px; font-weight: 500; text-align: center; margin: 5px 0; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; }
        .timer-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.3); padding: 4px; border-radius: 12px; width: fit-content; margin: 0 auto 10px; }
        .timer-controls span { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; color: white; cursor: pointer; }
        .timer-controls span.active { background: white; color: var(--accent-color); }
        .btn-timer { width: 100%; padding: 12px; border: none; border-radius: 16px; background: var(--accent-color); color: white; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .adjust-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .btn-adjust { width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255,255,255,0.3); color: white; cursor: pointer; font-weight: bold; font-size: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;}
        .btn-adjust:hover { background: var(--accent-color); color: white; transform: scale(1.1); }
        .custom-input { width: 45px; padding: 5px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 16px; outline: none; color: white; border-bottom: 2px solid rgba(255,255,255,0.5); }
        .btn-set-confirm { padding: 6px 12px; background: var(--text-main); color: white; border: none; border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; }
        
        #task-list { list-style: none; max-height: 250px; overflow-y: auto; padding-right: 5px; margin-top: 5px;}
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 8px; border-radius: 12px; transition: all 0.2s; color: white;}
        .task-checkbox { accent-color: var(--accent-color); width: 18px; height: 18px; cursor: pointer;}
        .add-task-box { margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); }
        .task-item.completed .task-text { text-decoration: line-through; color: rgba(255,255,255,0.5); }
        .music-divider { height: 1px; background: rgba(255,255,255,0.2); margin: 15px 0; border: none; }
        .music-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .album-art { width: 48px; height: 48px; background: rgba(255,255,255,0.5); border-radius: 12px; background-size: cover; }
        input[type=range] { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; margin-top: 5px; cursor: pointer; flex-grow: 1; }

        /* SPOTIFY/CUSTOM INPUT STYLES */
        .spotify-container { margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .spotify-toggle { font-size: 11px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 8px; opacity: 0.8; transition: 0.3s; }
        .spotify-toggle:hover { opacity: 1; color: var(--accent-color); }
        .spotify-input-group { display: none; gap: 5px; margin-bottom: 10px; }
        .spotify-input { flex-grow: 1; padding: 6px; border-radius: 8px; border: none; font-size: 11px; outline: none; background: rgba(255,255,255,0.8); color: #333; }
        .btn-spotify-load { padding: 6px 10px; background: #1DB954; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }
        #spotify-frame { width: 100%; border-radius: 12px; border: none; margin-top: 5px; display: none; }

        /* FOCUS MODE */
        body.focus-active .left-sidebar { display: none !important; }
        body.focus-active #panel-flashcards { display: none !important; }
        body.focus-active .right-area { width: 100%; justify-content: center; align-items: center; height: 100%; overflow: hidden; }
        body.focus-active #panel-timer { transform: scale(1.4); transition: transform 0.5s ease; z-index: 50; }

    </style>
</head>
<body>

    <div id="video-bg-container"></div>

    <audio id="ambient-audio" loop></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-alarm" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="intro-overlay">
        <div class="intro-content">
            <div class="intro-title">Ch√†o b·∫°n, h√¥m nay b·∫°n th·∫ø n√†o?</div>
            <div class="intro-sub">Ch·ªçn m·ªôt tr·∫°ng th√°i ƒë·ªÉ thi·∫øt l·∫≠p kh√¥ng gian nh√©!</div>
            <div class="mood-grid">
                <button class="mood-btn" onclick="selectMood('morning'); playSFX('click')"><span class="mood-icon">üå§Ô∏è</span><span class="mood-text">H√†o h·ª©ng</span></button>
                <button class="mood-btn" onclick="selectMood('rain'); playSFX('click')"><span class="mood-icon">ü§Ø</span><span class="mood-text">CƒÉng th·∫≥ng</span></button>
                <button class="mood-btn" onclick="selectMood('library'); playSFX('click')"><span class="mood-icon">üìö</span><span class="mood-text">T·∫≠p trung</span></button>
                <button class="mood-btn" onclick="selectMood('night'); playSFX('click')"><span class="mood-icon">üåô</span><span class="mood-text">Chill & Relax</span></button>
                <button class="mood-btn" onclick="selectMood('sunset'); playSFX('click')"><span class="mood-icon">üé®</span><span class="mood-text">S√°ng t·∫°o</span></button>
                <button class="mood-btn" onclick="selectMood('cafe'); playSFX('click')"><span class="mood-icon">‚òï</span><span class="mood-text">Bu·ªìn ch√°n</span></button>
            </div>
        </div>
    </div>

    <div id="zen-overlay">
        <div class="breathing-circle" id="zen-circle"></div>
        <div class="zen-instruction" id="zen-text">H√≠t s√¢u...</div>
        <div class="zen-quote" id="zen-quote">"..."</div>
        <button class="btn-close-zen" onclick="closeZenMode(); playSFX('click')">M√¨nh ·ªïn r·ªìi, quay l·∫°i th√¥i</button>
    </div>

    <div class="top-nav-container">
        <div class="nav-pill" onclick="playSFX('click')">L·ª≠a</div>
        <div class="nav-pill active" id="btn-myspace" onclick="switchView('myspace'); playSFX('click')">Kh√¥ng gian</div>
        <div class="nav-pill" id="btn-focus" onclick="switchView('focus'); playSFX('click')">T·∫≠p trung</div>
        <div class="nav-pill sos-btn" onclick="openZenMode(); playSFX('click')">SOS Gi·∫£m Stress üÜò</div>
    </div>

    <div class="left-sidebar">
        <div class="cozy-panel" id="panel-left">
            <div class="panel-header" onclick="togglePanel('panel-left'); playSFX('click')">
                <h3>Kh√°m ph√° Kh√¥ng gian</h3>
                <div class="mini-display" id="mini-music"><i class="fa-solid fa-music"></i> <span id="mini-track-name">Chill Lofi</span></div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">H√¨nh n·ªÅn & √Çm thanh</p>
                <div class="explore-grid" id="explore-grid"></div>
                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px;">H·ªçc c√πng B·∫°n b√®</p>
                <div class="buddy-grid" id="buddy-grid"></div>
                <hr class="music-divider">
                
                <div id="local-player-controls">
                    <div class="music-player">
                        <div class="music-info">
                            <div class="album-art" id="album-art" style="background-image: url('');"></div>
                            <div>
                                <p class="track-name" id="track-name" style="font-weight:bold; font-size:14px;">Chill Lofi</p>
                                <p style="font-size: 10px; opacity: 0.8;">√Çm l∆∞·ª£ng m√¥i tr∆∞·ªùng</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-volume-xmark" id="mute-btn" style="cursor: pointer; width: 20px; color: var(--accent-color);" onclick="toggleMute(); playSFX('click')"></i>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0" title="Ambient Volume" oninput="changeVolume(this.value)">
                        </div>
                    </div>
                </div>

                <div class="spotify-container">
                    <div class="spotify-toggle" onclick="toggleSpotifyInput(); playSFX('click')">
                        <i class="fa-brands fa-spotify"></i> Nh·∫≠p Playlist Spotify/SoundCloud c·ªßa b·∫°n
                    </div>
                    <div class="spotify-input-group" id="spotify-input-group">
                        <input type="text" id="spotify-url" class="spotify-input" placeholder="D√°n link Playlist v√†o ƒë√¢y...">
                        <button class="btn-spotify-load" onclick="loadCustomEmbed(); playSFX('click')">Ph√°t</button>
                    </div>
                    <div id="embed-container">
                        </div>
                </div>

            </div>
        </div>

        <div class="cozy-panel" id="panel-tasks">
            <div class="panel-header" onclick="togglePanel('panel-tasks'); playSFX('click')">
                <h3>Danh s√°ch Vi·ªác <span id="task-count" style="font-size: 14px; opacity: 0.8; font-weight: normal;">(0)</span></h3>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <ul id="task-list"></ul>
                <div class="add-task-box">
                    <div id="btn-show-add" onclick="showInput(); playSFX('click')" style="cursor: pointer;"><i class="fa-solid fa-plus-circle"></i> Th√™m vi·ªác m·ªõi</div>
                    <div id="input-group" style="display:none; gap:5px;">
                        <input type="text" id="new-task-input" placeholder="M·ª•c ti√™u c·ªßa b·∫°n l√† g√¨?" style="flex-grow:1; padding:8px; border:1px solid #eee; border-radius:8px;">
                        <button class="btn-add-confirm" onclick="addTask(); playSFX('click')" style="padding:5px 10px; background:var(--accent-color); color:white; border:none; border-radius:8px;">Th√™m</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-area">
        <div class="cozy-panel" id="panel-timer">
            <div class="panel-header" onclick="togglePanel('panel-timer'); playSFX('click')">
                <h3>ƒê·ªìng h·ªì</h3>
                <div class="mini-display" id="mini-timer" style="font-size: 18px;">25:00</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <div class="timer-controls">
                    <span id="btn-pomodoro" class="active" onclick="switchMode('pomodoro'); playSFX('click')">T·∫≠p trung</span>
                    <span id="btn-short" onclick="switchMode('short'); playSFX('click')">Ngh·ªâ ng·∫Øn</span>
                    <span id="btn-long" onclick="switchMode('long'); playSFX('click')">Ngh·ªâ d√†i</span>
                </div>
                <div class="timer-display" id="timer-text">25:00</div>
                <div class="adjust-container">
                    <button class="btn-adjust" onclick="adjustTime(-5); playSFX('click')">-5</button>
                    <button class="btn-adjust" onclick="adjustTime(-1); playSFX('click')">-1</button>
                    <input type="number" id="custom-minutes" class="custom-input" value="25" min="1">
                    <button class="btn-adjust" onclick="adjustTime(1); playSFX('click')">+1</button>
                    <button class="btn-adjust" onclick="adjustTime(5); playSFX('click')">+5</button>
                    <button class="btn-set-confirm" onclick="applyCustomTime(); playSFX('click')">ƒê·∫∑t</button>
                </div>
                <button class="btn-timer" id="btn-action" onclick="toggleTimer(); playSFX('click')">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>

        <div class="cozy-panel" id="panel-flashcards">
            <div class="panel-header" onclick="togglePanel('panel-flashcards'); playSFX('click')">
                <h3>H·ªçc Nhanh</h3>
                <div class="mini-display" id="mini-fc">0 Th·∫ª xong</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                
                <div class="learning-filter">
                    <div class="filter-row">
                        <button class="btn-tool btn-add-sub" onclick="toggleAddSubjectForm(); playSFX('click')" title="Th√™m m√¥n"><i class="fa-solid fa-folder-plus"></i></button>
                        <button class="btn-tool btn-del-sub" onclick="deleteSubject(); playSFX('click')" title="X√≥a m√¥n"><i class="fa-solid fa-trash"></i></button>
                        <select id="subject-select" class="fc-select"></select>
                    </div>
                    <div class="filter-row">
                        <button class="btn-tool btn-add-lvl" onclick="toggleAddLevelForm(); playSFX('click')" title="Th√™m c·∫•p ƒë·ªô"><i class="fa-solid fa-layer-group"></i></button>
                        <button class="btn-tool btn-del-lvl" onclick="deleteLevel(); playSFX('click')" title="X√≥a c·∫•p ƒë·ªô"><i class="fa-solid fa-trash-can"></i></button>
                        <select id="level-select" class="fc-select"></select>
                    </div>
                    <button class="btn-tool btn-add-card" onclick="toggleAddCardForm(); playSFX('click')" title="Th√™m th·∫ª m·ªõi"><i class="fa-solid fa-plus"></i> &nbsp;Th√™m Th·∫ª</button>
                </div>

                <div id="add-subject-form" class="custom-form" style="display:none;">
                    <div class="form-title">T·∫°o m√¥n h·ªçc m·ªõi</div>
                    <input type="text" id="new-subject-name" class="fc-input" placeholder="T√™n m√¥n (VD: L·ªãch s·ª≠)">
                    <input type="text" id="new-subject-level" class="fc-input" placeholder="T√™n c·∫•p ƒë·ªô ƒë·∫ßu (VD: Ch∆∞∆°ng 1)">
                    <button class="btn-save-card" onclick="saveNewSubject(); playSFX('click')">T·∫°o M√¥n</button>
                </div>
                
                <div id="add-level-form" class="custom-form" style="display:none;">
                    <div class="form-title">Th√™m c·∫•p ƒë·ªô m·ªõi</div>
                    <input type="text" id="new-level-name" class="fc-input" placeholder="T√™n c·∫•p ƒë·ªô (VD: N√¢ng cao)">
                    <button class="btn-save-card" onclick="saveNewLevel(); playSFX('click')">Th√™m C·∫•p ƒê·ªô</button>
                </div>

                <div id="add-card-form" class="custom-form" style="display:none;">
                    <div class="form-title">Th√™m th·∫ª v√†o b√†i h·ªçc n√†y</div>
                    <input type="text" id="new-card-q" class="fc-input" placeholder="C√¢u h·ªèi / T·ª´ v·ª±ng">
                    <input type="text" id="new-card-a" class="fc-input" placeholder="ƒê√°p √°n / ƒê·ªãnh nghƒ©a">
                    <button class="btn-save-card" onclick="saveCustomCard(); playSFX('click')">L∆∞u Th·∫ª</button>
                </div>

                <div class="fc-progress"><div class="fc-bar" id="fc-bar"></div></div>
                <div class="flashcard-container" onclick="flipCard(this); playSFX('click')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <i class="fa-solid fa-trash fc-delete-btn" onclick="deleteCurrentCard(event); playSFX('click')" title="X√≥a th·∫ª n√†y"></i>
                            <div class="fc-category" id="fc-cat-front">Danh m·ª•c</div>
                            <div class="fc-content" id="fc-q">ƒêang t·∫£i...</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-top:15px;">(B·∫•m ƒë·ªÉ l·∫≠t)</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="fc-category" id="fc-cat-back">ƒê·ªãnh nghƒ©a</div>
                            <div class="fc-content" id="fc-a">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>
                <div class="fc-controls">
                    <button class="btn-fc btn-fc-review" onclick="nextCard(false); playSFX('click')">C·∫ßn √¥n l·∫°i üß†</button>
                    <button class="btn-fc btn-fc-master" onclick="nextCard(true); playSFX('success')">ƒê√£ thu·ªôc ‚úÖ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const THEMES = {
            morning: { emoji: "üå§Ô∏è", type: "local", bg: "media/8.mp4", track: "S·ªõm Mai", color: "#f3a683", audio: "https://cdn.pixabay.com/download/audio/2022/02/07/audio_18bf8f6b02.mp3?filename=forest-birds-11107.mp3" },
            cafe: { emoji: "‚òï", type: "local", bg: "media/4.mp4", track: "Qu√°n C√† Ph√™", color: "#cf6a87", audio: "https://cdn.pixabay.com/download/audio/2022/03/09/audio_822f7736b7.mp3?filename=coffee-shop-chatter-14787.mp3" },
            rain: { emoji: "üåßÔ∏è", type: "local", bg: "media/2.mp4", track: "Ng√†y M∆∞a", color: "#546de5", audio: "https://cdn.pixabay.com/download/audio/2021/09/06/audio_9893d56d5d.mp3?filename=soft-rain-ambient-111154.mp3" },
            forest: { emoji: "üå≤", type: "local", bg: "media/3.mp4", track: "R·ª´ng S√¢u", color: "#63cdda", audio: "https://cdn.pixabay.com/download/audio/2021/08/09/audio_27bd22e959.mp3?filename=forest-wind-and-birds-6881.mp3" },
            sunset: { emoji: "üåá", type: "local", bg: "media/5.mp4", track: "Ho√†ng H√¥n", color: "#e77f67", audio: "https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3?filename=night-crickets-1536.mp3" },
            night: { emoji: "üåô", type: "local", bg: "media/6.mp4", track: "B·∫ßu Tr·ªùi ƒê√™m", color: "#596275", audio: "https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3?filename=night-ambience-17064.mp3" },
            library: { emoji: "üìö", type: "local", bg: "media/7.mp4", track: "Th∆∞ Vi·ªán", color: "#d1d8e0", audio: "https://cdn.pixabay.com/download/audio/2022/03/10/audio_5b38d33077.mp3?filename=room-tone-30691.mp3" }
        };
        
        const BUDDIES = {
            lofi: { type: "local", url: "media/lofigirl-loop-audio.mp4", name: "Lofi Girl (B·∫£n Local)", thumb: "https://img.youtube.com/vi/jfKfPfyJRdk/0.jpg" }
        };

        const LEARNING_DATABASE = {
            "Ti·∫øng Anh": { "C∆° b·∫£n": [{ q: "Hello", a: "Xin ch√†o" }, { q: "Apple", a: "Qu·∫£ t√°o" }], "IELTS": [{ q: "Serendipity", a: "S·ª± t√¨nh c·ªù may m·∫Øn" }] },
            "C√¥ng ngh·ªá": { "HTML": [{ q: "<div>", a: "Th·∫ª t·∫°o kh·ªëi" }] }
        };
        const ZEN_QUOTES = ["H√≠t v√†o s·ª± b√¨nh y√™n...", "B·∫°n l√†m t·ªët l·∫Øm...", "Ngh·ªâ ng∆°i x√≠u nh√©...", "H√£y nh·∫π nh√†ng v·ªõi b·∫£n th√¢n."];

        let studyQueue = [], masteredCount = 0, totalCards = 0, currentSubject = "", currentLevel = "";
        const exploreGrid = document.getElementById('explore-grid'), buddyGrid = document.getElementById('buddy-grid'), root = document.documentElement;
        const videoContainer = document.getElementById('video-bg-container');
        const ambientPlayer = document.getElementById('ambient-audio');
        let isMuted = true; let lastVolume = 0.5; let transitionTimeout;

        function playSFX(type) {
            const sound = document.getElementById(`sfx-${type}`);
            if(sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
        }

        // --- SPOTIFY INTEGRATION LOGIC ---
        function toggleSpotifyInput() {
            const group = document.getElementById('spotify-input-group');
            group.style.display = group.style.display === 'flex' ? 'none' : 'flex';
        }

        function loadCustomEmbed() {
            const url = document.getElementById('spotify-url').value;
            const container = document.getElementById('embed-container');
            
            if(!url) return alert("Vui l√≤ng nh·∫≠p Link!");

            let embedSrc = "";
            
            // X·ª≠ l√Ω Spotify Link
            if(url.includes('spotify.com')) {
                // Chuy·ªÉn link th∆∞·ªùng th√†nh link embed
                // Vd: https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M
                // -> https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M
                const parts = url.split('spotify.com/');
                if(parts.length > 1) {
                    embedSrc = `https://open.spotify.com/embed/${parts[1]}`;
                }
            } 
            // X·ª≠ l√Ω SoundCloud (C·∫ßn iframe code, nh∆∞ng h·ªó tr·ª£ link ƒë∆°n gi·∫£n n·∫øu d√πng API - ·ªü ƒë√¢y d√πng iframe ƒë∆°n gi·∫£n)
            else if (url.includes('soundcloud.com')) {
                // SoundCloud c·∫ßn oEmbed API, nh∆∞ng ta c√≥ th·ªÉ nh·∫Øc ng∆∞·ªùi d√πng nh·∫≠p m√£ nh√∫ng iframe
                // ƒê·ªÉ ƒë∆°n gi·∫£n, ta nh·∫≠n ƒë·ªãnh ƒë√¢y l√† Spotify ∆∞u ti√™n.
                alert("V·ªõi SoundCloud, vui l√≤ng nh·∫≠p m√£ nh√∫ng (Embed Code) thay v√¨ Link.");
                return;
            }

            if(embedSrc) {
                container.innerHTML = `<iframe src="${embedSrc}" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" style="border-radius:12px; margin-top:5px;"></iframe>`;
                container.style.display = 'block';
                
                // T·∫Øt nh·∫°c n·ªÅn (Local)
                ambientPlayer.pause();
                document.getElementById('local-player-controls').style.opacity = '0.3'; // L√†m m·ªù control nh·∫°c n·ªÅn
                
                // L∆∞u link v√†o localStorage ƒë·ªÉ l·∫ßn sau v√†o l·∫°i c√≥ ngay
                localStorage.setItem('saved_spotify_url', url);
            }
        }

        // Kh√¥i ph·ª•c link ƒë√£ l∆∞u
        window.addEventListener('load', () => {
            const savedUrl = localStorage.getItem('saved_spotify_url');
            if(savedUrl) {
                document.getElementById('spotify-url').value = savedUrl;
                // T√πy ch·ªçn: T·ª± ƒë·ªông load lu√¥n n·∫øu mu·ªën
                // loadCustomEmbed();
            }
        });

        function changeVolume(val) {
            ambientPlayer.volume = val;
            isMuted = (val == 0);
            if (!isMuted) lastVolume = val;
            updateMuteIcon();
            // N·∫øu ch·ªânh volume, ph·ª•c h·ªìi ƒë·ªô m·ªù c·ªßa player
            document.getElementById('local-player-controls').style.opacity = '1';
        }

        function toggleMute() {
            if (isMuted) {
                ambientPlayer.volume = lastVolume > 0 ? lastVolume : 0.5;
                document.getElementById('volume-slider').value = ambientPlayer.volume;
                isMuted = false;
            } else {
                lastVolume = ambientPlayer.volume;
                ambientPlayer.volume = 0;
                document.getElementById('volume-slider').value = 0;
                isMuted = true;
            }
            updateMuteIcon();
        }

        function updateMuteIcon() {
            const btn = document.getElementById('mute-btn');
            if (isMuted || ambientPlayer.volume === 0) {
                btn.className = 'fa-solid fa-volume-xmark';
            } else {
                btn.className = 'fa-solid fa-volume-high';
            }
        }

        function switchView(view) {
            document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
            if(view === 'myspace') {
                document.getElementById('btn-myspace').classList.add('active');
                document.body.classList.remove('focus-active');
            } else if (view === 'focus') {
                document.getElementById('btn-focus').classList.add('active');
                document.body.classList.add('focus-active');
            }
        }

        function initApp() { 
            initExplore(); 
            initLearningDropdowns(); 
            updateDisplay(); 
            updateCount(); 
            
            // Set Default Mute
            ambientPlayer.volume = 0;
            document.getElementById('volume-slider').value = 0;
            updateMuteIcon();
        }

        function initLearningDropdowns() {
            const subjectSelect = document.getElementById('subject-select');
            const levelSelect = document.getElementById('level-select');
            subjectSelect.innerHTML = '';
            if(Object.keys(LEARNING_DATABASE).length === 0) {
                const opt = document.createElement('option'); opt.innerText = "Tr·ªëng"; subjectSelect.appendChild(opt);
                levelSelect.innerHTML = ''; return;
            }
            Object.keys(LEARNING_DATABASE).forEach(sub => {
                const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub;
                subjectSelect.appendChild(opt);
            });
            subjectSelect.onchange = () => {
                currentSubject = subjectSelect.value;
                if(!LEARNING_DATABASE[currentSubject]) return;
                const levels = Object.keys(LEARNING_DATABASE[currentSubject]);
                levelSelect.innerHTML = '';
                levels.forEach(lvl => {
                    const opt = document.createElement('option'); opt.value = lvl; opt.innerText = lvl;
                    levelSelect.appendChild(opt);
                });
                changeTopic();
            };
            levelSelect.onchange = changeTopic;
            subjectSelect.dispatchEvent(new Event('change'));
        }

        function changeTopic() {
            currentSubject = document.getElementById('subject-select').value;
            currentLevel = document.getElementById('level-select').value;
            if(!currentSubject || !currentLevel) {
                studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                return;
            }
            const originalCards = LEARNING_DATABASE[currentSubject][currentLevel];
            studyQueue = JSON.parse(JSON.stringify(originalCards));
            totalCards = studyQueue.length;
            masteredCount = 0;
            renderCard();
        }

        function toggleAddSubjectForm() { hideAllForms(); const f=document.getElementById('add-subject-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddLevelForm() { hideAllForms(); const f=document.getElementById('add-level-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddCardForm() { hideAllForms(); const f=document.getElementById('add-card-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function hideAllForms() {
            document.getElementById('add-subject-form').style.display='none';
            document.getElementById('add-level-form').style.display='none';
            document.getElementById('add-card-form').style.display='none';
        }

        function saveNewSubject() {
            const subName = document.getElementById('new-subject-name').value;
            const subLevel = document.getElementById('new-subject-level').value;
            if(subName && subLevel) {
                LEARNING_DATABASE[subName] = {}; LEARNING_DATABASE[subName][subLevel] = [];
                initLearningDropdowns();
                const subSelect = document.getElementById('subject-select'); subSelect.value = subName; subSelect.dispatchEvent(new Event('change'));
                document.getElementById('new-subject-name').value=''; document.getElementById('new-subject-level').value=''; toggleAddSubjectForm();
                playSFX('success');
            }
        }

        function saveNewLevel() {
            const newLvl = document.getElementById('new-level-name').value;
            if(newLvl && currentSubject) {
                LEARNING_DATABASE[currentSubject][newLvl] = [];
                const levelSelect = document.getElementById('level-select');
                const opt = document.createElement('option'); opt.value = newLvl; opt.innerText = newLvl;
                levelSelect.appendChild(opt);
                levelSelect.value = newLvl; 
                changeTopic();
                document.getElementById('new-level-name').value=''; toggleAddLevelForm();
                playSFX('success');
            }
        }

        function saveCustomCard() {
            const q = document.getElementById('new-card-q').value, a = document.getElementById('new-card-a').value;
            if(q && a) {
                LEARNING_DATABASE[currentSubject][currentLevel].push({q:q, a:a});
                studyQueue.push({q:q, a:a}); totalCards++;
                document.getElementById('new-card-q').value=''; document.getElementById('new-card-a').value=''; toggleAddCardForm(); renderCard();
                playSFX('success');
            }
        }

        function deleteSubject() {
            const sub = document.getElementById('subject-select').value;
            if(!sub || sub === "Tr·ªëng") return;
            if(confirm(`X√≥a m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub];
                initLearningDropdowns();
                if(Object.keys(LEARNING_DATABASE).length === 0) {
                    studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                }
            }
        }

        function deleteLevel() {
            const sub = document.getElementById('subject-select').value;
            const lvl = document.getElementById('level-select').value;
            if(!sub || !lvl) return;
            if(confirm(`X√≥a c·∫•p ƒë·ªô "${lvl}" c·ªßa m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub][lvl];
                document.getElementById('subject-select').dispatchEvent(new Event('change'));
            }
        }

        function deleteCurrentCard(event) {
            event.stopPropagation();
            if (studyQueue.length === 0) return;
            if(!confirm("X√≥a th·∫ª n√†y?")) return;
            const currentCard = studyQueue[0];
            const dbList = LEARNING_DATABASE[currentSubject][currentLevel];
            const index = dbList.findIndex(c => c.q === currentCard.q && c.a === currentCard.a);
            if(index > -1) dbList.splice(index, 1);
            studyQueue.shift(); totalCards--; renderCard();
        }

        function renderCard() {
            const container = document.querySelector('.flashcard-container');
            container.classList.remove('flipped');
            setTimeout(() => {
                if (studyQueue.length === 0) {
                    const isEmpty = totalCards === 0;
                    document.getElementById('fc-cat-front').innerText = currentSubject || "Tr·ªëng";
                    document.getElementById('fc-q').innerText = isEmpty ? "Ch∆∞a c√≥ th·∫ª n√†o" : "ƒê√£ xong!";
                    document.getElementById('fc-cat-back').innerText = "";
                    document.getElementById('fc-a').innerText = isEmpty ? "B·∫•m + ƒë·ªÉ th√™m" : "Ch·ªçn m√¥n kh√°c";
                    return;
                }
                const current = studyQueue[0];
                document.getElementById('fc-cat-front').innerText = currentSubject;
                document.getElementById('fc-q').innerText = current.q;
                document.getElementById('fc-cat-back').innerText = currentLevel;
                document.getElementById('fc-a').innerText = current.a;
            }, 200);
            const percent = totalCards > 0 ? (masteredCount / totalCards) * 100 : 0;
            document.getElementById('fc-bar').style.width = `${percent}%`;
            document.getElementById('mini-fc').innerText = `${masteredCount}/${totalCards} Done`;
        }

        function flipCard(el) { if (studyQueue.length > 0) { el.classList.toggle('flipped'); playSFX('click'); } }
        function nextCard(isMastered) {
            if (studyQueue.length === 0) return;
            const card = studyQueue.shift();
            if (isMastered) masteredCount++; else studyQueue.push(card);
            renderCard();
        }

        function initExplore() {
            exploreGrid.innerHTML = '';
            for (const key in THEMES) {
                const item = document.createElement('div');
                item.className = 'explore-item'; 
                item.innerText = THEMES[key].emoji;
                item.onclick = (e) => { e.stopPropagation(); setTheme(key); playSFX('click'); }; item.id = `theme-${key}`;
                exploreGrid.appendChild(item);
            }
            buddyGrid.innerHTML = '';
            for (const key in BUDDIES) {
                const item = document.createElement('div');
                item.className = 'buddy-item'; item.style.backgroundImage = `url('${BUDDIES[key].thumb}')`;
                item.innerHTML = `<div class="buddy-name">${BUDDIES[key].name}</div>`;
                item.onclick = (e) => { e.stopPropagation(); setBodyDoubling(key); playSFX('click'); }; item.id = `buddy-${key}`;
                buddyGrid.appendChild(item);
            }
        }

        function setTheme(key) {
            const data = THEMES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            
            // 1. Fade Out
            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);

            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `
                        <video id="bg-video-player" autoplay muted loop playsinline>
                            <source src="${data.bg}" type="video/mp4">
                        </video>
                    `;
                    vidContainer.classList.add('active');
                    document.body.style.backgroundImage = 'none';
                }
                
                if (key === 'morning' || key === 'forest' || key === 'rain' || key === 'cafe' || key === 'sunset') {
                    document.documentElement.style.setProperty('--text-main', '#333');
                } else {
                    document.documentElement.style.setProperty('--text-main', '#fff');
                }
                
                document.body.style.backgroundColor = '#111'; 
                root.style.setProperty('--accent-color', data.color);
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = data.track;
                
                ambientPlayer.src = data.audio;
                if (!isMuted) { ambientPlayer.play().catch(e=>{}); }

                resetStates(); document.getElementById(`theme-${key}`).classList.add('active'); 
                document.getElementById(`theme-${key}`).style.backgroundColor = data.color;

            }, 800);
        }

        function setBodyDoubling(key) {
            const data = BUDDIES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            
            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);

            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `
                        <video id="bg-video-player" autoplay muted loop playsinline>
                            <source src="${data.url}" type="video/mp4">
                        </video>
                    `;
                    vidContainer.classList.add('active');
                    document.body.style.backgroundImage = 'none';
                }
                
                resetStates(); document.getElementById(`buddy-${key}`).classList.add('active');
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = `H·ªçc c√πng ${data.name}`;
            }, 800);
        }

        function resetStates() {
            document.querySelectorAll('.explore-item').forEach(el => { el.classList.remove('active'); el.style.backgroundColor = ''; el.style.boxShadow = ''; });
            document.querySelectorAll('.buddy-item').forEach(el => el.classList.remove('active'));
        }
        function selectMood(m) { setTheme(m); document.getElementById('intro-overlay').classList.add('hidden-intro'); }
        function togglePanel(id) { document.getElementById(id).classList.toggle('collapsed'); }
        
        let zenInt, totalMin = 0;
        function openZenMode() { document.getElementById('zen-overlay').classList.add('active'); document.getElementById('zen-circle').classList.add('breathing-anim'); document.getElementById('zen-quote').innerText = `"${ZEN_QUOTES[Math.floor(Math.random()*ZEN_QUOTES.length)]}"`; updateBreath(); zenInt=setInterval(updateBreath,8000); }
        function updateBreath() { const t=document.getElementById('zen-text'); t.innerText="H√≠t s√¢u..."; setTimeout(()=>t.innerText="Gi·ªØ...",3500); setTimeout(()=>t.innerText="Th·ªü ra...",4500); }
        function closeZenMode() { document.getElementById('zen-overlay').classList.remove('active'); document.getElementById('zen-circle').classList.remove('breathing-anim'); clearInterval(zenInt); }

        const MODES = { pomodoro: 25, short: 5, long: 15 };
        let timeLeft = 25*60, timerInt, isRunning=false;
        function updateDisplay() { 
            const m=Math.floor(timeLeft/60).toString().padStart(2,'0'), s=(timeLeft%60).toString().padStart(2,'0'); 
            document.getElementById('timer-text').innerText=`${m}:${s}`; document.getElementById('mini-timer').innerText=`${m}:${s}`; document.title=isRunning?`(${m}:${s}) ƒêang t·∫≠p trung...`:"Kh√¥ng gian Chill";
        }
        function toggleTimer() {
            if(isRunning) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; }
            else { isRunning=true; document.getElementById('btn-action').textContent="T·∫°m d·ª´ng"; timerInt=setInterval(()=>{ if(timeLeft>0){ timeLeft--; updateDisplay(); if(timeLeft%60===0) totalMin++; if(totalMin>60){ if(confirm("B·∫°n ƒë√£ h·ªçc l√¢u r·ªìi, ngh·ªâ ng∆°i ch√∫t nh√©?")){openZenMode(); toggleTimer(); totalMin=0;} else totalMin=0; } } else { clearInterval(timerInt); isRunning=false; alert("H·∫øt gi·ªù r·ªìi!"); playSFX('alarm'); } },1000); }
        }
        function switchMode(m) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=MODES[m]*60; document.getElementById('custom-minutes').value=MODES[m]; updateDisplay(); document.querySelectorAll('.timer-controls span').forEach(el=>el.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); }
        function adjustTime(a) { let v=parseInt(document.getElementById('custom-minutes').value)||0; v+=a; if(v<1)v=1; document.getElementById('custom-minutes').value=v; }
        function applyCustomTime() { const v=parseInt(document.getElementById('custom-minutes').value); if(v>0){ clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=v*60; updateDisplay(); } }

        const taskInput = document.getElementById('new-task-input'), taskList = document.getElementById('task-list');
        function showInput() { document.getElementById('btn-show-add').style.display='none'; document.getElementById('input-group').style.display='flex'; taskInput.focus(); }
        function addTask() { if(!taskInput.value.trim()) return; const li=document.createElement('li'); li.className='task-item'; li.innerHTML=`<input type="checkbox" class="task-checkbox" onclick="toggleTask(this)"> <span class="task-text">${taskInput.value}</span> <i class="fa-solid fa-trash-can delete-btn" onclick="this.parentElement.remove(); updateCount()" style="color:#ffb8b8; cursor:pointer;"></i>`; taskList.appendChild(li); taskInput.value=''; document.getElementById('input-group').style.display='none'; document.getElementById('btn-show-add').style.display='flex'; updateCount(); }
        function toggleTask(cb) { cb.parentElement.classList.toggle('completed', cb.checked); if(cb.checked) playSFX('success'); else playSFX('click'); }
        taskInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addTask()});
        function updateCount() { document.getElementById('task-count').innerText=`(${taskList.children.length})`; }

        initApp();
    </script>
</body>
</html>