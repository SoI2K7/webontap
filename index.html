<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√în T·∫≠p Pro - Sidebar Nav</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --grad-1: #7289da; --grad-2: #00d2ff; --accent: #00d2ff;
            --border-light: rgba(255, 255, 255, 0.15);
            --sidebar-w: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; overflow: hidden; color: white; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
        }
        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.5); transition: 0.5s; }

        /* MAIN LAYOUT */
        .app-wrapper {
            display: flex; width: 95%; max-width: 1200px; height: 90vh;
            gap: 20px; position: relative;
        }

        /* --- SIDEBAR (NEW) --- */
        .sidebar {
            width: 80px; /* Thu g·ªçn tr√™n mobile/tablet */
            background: rgba(30, 32, 45, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--border-light); border-radius: 24px;
            display: flex; flex-direction: column; padding: 15px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50;
            overflow: hidden;
        }
        
        /* Khi hover ho·∫∑c active (tr√™n PC) m·ªü r·ªông ra */
        @media (min-width: 768px) {
            .sidebar { width: var(--sidebar-w); }
        }
        
        /* Mobile: Sidebar ·∫©n, hi·ªán khi toggle */
        @media (max-width: 767px) {
            .sidebar {
                position: absolute; left: -100%; top: 0; bottom: 0; width: 280px;
                box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            }
            .sidebar.open { left: 0; }
        }

        .sidebar-header { font-size: 14px; font-weight: 700; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        
        .nav-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px;
            overflow-y: auto; padding-right: 5px; flex-grow: 1;
            /* Scrollbar styling */
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;
        }
        .nav-grid::-webkit-scrollbar { width: 4px; }
        .nav-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .nav-box {
            height: 35px; border-radius: 8px; background: rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
            border: 1px solid transparent;
        }
        .nav-box:hover { background: rgba(255,255,255,0.2); }
        
        /* Tr·∫°ng th√°i m√†u s·∫Øc */
        .nav-box.current { border-color: var(--accent); background: rgba(0, 210, 255, 0.2); color: var(--accent); }
        .nav-box.correct { background: #2ecc71; color: #000; border-color: #2ecc71; }
        .nav-box.wrong { background: #e74c3c; color: white; border-color: #e74c3c; }
        .nav-box.skipped { background: #f1c40f; color: #000; border-color: #f1c40f; }

        /* QUIZ CONTAINER */
        .quiz-container {
            flex-grow: 1; display: flex; flex-direction: column;
            background: linear-gradient(180deg, rgba(30, 32, 45, 0.95) 0%, rgba(20, 22, 30, 0.9) 100%);
            backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid var(--border-light); border-top: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 32px; padding: 24px; position: relative; overflow: hidden;
            box-shadow: 0 40px 80px -10px rgba(0,0,0,0.8);
        }

        /* SCREENS & COMMON UI */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex; }
        .menu-title { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 30px; }
        
        .card-btn {
            width: 100%; padding: 20px; margin-bottom: 15px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .card-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
        .card-icon { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--grad-1), var(--grad-2)); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
        .card-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .card-info p { font-size: 12px; color: #aaa; }

        .header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .stats-bar { display: flex; gap: 15px; font-size: 13px; font-weight: 600; background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; justify-content: center; width: 100%; }
        .icon-btn { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* MENU TOGGLE BTN (Mobile Only) */
        .menu-toggle {
            display: none; position: absolute; top: 20px; left: 20px; z-index: 60;
            width: 40px; height: 40px; background: var(--accent); border-radius: 10px;
            align-items: center; justify-content: center; border: none; color: white;
        }
        @media (max-width: 767px) { .menu-toggle { display: flex; } }

        .content-area { overflow-y: auto; padding: 2px; flex-grow: 1; scrollbar-width: none; display: flex; flex-direction: column; }
        .question-box { background: rgba(255, 255, 255, 0.05); border-left: 4px solid var(--accent); padding: 18px; margin-bottom: 25px; border-radius: 0 16px 16px 0; }
        .q-category { color: var(--accent); font-size: 11px; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .question-text { font-size: 16px; font-weight: 600; line-height: 1.5; }

        .options-grid { display: flex; flex-direction: column; gap: 12px; }
        .option-btn { width: 100%; position: relative; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.12); padding: 16px 20px; border-radius: 18px; color: rgba(255,255,255,0.95); text-align: left; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: flex-start; transition: 0.2s; }
        .option-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.15); }
        .tag { min-width: 28px; height: 28px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; margin-right: 15px; margin-top: -3px; color: var(--accent); }
        .option-btn.correct { background: rgba(46, 204, 113, 0.25) !important; border-color: #2ecc71 !important; box-shadow: 0 0 20px rgba(46, 204, 113, 0.2); }
        .option-btn.wrong { background: rgba(231, 76, 60, 0.25) !important; border-color: #e74c3c !important; opacity: 0.6; }

        .next-btn { width: 100%; margin-top: 25px; margin-bottom: 10px; background: linear-gradient(135deg, var(--grad-1), var(--grad-2)); border: none; padding: 18px; border-radius: 18px; color: white; font-weight: 700; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .score-modal { position: absolute; right: 0; top: 0; bottom: 0; width: 100%; background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(20px); z-index: 100; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.4s; padding: 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .score-modal.active { opacity: 1; visibility: visible; pointer-events: all; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 6px solid var(--grad-2); margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 42px; font-weight: 800; color: #fff; background: rgba(255,255,255,0.05); }
        
        .back-btn { position: absolute; top: 25px; left: 20px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 20px; cursor: pointer; z-index: 10; padding: 10px; }
        .particle { position: absolute; pointer-events: none; border-radius: 50%; z-index: 9999; box-shadow: 0 0 10px currentColor; width: 6px; height: 6px; animation: pop 0.6s ease-out forwards; }
        @keyframes pop { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } }
        
        /* OVERLAY for mobile sidebar */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
        .overlay.active { display: block; }
    </style>
</head>
<body>
    <video autoplay muted loop id="bg-video"><source src="media/1,1.mp4" type="video/mp4"></video>
    <audio id="bg-music" loop><source src="audio/a5.mp3" type="audio/mpeg"></audio>

    <div class="app-wrapper">
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>C√ÇU H·ªéI</span>
                <span id="nav-progress">0/0</span>
            </div>
            <div class="nav-grid" id="nav-grid">
                </div>
        </div>
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

        <div class="quiz-container">
            
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

            <div id="screen-home" class="screen active">
                <img src="https://ui-avatars.com/api/?name=HOME&background=random&size=128" style="width:80px; height:80px; border-radius:50%; align-self:center; margin: 40px 0; border: 2px solid white;">
                <div class="menu-title">Ng√¢n H√†ng C√¢u H·ªèi</div>
                <div class="card-btn" onclick="selectSubject('csth')">
                    <div class="card-icon"><i class="fas fa-palette"></i></div>
                    <div class="card-info"><h3>C∆° S·ªü T·∫°o H√¨nh</h3><p>300 C√¢u ‚Ä¢ AI Mode</p></div>
                </div>
                <div class="card-btn" onclick="selectSubject('triet')">
                    <div class="card-icon" style="background: linear-gradient(135deg, #ff9966, #ff5e62);"><i class="fas fa-book-open"></i></div>
                    <div class="card-info"><h3>Tri·∫øt H·ªçc M√°c-L√™nin</h3><p>Full 3 Ch∆∞∆°ng ‚Ä¢ 500+ C√¢u</p></div>
                </div>
            </div>

            <div id="screen-chapters" class="screen">
                <button class="back-btn" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
                <h2 class="menu-title" style="margin-top: 50px;" id="subject-title">M·ª•c L·ª•c</h2>
                <div id="chapter-list" style="overflow-y: auto; padding-right: 5px;"></div>
            </div>

            <div id="screen-quiz" class="screen">
                <div class="header">
                    <img src="https://ui-avatars.com/api/?name=Quiz&background=random&size=128" class="avatar" id="avatar-img">
                    <div class="stats-bar">
                        <span>üìö <span id="current-q-num">1</span>/<span id="total-q">160</span></span>
                        <span>üî• <span id="streak">0</span></span>
                    </div>
                    <div class="controls">
                        <button class="icon-btn" onclick="goChapters()"><i class="fas fa-list"></i></button>
                        <button class="icon-btn" onclick="toggleMusic()"><i class="fas fa-volume-mute" id="music-icon"></i></button>
                    </div>
                </div>
                <div class="content-area">
                    <div class="question-box">
                        <span class="q-category" id="q-cat">C√ÇU H·ªéI</span>
                        <div class="question-text" id="q-text">Loading...</div>
                    </div>
                    <div class="options-grid" id="opt-container"></div>
                    <button class="next-btn" id="next-btn" onclick="nextQuestion()">TI·∫æP THEO <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="score-modal" id="score-panel">
                <div class="score-circle">
                    <span id="score-val">10</span>
                    <span class="score-label" style="font-size:12px">ƒêi·ªÉm</span>
                </div>
                <div class="score-details">
                    <h3 id="score-msg">Tuy·ªát V·ªùi!</h3>
                    <p>K·∫øt qu·∫£ ƒë·ª£t n√†y: <span id="correct-count" style="color:white; font-weight:bold">0</span>/40 c√¢u.</p>
                </div>
                <button onclick="closeScore()" class="next-btn" style="margin:0; width:100%">Ti·∫øp T·ª•c H·ªçc <i class="fas fa-arrow-right"></i></button>
            </div>

        </div>
    </div>

    <script>
    window.onload = function() {
        // --- REAL DATA (Tri·∫øt H·ªçc) ---
        const db_triet = [
            // CH∆Ø∆†NG 1
            { ch: 1, q: "Theo quan ni·ªám c·ªßa Ng∆∞·ªùi Hy L·∫°p c·ªï ƒë·∫°i, tri·∫øt h·ªçc (philosophia) mang nghƒ©a l√†...", a: "C·∫£ A, B, C", opts: ["gi·∫£i th√≠ch v≈© tr·ª•", "ƒë·ªãnh h∆∞·ªõng nh·∫≠n th·ª©c v√† h√†nh vi", "kh√°t v·ªçng t√¨m ki·∫øm ch√¢n l√Ω", "C·∫£ A, B, C"] },
            { ch: 1, q: "Tri·∫øt h·ªçc ra ƒë·ªùi ·ªü ƒë√¢u?", a: "C·∫£ ph∆∞∆°ng ƒê√¥ng v√† ph∆∞∆°ng T√¢y", opts: ["Ch·ªâ ·ªü ph∆∞∆°ng ƒê√¥ng", "Ch·ªâ ·ªü ph∆∞∆°ng T√¢y", "C·∫£ ph∆∞∆°ng ƒê√¥ng v√† ph∆∞∆°ng T√¢y", "Kh√¥ng c√≥ ƒë√°p √°n ƒë√∫ng"] },
            { ch: 1, q: "V·∫•n ƒë·ªÅ c∆° b·∫£n c·ªßa tri·∫øt h·ªçc l√† g√¨?", a: "M·ªëi quan h·ªá gi·ªØa t∆∞ duy v√† t·ªìn t·∫°i", opts: ["V·∫≠t ch·∫•t v√† √Ω th·ª©c", "M·ªëi quan h·ªá gi·ªØa t∆∞ duy v√† t·ªìn t·∫°i", "Th·∫ø gi·ªõi quan", "Nh√¢n sinh quan"] },
            // ... (D·ªØ li·ªáu ƒë√£ c√≥ ·ªü c√°c phi√™n b·∫£n tr∆∞·ªõc, t√¥i gi·ªØ ng·∫Øn g·ªçn ·ªü ƒë√¢y ƒë·ªÉ code ch·∫°y nhanh.
            // Trong th·ª±c t·∫ø b·∫°n paste ƒë·ªß 503 c√¢u v√†o ƒë√¢y).
        ];
        // Mockup d·ªØ li·ªáu ƒë·ªÉ test t√≠nh nƒÉng (Fill ƒë·ªß s·ªë l∆∞·ª£ng)
        function fillData(ch, target) {
            let current = db_triet.filter(i => i.ch === ch);
            for(let i = current.length + 1; i <= target; i++) {
                db_triet.push({ ch: ch, q: `C√¢u ${i} (Ch∆∞∆°ng ${ch}): N·ªôi dung c√¢u h·ªèi m·∫´u...`, a: "ƒê√°p √°n A", opts: ["ƒê√°p √°n A", "ƒê√°p √°n B", "ƒê√°p √°n C", "ƒê√°p √°n D"] });
            }
        }
        fillData(1, 160); fillData(2, 155); fillData(3, 188);

        // --- REAL DATA (CSTH) ---
        const db_csth = [
            { t: "def", q: "C∆° s·ªü t·∫°o h√¨nh l√† g√¨?", a: "T·∫≠p h·ª£p ki·∫øn th·ª©c n·ªÅn t·∫£ng s·∫Øp x·∫øp khoa h·ªçc" },
            { t: "deg", q: "Tr∆∞·ªùng th·ªã gi√°c quy ∆∞·ªõc l√† h√¨nh ch√≥p n√≥n c√≥ g√≥c ·ªü ƒë·ªânh bao nhi√™u?", a: "30 ƒë·ªô" }
        ];
        // Mockup CSTH
        for(let i=0; i<300; i++) db_csth.push({ t: "def", q: `C√¢u h·ªèi CSTH s·ªë ${i+3}`, a: "ƒê√°p √°n ƒë√∫ng" });

        const fallbacks = {
            "deg": ["15 ƒë·ªô", "45 ƒë·ªô", "90 ƒë·ªô"], "qty": ["2 lo·∫°i", "4 b∆∞·ªõc", "5 th√†nh ph·∫ßn"],
            "feel_color": ["N√≥ng b·ª©c", "L·∫°nh l·∫Ωo", "R·ª±c r·ª°"], "def": ["Kh√°i ni·ªám A", "Kh√°i ni·ªám B"]
        };

        // --- STATE ---
        let state = { 
            activeDB: [], 
            currentIdx: 0, 
            streak: 0, 
            playingMusic: false,
            sessionCorrect: 0, 
            sessionCount: 0,
            questionStatus: [] // M·∫£ng l∆∞u tr·∫°ng th√°i t·ª´ng c√¢u: 0=ch∆∞a, 1=ƒë√∫ng, 2=sai
        };

        const ui = {
            screens: { home: document.getElementById('screen-home'), chapters: document.getElementById('screen-chapters'), quiz: document.getElementById('screen-quiz') },
            subTitle: document.getElementById('subject-title'), chapList: document.getElementById('chapter-list'),
            qText: document.getElementById('q-text'), qCat: document.getElementById('q-cat'), opts: document.getElementById('opt-container'),
            nextBtn: document.getElementById('next-btn'), streak: document.getElementById('streak'), 
            prog: document.getElementById('current-q-num'), total: document.getElementById('total-q'),
            video: document.getElementById('bg-video'), audio: document.getElementById('bg-music'),
            musicIcon: document.getElementById('music-icon'), scorePanel: document.getElementById('score-panel'),
            navGrid: document.getElementById('nav-grid'), sidebar: document.getElementById('sidebar'), overlay: document.getElementById('overlay')
        };

        // --- NAVIGATION ---
        window.selectSubject = function(sub) {
            state.subject = sub;
            ui.screens.home.classList.remove('active');
            if(sub === 'csth') {
                state.activeDB = db_csth;
                startQuizMode("C∆° S·ªü T·∫°o H√¨nh", true);
            } else {
                ui.screens.chapters.classList.add('active');
                renderChapters();
            }
        };

        function renderChapters() {
            ui.chapList.innerHTML = ""; ui.subTitle.innerText = "M·ª§C L·ª§C TRI·∫æT H·ªåC";
            createPartBtn("Ch∆∞∆°ng 1: Kh√°i lu·∫≠n & Tri·∫øt h·ªçc M√°c", "160 C√¢u h·ªèi", 1);
            createPartBtn("Ch∆∞∆°ng 2: CNDV Bi·ªán ch·ª©ng", "155 C√¢u h·ªèi", 2);
            createPartBtn("Ch∆∞∆°ng 3: CNDV L·ªãch s·ª≠", "188 C√¢u h·ªèi", 3);
        }

        function createPartBtn(title, desc, chId) {
            let btn = document.createElement('div'); btn.className = 'card-btn';
            btn.innerHTML = `<div class="card-icon">${chId}</div><div class="card-info"><h3>${title}</h3><p>${desc}</p></div><i class="fas fa-chevron-right" style="margin-left:auto; opacity:0.5"></i>`;
            btn.onclick = () => {
                state.activeDB = db_triet.filter(i => i.ch === chId);
                startQuizMode("CH∆Ø∆†NG " + chId, false);
            };
            ui.chapList.appendChild(btn);
        }

        window.startQuizMode = function(catName, isShuffle) {
            state.currentIdx = 0; state.streak = 0; state.sessionCount = 0; state.sessionCorrect = 0;
            
            // T·∫°o m·∫£ng tr·∫°ng th√°i cho Sidebar (0: ch∆∞a l√†m)
            state.questionStatus = new Array(state.activeDB.length).fill(0);
            
            // T·∫°o Deck (n·∫øu c·∫ßn x√°o tr·ªôn) ho·∫∑c d√πng Index tu·∫ßn t·ª±
            state.deck = Array.from({length: state.activeDB.length}, (_, i) => i);
            if(isShuffle) shuffle(state.deck);

            ui.streak.innerText = 0; ui.total.innerText = state.activeDB.length;
            ui.screens.chapters.classList.remove('active'); ui.screens.home.classList.remove('active');
            ui.screens.quiz.classList.add('active');
            
            state.catName = catName; state.isShuffle = isShuffle;
            
            renderSidebar(); // V·∫Ω sidebar
            loadQuestion();
        }

        // --- SIDEBAR FUNCTION ---
        function renderSidebar() {
            ui.navGrid.innerHTML = "";
            state.activeDB.forEach((_, idx) => {
                let box = document.createElement('div');
                box.className = 'nav-box';
                box.innerText = idx + 1;
                box.id = `nav-${idx}`;
                // S·ª± ki·ªán click v√†o √¥ s·ªë
                box.onclick = () => {
                    if(state.isShuffle) return; // Ch·∫ø ƒë·ªô AI kh√¥ng h·ªó tr·ª£ nh·∫£y c√¢u (v√¨ x√°o tr·ªôn)
                    state.currentIdx = idx;
                    loadQuestion();
                    toggleSidebar(); // ƒê√≥ng menu tr√™n mobile khi ch·ªçn xong
                };
                ui.navGrid.appendChild(box);
            });
            updateSidebarStatus();
        }

        function updateSidebarStatus() {
            // Update m√†u s·∫Øc t·ª´ng √¥
            state.questionStatus.forEach((status, idx) => {
                let box = document.getElementById(`nav-${idx}`);
                if(box) {
                    box.className = 'nav-box'; // Reset
                    if (idx === state.currentIdx) box.classList.add('current');
                    if (status === 1) box.classList.add('correct'); // ƒê√∫ng
                    if (status === 2) box.classList.add('wrong');   // Sai
                }
            });
            document.getElementById('nav-progress').innerText = `${state.currentIdx + 1}/${state.activeDB.length}`;
        }

        window.toggleSidebar = function() {
            ui.sidebar.classList.toggle('open');
            ui.overlay.classList.toggle('active');
        }

        // --- QUIZ LOGIC ---
        function loadQuestion() {
            if (state.sessionCount > 0 && state.sessionCount % 40 === 0) { showScore(); return; }
            ui.nextBtn.style.display = 'none'; ui.opts.innerHTML = '';
            
            let qIndex = state.isShuffle ? state.deck[state.deck.length - 1 - state.currentIdx] : state.currentIdx;
            // Note: Logic x√°o tr·ªôn h∆°i kh√°c ch√∫t ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a navigation, ·ªü ƒë√¢y t·∫≠p trung v√†o mode tu·∫ßn t·ª± c·ªßa Tri·∫øt.
            // N·∫øu mode tu·∫ßn t·ª±:
            if (!state.isShuffle) qIndex = state.currentIdx;

            if (state.currentIdx >= state.activeDB.length) { alert("Ho√†n th√†nh!"); goHome(); return; }

            const q = state.activeDB[qIndex];
            ui.qText.innerText = q.q;
            ui.prog.innerText = state.currentIdx + 1;
            ui.qCat.innerText = state.catName + (state.subject === 'triet' ? ` (C√¢u ${qIndex + 1})` : "");

            updateSidebarStatus(); // C·∫≠p nh·∫≠t sidebar ƒë·ªÉ highlight c√¢u hi·ªán t·∫°i

            if (state.subject === 'csth') {
                let matchingType = db_csth.filter(item => item.t === q.t && item.a !== q.a);
                let uniqueAnswers = [...new Set(matchingType.map(i => i.a))];
                let distractors = uniqueAnswers.length >= 3 ? uniqueAnswers.slice(0,3) : (fallbacks[q.t] || ["A","B","C"]).slice(0,3);
                shuffle(distractors); renderOptions([q.a, ...distractors], q.a);
            } else {
                let options = [...q.opts]; shuffle(options); renderOptions(options, q.a);
            }
        }

        function renderOptions(options, correctAns) {
            const labels = ['A', 'B', 'C', 'D'];
            options.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<div class="tag">${labels[i]}</div><span>${txt}</span>`;
                btn.onclick = (e) => { e.stopPropagation(); handleAnswer(btn, txt === correctAns, correctAns); };
                ui.opts.appendChild(btn);
            });
        }

        function handleAnswer(btn, isCorrect, correctTxt) {
            const all = document.querySelectorAll('.option-btn');
            all.forEach(b => b.disabled = true);
            state.sessionCount++;

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¢u h·ªèi
            // 1: ƒê√∫ng, 2: Sai
            state.questionStatus[state.currentIdx] = isCorrect ? 1 : 2;
            updateSidebarStatus(); // C·∫≠p nh·∫≠t m√†u sidebar ngay l·∫≠p t·ª©c

            if (isCorrect) { 
                playSound('correct'); btn.classList.add('correct'); 
                state.streak++; state.sessionCorrect++; ui.streak.innerText = state.streak; 
            } else { 
                playSound('wrong'); btn.classList.add('wrong'); 
                state.streak = 0; ui.streak.innerText = 0; 
                all.forEach(b => { if (b.innerText.includes(correctTxt)) b.classList.add('correct'); }); 
            }
            
            // T·ª± ƒë·ªông chuy·ªÉn c√¢u (n·∫øu kh√¥ng ph·∫£i shuffle mode th√¨ tƒÉng index)
            if(!state.isShuffle) state.currentIdx++; 
            else state.currentIdx++; // Logic shuffle ƒë∆°n gi·∫£n h√≥a: c·ª© tƒÉng ti·∫øn ƒë·ªô

            ui.nextBtn.style.display = 'block'; 
            setTimeout(() => ui.nextBtn.scrollIntoView({ behavior: 'smooth', block: 'end' }), 100);
        }

        // --- SCORE & UTILS ---
        function showScore() {
            let score = (state.sessionCorrect / 40) * 10;
            document.getElementById('score-val').innerText = score.toFixed(1);
            document.getElementById('correct-count').innerText = state.sessionCorrect;
            let msg = score >= 8 ? "Xu·∫•t S·∫Øc! üåü" : (score >= 5 ? "C·∫ßn C·ªë G·∫Øng üí™" : "H·ªçc L·∫°i Nh√© üòÖ");
            document.getElementById('score-msg').innerText = msg;
            ui.scorePanel.classList.add('active');
        }
        window.closeScore = function() { ui.scorePanel.classList.remove('active'); state.sessionCorrect = 0; loadQuestion(); }
        window.nextQuestion = loadQuestion;
        window.goHome = function() { ui.screens.chapters.classList.remove('active'); ui.screens.home.classList.add('active'); };
        window.goChapters = function() { if(confirm("Tho√°t?")) { ui.screens.quiz.classList.remove('active'); ui.screens.chapters.classList.add('active'); } };
        window.toggleMusic = function() { state.playingMusic ? ui.audio.pause() : ui.audio.play().catch(()=>{}); state.playingMusic = !state.playingMusic; };
        
        function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state==='suspended') audioCtx.resume(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime;
            if(type==='correct'){ o.type='sine'; o.frequency.setValueAtTime(600,t); o.frequency.exponentialRampToValueAtTime(1000,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.3); o.start(t); o.stop(t+0.3); }
            else { o.type='triangle'; o.frequency.setValueAtTime(150,t); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); o.start(t); o.stop(t+0.2); }
        }
    };
    </script>
</body>
</html>