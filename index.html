<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√în T·∫≠p CSTH - Final Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --grad-1: #7289da;
            --grad-2: #00d2ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; color: white; background: #000;
        }

        #bg-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; filter: brightness(0.6);
        }

        /* --- CONTAINER K√çNH L·ªéNG (LIQUID GLASS) --- */
        .quiz-container {
            width: 90%; max-width: 460px;
            /* Hi·ªáu ·ª©ng k√≠nh iOS */
            background: rgba(30, 30, 40, 0.4);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 32px;
            padding: 30px 25px;
            
            box-shadow: 0 30px 50px -10px rgba(0, 0, 0, 0.6);
            position: relative; 
            max-height: 90vh; 
            display: flex; flex-direction: column;
            animation: popIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Header */
        .header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        
        .avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.2); 
            object-fit: cover; margin-bottom: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .stats-bar {
            display: flex; gap: 10px; font-size: 13px; font-weight: 600;
            background: rgba(0,0,0,0.3); padding: 6px 16px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px;
        }

        .controls { display: flex; gap: 10px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 10px;
            background: rgba(255,255,255,0.1); border: none;
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        select {
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 0 10px; border-radius: 10px; height: 36px; outline: none; font-size: 12px;
        }

        /* Question Scroll Area */
        .content-area {
            overflow-y: auto; 
            padding-right: 5px; /* Space for scrollbar */
            flex-grow: 1;
            /* Scrollbar styling */
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent;
        }
        .content-area::-webkit-scrollbar { width: 4px; }
        .content-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .question-text {
            font-size: 18px; font-weight: 700; line-height: 1.5; margin-bottom: 25px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* Option Buttons - ƒê√£ chuy·ªÉn sang th·∫ª BUTTON ƒë·ªÉ fix l·ªói click */
        .options-grid { display: flex; flex-direction: column; gap: 12px; }
        
        .option-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 18px 20px; border-radius: 18px;
            color: rgba(255,255,255,0.9); text-align: left;
            font-size: 15px; font-weight: 500;
            cursor: pointer; position: relative;
            display: flex; align-items: flex-start;
            transition: all 0.2s ease;
            -webkit-user-select: none;
        }

        .option-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        
        .tag {
            min-width: 24px; height: 24px; background: rgba(255,255,255,0.1);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; margin-right: 15px; margin-top: 1px;
            color: var(--grad-2);
        }

        /* States Correct/Wrong */
        .option-btn.correct {
            background: rgba(46, 204, 113, 0.2) !important;
            border-color: #2ecc71 !important;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.25);
        }
        .option-btn.wrong {
            background: rgba(231, 76, 60, 0.2) !important;
            border-color: #e74c3c !important;
            opacity: 0.7;
        }

        /* Next Button */
        .next-btn {
            width: 100%; margin-top: 25px;
            background: linear-gradient(90deg, var(--grad-1), var(--grad-2));
            border: none; padding: 16px; border-radius: 16px;
            color: white; font-weight: 700; font-size: 16px; letter-spacing: 1px;
            cursor: pointer; display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Particles */
        .particle {
            position: absolute; pointer-events: none; border-radius: 50%; z-index: 100;
            box-shadow: 0 0 6px currentColor;
            animation: pop 0.6s ease-out forwards;
        }
        @keyframes pop { to { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }

    </style>
</head>
<body>

    <video autoplay muted loop id="bg-video"><source src="media/1,1.mp4" type="video/mp4"></video>
    <audio id="bg-music" loop><source src="audio/a5.mp3" type="audio/mpeg"></audio>

    <div class="quiz-container">
        <div class="header">
            <img src="https://ui-avatars.com/api/?name=CSTH&background=random&size=128" class="avatar" id="avatar-img">
            <div class="stats-bar">
                <span>üî• Streak: <span id="streak">0</span></span>
                <span style="opacity:0.5">|</span>
                <span>C√¢u: <span id="progress">1</span>/150</span>
            </div>
            <div class="controls">
                <button class="icon-btn" onclick="toggleMusic()"><i class="fas fa-volume-mute" id="music-icon"></i></button>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="0">Fantasy</option>
                    <option value="1">Cosmic</option>
                    <option value="2">Rain</option>
                    <option value="3">Cyber</option>
                    <option value="4">Urban</option>
                    <option value="5">Lofi</option>
                </select>
            </div>
        </div>

        <div class="content-area">
            <div class="question-text" id="q-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div class="options-grid" id="opt-container">
                </div>
            <button class="next-btn" id="next-btn" onclick="nextQuestion()">TI·∫æP THEO <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <script>
        // --- 1. D·ªÆ LI·ªÜU C√ÇU H·ªéI T·ª™ PDF (PH√ÇN NH√ìM CH·∫∂T CH·∫º) ---
        // G: Group (ƒë·ªÉ AI l·∫•y ƒë√°p √°n nhi·ªÖu c√πng lo·∫°i)
        // Q: C√¢u h·ªèi
        // A: ƒê√°p √°n ƒë√∫ng
        const db = [
            // --- G: ANGLE (G√≥c ƒë·ªô & H√¨nh h·ªçc) ---
            { g: "angle", q: "Tr∆∞·ªùng th·ªã gi√°c quy ∆∞·ªõc l√† h√¨nh ch√≥p n√≥n c√≥ g√≥c ·ªü ƒë·ªânh l√† bao nhi√™u?", a: "30 ƒë·ªô" },
            { g: "angle", q: "T·ªïng gi·ªõi h·∫°n tr√°i ‚Äì ph·∫£i c·ªßa tr∆∞·ªùng th·ªã gi√°c con ng∆∞·ªùi l√† bao nhi√™u?", a: "130 ƒë·ªô" },
            { g: "angle", q: "T·ªïng gi·ªõi h·∫°n tr√™n ‚Äì d∆∞·ªõi c·ªßa tr∆∞·ªùng th·ªã gi√°c con ng∆∞·ªùi l√† bao nhi√™u?", a: "75 ƒë·ªô" },
            { g: "angle", q: "T·ª∑ l·ªá v√†ng (Golden Ratio) x·∫•p x·ªâ bao nhi√™u?", a: "1.618" },
            { g: "angle", q: "G√≥c nh√¨n t·ªët nh·∫•t trong tr∆∞·ªùng th·ªã gi√°c ngang l√† bao nhi√™u?", a: "60 ƒë·ªô" },

            // --- G: DEF (ƒê·ªãnh nghƒ©a kh√°i ni·ªám) ---
            { g: "def", q: "C∆° s·ªü t·∫°o h√¨nh l√† g√¨?", a: "T·∫≠p h·ª£p ki·∫øn th·ª©c n·ªÅn t·∫£ng ƒë∆∞·ª£c s·∫Øp x·∫øp khoa h·ªçc ƒë·∫°t hi·ªáu qu·∫£ th·ªã gi√°c cao." },
            { g: "def", q: "L·ª±c th·ªã gi√°c l√† g√¨?", a: "S·ª± ch√∫ √Ω, t·∫≠p trung c·ªßa m·∫Øt t·ªõi m·ªôt ƒë·ªëi t∆∞·ª£ng." },
            { g: "def", q: "Tr∆∞·ªùng l·ª±c l√† g√¨?", a: "S·ª± h·∫•p d·∫´n to·∫£ ra xung quanh t√≠n hi·ªáu h√¨nh ·∫£nh." },
            { g: "def", q: "Th·ªã gi√°c l√† g√¨?", a: "Kh·∫£ nƒÉng ti·∫øp nh·∫≠n v√† di·ªÖn gi·∫£i th√¥ng tin t·ª´ √°nh s√°ng." },
            { g: "def", q: "Nh·∫≠n th·ª©c th·ªã gi√°c l√† g√¨?", a: "Kh·∫£ nƒÉng hi·ªÉu n·ªôi dung th√¥ng tin t·ª´ h√¨nh ·∫£nh." },
            { g: "def", q: "Tr·ªçng l∆∞·ª£ng th·ªã gi√°c l√† g√¨?", a: "Kh√≠a c·∫°nh n·∫∑ng - nh·∫π c·ªßa h√¨nh ·∫£nh." },
            { g: "def", q: "C∆∞·ªùng ƒë·ªô th·ªã gi√°c l√† g√¨?", a: "M·ª©c ƒë·ªô l·ªõn nh·ªè c·ªßa tr∆∞·ªùng l·ª±c." },
            { g: "def", q: "C√¢n b·∫±ng th·ªã gi√°c l√† g√¨?", a: "S·ª± s·∫Øp x·∫øp t·∫°o ƒë·ªô nh·∫•n ho·∫∑c s·ª©c cƒÉng h·ª£p l√Ω." },
            { g: "def", q: "T∆∞∆°ng ph·∫£n l√† g√¨?", a: "S·ª± kh√°c bi·ªát, tr√°i ng∆∞·ª£c nhau gi·ªØa c√°c t√≠n hi·ªáu th·ªã gi√°c." },
            { g: "def", q: "Vi bi·∫øn l√† g√¨?", a: "S·ª± t∆∞∆°ng ph·∫£n nh·∫π, chuy·ªÉn bi·∫øn d·∫ßn, kh√°c bi·ªát r·∫•t √≠t." },
            { g: "def", q: "Nh·ªãp ƒëi·ªáu l√† g√¨?", a: "S·ª± l·∫∑p l·∫°i c·ªßa c√°c nh√≥m s·ª± v·∫≠t c√≥ t·ªï ch·ª©c." },

            // --- G: COLOR_FEEL (C·∫£m gi√°c m√†u) ---
            { g: "feel", q: "M√†u xanh da tr·ªùi t·∫°o c·∫£m gi√°c g√¨?", a: "An to√†n, tin c·∫≠y, h√≤a b√¨nh." },
            { g: "feel", q: "M√†u ƒë·ªè t·∫°o c·∫£m gi√°c g√¨?", a: "Nhi·ªát huy·∫øt, ham mu·ªën, nguy hi·ªÉm." },
            { g: "feel", q: "M√†u t√≠m t·∫°o c·∫£m gi√°c g√¨?", a: "Tinh t·∫ø, huy·ªÅn b√≠, chung th·ªßy." },
            { g: "feel", q: "M√†u v√†ng t·∫°o c·∫£m gi√°c g√¨?", a: "T√≠ch c·ª±c, l·∫°c quan, ·∫•m √°p." },
            { g: "feel", q: "M√†u ƒëen t·∫°o c·∫£m gi√°c g√¨?", a: "Sang tr·ªçng, c·ªï ƒëi·ªÉn, b√≠ ·∫©n." },
            { g: "feel", q: "M√†u tr·∫Øng t·∫°o c·∫£m gi√°c g√¨?", a: "Trong s·∫°ch, thu·∫ßn khi·∫øt, ƒë∆°n gi·∫£n." },
            { g: "feel", q: "M√†u cam t·∫°o c·∫£m gi√°c g√¨?", a: "H√†i h∆∞·ªõc, c·ªüi m·ªü, nƒÉng ƒë·ªông." },
            { g: "feel", q: "M√†u n√¢u t·∫°o c·∫£m gi√°c g√¨?", a: "G·∫ßn g≈©i, l√¢u d√†i, ·ªïn ƒë·ªãnh." },
            { g: "feel", q: "Gam m√†u n√≥ng t·∫°o c·∫£m gi√°c g√¨?", a: "T·∫°o s·ª©c n√≥ng, t·ªèa nƒÉng l∆∞·ª£ng, sinh l·ª±c." },
            { g: "feel", q: "Gam m√†u l·∫°nh t·∫°o c·∫£m gi√°c g√¨?", a: "B√¨nh y√™n, m√°t m·∫ª, d·ªÖ ch·ªãu." },

            // --- G: COLOR_TYPE (Ph√¢n lo·∫°i m√†u) ---
            { g: "color", q: "M√†u g·ªëc c∆° b·∫£n c·ªßa h·ªá m√†u c·ªông (RGB)?", a: "ƒê·ªè, Xanh l√°, Xanh lam." },
            { g: "color", q: "M√†u g·ªëc c∆° b·∫£n c·ªßa h·ªá m√†u h·ªØu c∆° (RYB)?", a: "ƒê·ªè c·ªù, V√†ng chanh, Xanh coban." },
            { g: "color", q: "H·ªá m√†u CMYK bao g·ªìm?", a: "Xanh l∆°, H·ªìng c√°nh sen, V√†ng, ƒêen." },
            { g: "color", q: "M√†u v√¥ s·∫Øc bao g·ªìm nh·ªØng m√†u n√†o?", a: "ƒêen, Tr·∫Øng, X√°m." },
            { g: "color", q: "M√†u h·ªØu s·∫Øc l√† g√¨?", a: "T·∫•t c·∫£ c√°c m√†u tr·ª´ ƒêen, Tr·∫Øng, X√°m." },
            { g: "color", q: "Tr·ªôn t·∫•t c·∫£ m√†u c·ªông (√Ånh s√°ng) ra m√†u g√¨?", a: "M√†u tr·∫Øng." },
            { g: "color", q: "Tr·ªôn t·∫•t c·∫£ m√†u tr·ª´ (In ·∫•n) ra m√†u g√¨?", a: "M√†u ƒëen." },
            { g: "color", q: "Tr·ªôn t·∫•t c·∫£ m√†u h·ªØu c∆° ra m√†u g√¨?", a: "M√†u x√°m." },

            // --- G: SHAPE_DIR (H∆∞·ªõng h√¨nh kh·ªëi) ---
            { g: "dir", q: "H√¨nh tr√≤n l√† h√¨nh c√≥ h∆∞·ªõng nh∆∞ th·∫ø n√†o?", a: "V√¥ h∆∞·ªõng." },
            { g: "dir", q: "H√¨nh vu√¥ng v√† h√¨nh ch·ªØ nh·∫≠t l√† h√¨nh c√≥ h∆∞·ªõng nh∆∞ th·∫ø n√†o?", a: "H∆∞·ªõng ƒë·ªëi l·∫≠p." },
            { g: "dir", q: "H√¨nh l·ª•c gi√°c l√† h√¨nh c√≥ h∆∞·ªõng nh∆∞ th·∫ø n√†o?", a: "ƒêa h∆∞·ªõng." },
            { g: "dir", q: "H√¨nh ƒë·ªãnh h∆∞·ªõng l√† h√¨nh nh∆∞ th·∫ø n√†o?", a: "H√¨nh c√≥ chuy·ªÉn ƒë·ªông r√µ v·ªÅ m·ªôt ph√≠a." },
            { g: "dir", q: "ƒêi·ªÉm c√≥ ƒë·∫∑c t√≠nh h∆∞·ªõng nh∆∞ th·∫ø n√†o?", a: "V√¥ h∆∞·ªõng, c√≥ t√≠nh t·∫≠p trung." },

            // --- G: BALANCE_RULE (Quy t·∫Øc c√¢n b·∫±ng) ---
            { g: "rule", q: "Trong c√¢n b·∫±ng th·ªã gi√°c, h√¨nh h∆∞·ªõng l√™n t·∫°o c·∫£m gi√°c g√¨?", a: "C·∫£m gi√°c nh·∫π." },
            { g: "rule", q: "Trong c√¢n b·∫±ng th·ªã gi√°c, h√¨nh h∆∞·ªõng xu·ªëng t·∫°o c·∫£m gi√°c g√¨?", a: "C·∫£m gi√°c n·∫∑ng." },
            { g: "rule", q: "C√¢n b·∫±ng th·ªã gi√°c Tr√™n - D∆∞·ªõi quy ∆∞·ªõc th·∫ø n√†o?", a: "Tr√™n nh·∫π, d∆∞·ªõi n·∫∑ng." },
            { g: "rule", q: "C√¢n b·∫±ng th·ªã gi√°c Tr√°i - Ph·∫£i quy ∆∞·ªõc th·∫ø n√†o?", a: "Ph·∫£i nh·∫π, tr√°i n·∫∑ng." },
            { g: "rule", q: "C√¢n b·∫±ng th·ªã gi√°c Tr∆∞·ªõc - Sau quy ∆∞·ªõc th·∫ø n√†o?", a: "Sau nh·∫π, tr∆∞·ªõc n·∫∑ng." },
            { g: "rule", q: "V·ªã tr√≠ trung t√¢m cho c·∫£m gi√°c g√¨?", a: "C√¢n b·∫±ng ·ªïn ƒë·ªãnh nh·∫•t." },

            // --- G: LIST (Danh s√°ch li·ªát k√™) ---
            { g: "list", q: "C√≥ m·∫•y c·∫∑p c√¢n b·∫±ng th·ªã gi√°c ch√≠nh?", a: "3 c·∫∑p: Tr√™n-D∆∞·ªõi, Tr√°i-Ph·∫£i, Tr∆∞·ªõc-Sau." },
            { g: "list", q: "C√≥ m·∫•y lo·∫°i nh·ªãp ƒëi·ªáu c∆° b·∫£n?", a: "4 lo·∫°i: Li√™n t·ª•c, Ti·ªám bi·∫øn, L·ªìi l√µm, Giao thoa." },
            { g: "list", q: "C√≥ m·∫•y lo·∫°i n√©t c∆° b·∫£n?", a: "4 lo·∫°i: C√≥ nghƒ©a, Li√™n t∆∞·ªüng, ƒêa nghƒ©a, C·∫•u t·∫°o." },
            { g: "list", q: "H·ªá th·ªëng x·ª≠ l√Ω th√¥ng tin con ng∆∞·ªùi c√≥ m·∫•y c·∫•u tr√∫c?", a: "3 c·∫•u tr√∫c: Gi√°c quan, L√†m vi·ªác, D√†i h·∫°n." },
            { g: "list", q: "C√°c h√¨nh th·ª©c t∆∞∆°ng ph·∫£n c∆° b·∫£n g·ªìm?", a: "ƒê∆∞·ªùng n√©t, H√¨nh kh·ªëi, M√†u s·∫Øc, ƒê·∫≠m nh·∫°t, Ch·∫•t li·ªáu." },
            
            // --- G: LIGHT (√Ånh s√°ng) ---
            { g: "light", q: "Ngu·ªìn s√°ng ch√≠nh l√† g√¨?", a: "Ngu·ªìn s√°ng m·∫°nh nh·∫•t chi·∫øu v√†o v·∫≠t th·ªÉ." },
            { g: "light", q: "Ngu·ªìn s√°ng ph·ª• c√≥ t√°c d·ª•ng g√¨?", a: "L√†m m·ªÅm b√≥ng ƒë·ªï, gi·∫£m ƒë·ªô t∆∞∆°ng ph·∫£n." },
            { g: "light", q: "√Ånh s√°ng v√†ng trong nh√† h√†ng c√≥ t√°c d·ª•ng g√¨?", a: "T·∫°o c·∫£m gi√°c ·∫•m c√∫ng, ngon mi·ªáng." },
            { g: "light", q: "√Ånh s√°ng ƒë√®n flash c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨?", a: "R√µ n√©t nh∆∞ng √≠t b√≥ng ƒë·ªï, h√¨nh ·∫£nh ph·∫≥ng." },
            { g: "light", q: "√Ånh s√°ng m·∫∑t tr·ªùi ƒë·∫πp nh·∫•t v√†o gi·ªù n√†o?", a: "8h30-10h30 v√† 13h30-15h30." }
        ];

        // --- 2. LOGIC GAME ---
        const themes = [
            { video: "media/1,1.mp4", audio: "audio/a5.mp3", c1: "#7289da", c2: "#00d2ff" },
            { video: "media/1,22.mp4", audio: "audio/a1.m4a", c1: "#ff00cc", c2: "#333399" },
            { video: "media/2.mp4", audio: "audio/a2.m4a", c1: "#00c6ff", c2: "#0072ff" },
            { video: "media/7.mp4", audio: "audio/a4.m4a", c1: "#00DBDE", c2: "#FC00FF" },
            { video: "media/8.mp4", audio: "audio/a6.m4a", c1: "#4568DC", c2: "#B06AB3" },
            { video: "media/lofigirl-loop-audio.mp4", audio: "audio/a7.m4a", c1: "#e67e22", c2: "#d35400" }
        ];

        let state = {
            deck: [],
            currentQ: null,
            streak: 0,
            playing: false,
            themeIdx: 0
        };

        const ui = {
            qText: document.getElementById('q-text'),
            opts: document.getElementById('opt-container'),
            nextBtn: document.getElementById('next-btn'),
            streak: document.getElementById('streak'),
            prog: document.getElementById('progress'),
            video: document.getElementById('bg-video'),
            audio: document.getElementById('bg-music'),
            musicIcon: document.getElementById('music-icon'),
            root: document.documentElement
        };

        // --- INIT & UTILS ---
        function init() {
            // T·∫°o b·ªô b√†i (Index shuffle)
            state.deck = Array.from({length: db.length}, (_, i) => i);
            shuffle(state.deck);
            loadQuestion();
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function loadQuestion() {
            ui.nextBtn.style.display = 'none';
            ui.opts.innerHTML = '';
            
            // H·∫øt c√¢u h·ªèi th√¨ reset
            if (state.deck.length === 0) {
                alert("B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi! Reset.");
                state.deck = Array.from({length: db.length}, (_, i) => i);
                shuffle(state.deck);
            }

            // R√∫t b√†i
            const idx = state.deck.pop();
            const q = db[idx];
            state.currentQ = q;

            ui.qText.innerText = q.q;
            ui.prog.innerText = db.length - state.deck.length;

            // --- THU·∫¨T TO√ÅN T·∫†O ƒê√ÅP √ÅN NHI·ªÑU TH√îNG MINH ---
            // 1. L·∫•y t·∫•t c·∫£ c√¢u c√≥ c√πng Group (g)
            let groupItems = db.filter(item => item.g === q.g && item.a !== q.a);
            
            let distractors = [];
            
            // 2. N·∫øu Group c√≥ ƒë·ªß 3 ƒë√°p √°n kh√°c, l·∫•y random trong ƒë√≥
            if (groupItems.length >= 3) {
                shuffle(groupItems);
                distractors = groupItems.slice(0, 3).map(i => i.a);
            } else {
                // 3. N·∫øu kh√¥ng ƒë·ªß (hi·∫øm), l·∫•y random trong to√†n b·ªô DB nh∆∞ng tr√°nh tr√πng
                let others = db.filter(i => i.a !== q.a);
                shuffle(others);
                distractors = others.slice(0, 3).map(i => i.a);
            }

            // 4. Tr·ªôn ƒë√°p √°n ƒë√∫ng v√†o
            let options = [q.a, ...distractors];
            shuffle(options);

            // 5. Render Buttons (S·ª≠ d·ª•ng th·∫ª BUTTON chu·∫©n)
            const labels = ['A', 'B', 'C', 'D'];
            options.forEach((txt, i) => {
                const btn = document.createElement('button'); // D√πng button ƒë·ªÉ nh·∫≠n click t·ªët nh·∫•t
                btn.className = 'option-btn';
                btn.innerHTML = `<div class="tag">${labels[i]}</div><span>${txt}</span>`;
                
                // G√°n s·ª± ki·ªán click tr·ª±c ti·∫øp
                btn.onclick = (e) => handleAnswer(e, btn, txt === q.a, q.a);
                
                ui.opts.appendChild(btn);
            });
        }

        function handleAnswer(e, btn, isCorrect, correctTxt) {
            // Hi·ªáu ·ª©ng h·∫°t
            createParticles(e.clientX, e.clientY);

            // Disable t·∫•t c·∫£ n√∫t
            const all = document.querySelectorAll('.option-btn');
            all.forEach(b => b.disabled = true);

            if (isCorrect) {
                playSound('correct');
                btn.classList.add('correct');
                state.streak++;
                ui.streak.innerText = state.streak;
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                state.streak = 0;
                ui.streak.innerText = 0;
                // Hi·ªán ƒë√°p √°n ƒë√∫ng
                all.forEach(b => {
                    if (b.innerText.includes(correctTxt)) b.classList.add('correct');
                });
            }
            ui.nextBtn.style.display = 'block';
        }

        function nextQuestion() {
            loadQuestion();
        }

        // --- MEDIA & THEME ---
        function changeTheme(idx) {
            const t = themes[idx];
            ui.video.src = t.video;
            ui.audio.src = t.audio;
            if (state.playing) ui.audio.play();
            
            ui.root.style.setProperty('--grad-1', t.c1);
            ui.root.style.setProperty('--grad-2', t.c2);
            
            // ƒê·ªïi m√†u vi·ªÅn avatar
            document.getElementById('avatar-img').style.borderColor = t.c1;
        }

        function toggleMusic() {
            if (state.playing) {
                ui.audio.pause();
                ui.musicIcon.className = 'fas fa-volume-mute';
                state.playing = false;
            } else {
                ui.audio.play().catch(() => {});
                ui.musicIcon.className = 'fas fa-volume-up';
                state.playing = true;
            }
        }

        // --- AUDIO ENGINE (T·∫°o √¢m thanh kh√¥ng c·∫ßn file) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            }
        }

        // --- PARTICLE EFFECT ---
        function createParticles(x, y) {
            const count = 10;
            for(let i=0; i<count; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                // M√†u ng·∫´u nhi√™n theo theme
                p.style.color = Math.random() > 0.5 ? getComputedStyle(ui.root).getPropertyValue('--grad-2') : '#fff';
                p.style.left = x + 'px'; p.style.top = y + 'px';
                
                // Random h∆∞·ªõng bay
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 60 + 20;
                const dx = Math.cos(angle) * dist;
                const dy = Math.sin(angle) * dist;
                
                p.style.setProperty('--dx', dx + 'px');
                p.style.setProperty('--dy', dy + 'px');
                
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        }

        // Start App
        init();

    </script>
</body>
</html>