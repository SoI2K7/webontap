<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kh√¥ng Gian Chill - Nh√≥m L·ª≠a</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --card-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-main: #fff; 
            --text-sub: #eee;
            --accent-color: #a29bfe;
            --radius: 24px;
            --font-main: 'Quicksand', sans-serif;
            --btn-text-color: #fff;
        }

        select, input { color: #333 !important; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        
        body {
            height: 100vh; width: 100vw; overflow: hidden; background-color: #111; 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            display: flex; justify-content: space-between; padding: 25px;
            color: var(--text-main); 
            transition: background-image 1s ease-in-out, background-color 1s ease;
            position: relative;
        }

        /* --- VIDEO BACKGROUND --- */
        #video-bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            z-index: 0; overflow: hidden; background-color: #000; pointer-events: none;
            opacity: 0; transition: opacity 1s ease-in-out, filter 0.5s ease;
        }
        #video-bg-container.active { opacity: 1; }
        
        #bg-video-player {
            position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%;
            width: auto; height: auto; transform: translate(-50%, -50%);
            object-fit: cover; 
        }

        /* --- UI LAYERS --- */
        .left-sidebar, .right-area, .top-nav-container, #intro-overlay, #zen-overlay, #update-log-modal {
            position: relative; z-index: 10; 
        }
        .left-sidebar *, .right-area *, .top-nav-container * { pointer-events: auto; }
        #intro-overlay, #zen-overlay, #update-log-modal { pointer-events: auto !important; }
        
        /* --- NAV BAR --- */
        .top-nav-container {
            position: absolute;
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            top: 25px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 12px; 
            padding: 10px; 
            border-radius: 50px; z-index: 999;
            transition: all 0.5s ease; opacity: 0; pointer-events: none;
            align-items: center; 
        }
        .top-nav-container.visible { opacity: 1; pointer-events: auto; }

        .nav-pill {
            padding: 10px 24px;
            border-radius: 30px; 
            font-weight: 700; font-size: 14px; cursor: pointer; color: #333; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            line-height: 1.2; 
        }
        
        /* --- ACTIVE STATE FIX (Lu√¥n n·ªïi l√™n) --- */
        .nav-pill.active { 
            background: var(--accent-color); 
            color: white; 
            transform: translateY(-4px); /* N·ªïi l√™n */
            box-shadow: 0 8px 20px rgba(162, 155, 254, 0.6); /* ƒê·ªï b√≥ng */
        }

        /* ƒê·ªìng h·ªì */
        .nav-clock {
            background: rgba(0,0,0,0.5); 
            color: #fff; 
            cursor: default;
            font-variant-numeric: tabular-nums;
            border: 1px solid rgba(255,255,255,0.2);
            transform: none !important; /* ƒê·ªìng h·ªì kh√¥ng c·∫ßn n·ªïi */
            box-shadow: none !important;
        }

        .nav-pill.fire-effect {
            background: linear-gradient(135deg, #ff4d4d, #ff9f43);
            color: white; font-weight: 800;
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.6);
            animation: firePulse 1.5s infinite alternate;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        @keyframes firePulse {
            0% { box-shadow: 0 0 10px rgba(255, 77, 77, 0.5); transform: scale(1); }
            100% { box-shadow: 0 0 25px rgba(255, 159, 67, 0.8); transform: scale(1.05); }
        }

        /* --- FIRE SPARK EFFECT --- */
        .spark-particle {
            position: fixed; width: 6px; height: 6px;
            background: radial-gradient(circle, #ffeb3b, #ff5722);
            border-radius: 50%; pointer-events: none; z-index: 10000;
            animation: spark-burst 0.8s ease-out forwards;
        }
        @keyframes spark-burst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* --- UPDATE LOG STYLES --- */
        .btn-update-log {
            position: fixed; bottom: 20px; right: 20px; z-index: 998;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); transition: 0.3s;
        }
        .btn-update-log:hover { background: var(--accent-color); transform: scale(1.1); }

        #update-log-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            z-index: 10001; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        #update-log-modal.active { display: flex; opacity: 1; }
        .log-content {
            background: rgba(30, 30, 30, 0.9); border: 1px solid rgba(255,255,255,0.2);
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            border-radius: 20px; padding: 25px; color: white; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .log-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .log-date { font-size: 12px; color: #aaa; font-weight: bold; margin-bottom: 5px; }
        .log-desc { font-size: 14px; line-height: 1.5; color: #ddd; }
        .log-version { display: inline-block; background: var(--accent-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 8px; }
        .btn-close-log {
            position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #aaa; font-size: 20px; cursor: pointer;
        }

        /* --- HOVER GLOW --- */
        @media (hover: hover) {
            .nav-pill:not(.active):not(.fire-effect):not(.nav-clock):hover, 
            .btn-tool:hover, .mood-btn:hover, .btn-fc:hover, 
            .btn-timer:hover, .spotify-toggle:hover, 
            .explore-item:hover, 
            .btn-spotify-load:hover, .btn-spotify-stop:hover,
            .btn-save-card:hover, .btn-add-confirm:hover,
            .btn-close-zen:hover, .btn-adjust:hover, .btn-set-confirm:hover, 
            .btn-update-log:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(162, 155, 254, 0.5);
                z-index: 2;
                background: rgba(255,255,255,0.9);
                color: var(--accent-color);
            }

            /* FIX RI√äNG CHO BUDDY ITEM ƒê·ªÇ KH√îNG B·ªä GI·∫¨T */
            .buddy-item:hover {
                transform: translateY(-4px) scale(1.02) !important; /* G·ªôp 2 hi·ªáu ·ª©ng l√†m 1 */
                box-shadow: 0 8px 20px rgba(0,0,0,0.3);
                z-index: 2;
                border-color: var(--accent-color);
            }
        }

        /* --- PANEL STYLES --- */
        .cozy-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            border-radius: var(--radius);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            height: auto; min-height: fit-content; flex-shrink: 0; pointer-events: auto;
            color: white; 
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 20px 25px; min-height: 70px; }
        .panel-header h3 { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 18px; }
        .toggle-btn { color: rgba(255,255,255,0.9); }
        .panel-content { transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); opacity: 1; max-height: 800px; padding: 0 25px 25px 25px; overflow: hidden; }
        .cozy-panel.collapsed .toggle-btn { transform: rotate(180deg); }
        .cozy-panel.collapsed .panel-content { opacity: 0; max-height: 0; padding: 0 25px; margin: 0; }
        .cozy-panel.collapsed { flex-grow: 0 !important; height: auto !important; padding-bottom: 0 !important; }
        .mini-display { font-size: 14px; margin-left: auto; margin-right: 15px; font-weight: bold; color: var(--accent-color); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; display: flex; align-items: center; gap: 6px; }
        .cozy-panel.collapsed .mini-display { opacity: 1; }
        p { color: rgba(255,255,255,0.95) !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .left-sidebar, .right-area { 
            width: 360px; display: flex; flex-direction: column; gap: 15px; 
            max-height: 100%; overflow-y: auto; padding-right: 5px; padding-bottom: 20px;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 10px; }
        :hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.8); }

        /* Controls */
        .learning-filter { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .filter-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        .fc-select { flex-grow: 1; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.8); color: #333; font-family: var(--font-main); font-size: 12px; font-weight: 600; outline: none; cursor: pointer; width: 0; }
        .btn-tool { width: 28px; height: 28px; border-radius: 8px; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 11px; flex-shrink: 0; }
        .btn-add-sub { background: #74b9ff; } .btn-del-sub { background: #ff7675; }
        .btn-add-lvl { background: #55efc4; } .btn-del-lvl { background: #fab1a0; }
        .btn-add-card { background: var(--accent-color); width: 100%; margin-top: 5px; border-radius: 10px;}
        .fc-delete-btn { position: absolute; top: 10px; right: 10px; color: #ff7675; cursor: pointer; font-size: 14px; padding: 5px; opacity: 0.5; transition: 0.2s; z-index: 5; }
        .fc-delete-btn:hover { opacity: 1; transform: scale(1.1); }
        .custom-form { background: rgba(255,255,255,0.8); padding: 15px; border-radius: 16px; margin-bottom: 15px; display: none; flex-direction: column; gap: 10px; animation: slideDown 0.3s ease; border: 1px solid rgba(255,255,255,0.5); }
        @keyframes slideDown { from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);} }
        .fc-input { padding: 10px; border: 1px solid rgba(255,255,255,0.5); background: white; border-radius: 8px; outline: none; font-size: 13px; font-family: var(--font-main); color: #333;}
        .btn-save-card { padding: 8px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .form-title { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; }

        .flashcard-container { perspective: 1000px; width: 100%; height: 180px; margin-bottom: 15px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .flashcard-container.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; border-radius: 16px; background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); }
        .flashcard-front { color: #333; }
        .flashcard-back { background: var(--accent-color); color: white; transform: rotateY(180deg); }
        .fc-category { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 10px; }
        .fc-content { font-size: 18px; font-weight: 700; line-height: 1.4; }
        .flashcard-back .fc-category { color: rgba(255,255,255,0.7); }
        .fc-controls { display: flex; gap: 10px; justify-content: center; }
        .btn-fc { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-fc-review { background: rgba(255,255,255,0.8); color: #333; }
        .btn-fc-master { background: var(--accent-color); color: white; }
        .btn-fc-restart { background: #333; color: white; width: 100%; } 
        .fc-progress { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-bottom: 15px; overflow: hidden; }
        .fc-bar { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s ease; }

        /* Intro & Zen */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(30px); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s ease; pointer-events: auto !important; }
        .intro-content { text-align: center; background: rgba(255, 255, 255, 0.9); padding: 40px 60px; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 800px; width: 90%; animation: float 3s ease-in-out infinite; color: #333;}
        .intro-title { font-size: 36px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .intro-sub { font-size: 16px; color: #666; margin-bottom: 30px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .mood-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; transition: all 0.3s ease; }
        .mood-icon { font-size: 32px; }
        .mood-text { font-weight: 700; color: #333; font-size: 14px;}
        .mood-btn:hover { transform: translateY(-5px); background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 10px 20px rgba(143, 170, 194, 0.3); }
        .mood-btn:hover .mood-text { color: white; }
        .hidden-intro { opacity: 0; visibility: hidden; pointer-events: none !important; }
        
        #zen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 40, 50, 0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.8s ease, visibility 0.8s ease; color: white; pointer-events: auto !important;}
        #zen-overlay.active { opacity: 1; visibility: visible; }
        .breathing-circle { 
            width: 200px; height: 200px; 
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%); 
            border-radius: 50%; 
            box-shadow: 0 0 50px rgba(168, 230, 207, 0.4); 
            margin-bottom: 80px; 
            transform: scale(1); 
        }
        .breathing-anim { animation: breathe 8s infinite ease-in-out; }
        @keyframes breathe { 
            0%, 100% { transform: scale(1); opacity: 0.8; } 
            50% { transform: scale(1.3); opacity: 1; } 
        }
        .zen-instruction { font-size: 24px; font-weight: 300; margin-bottom: 20px; letter-spacing: 2px; }
        .zen-quote { font-size: 18px; font-style: italic; max-width: 600px; text-align: center; line-height: 1.6; opacity: 0.9; margin-bottom: 40px; }
        .btn-close-zen { padding: 12px 30px; border: 2px solid rgba(255,255,255,0.3); border-radius: 30px; background: transparent; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-close-zen:hover { background: white; color: #333; }

        .explore-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; padding-bottom: 5px;}
        .explore-item { font-size: 26px; cursor: pointer; text-align: center; padding: 8px; border-radius: 16px; background: rgba(255,255,255,0.5); transition: all 0.3s; }
        .explore-item.active { background: var(--accent-color); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .buddy-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .buddy-item { position: relative; height: 70px; border-radius: 12px; cursor: pointer; overflow: hidden; border: 2px solid transparent; background-size: cover; background-position: center; transition: all 0.3s; }
        /* EDITED: ƒê·∫£m b·∫£o ·∫£nh b·∫°n b√® kh√¥ng b·ªã ƒë√® CSS */
        .buddy-item:hover { transform: translateY(-4px) scale(1.02) !important; }
        .buddy-item.active { border-color: var(--accent-color); transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .buddy-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; text-align: center; font-weight: bold;}

        .timer-display { font-size: 56px; font-weight: 500; text-align: center; margin: 5px 0; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; }
        .timer-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.3); padding: 4px; border-radius: 12px; width: fit-content; margin: 0 auto 10px; }
        .timer-controls span { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; color: white; cursor: pointer; }
        .timer-controls span.active { background: white; color: var(--accent-color); }
        .btn-timer { width: 100%; padding: 12px; border: none; border-radius: 16px; background: var(--accent-color); color: white; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .adjust-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .btn-adjust { width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255,255,255,0.3); color: white; cursor: pointer; font-weight: bold; font-size: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;}
        .btn-adjust:hover { background: var(--accent-color); color: white; transform: scale(1.1); }
        .custom-input { width: 45px; padding: 5px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 16px; outline: none; color: white; border-bottom: 2px solid rgba(255,255,255,0.5); }
        .btn-set-confirm { padding: 6px 12px; background: var(--text-main); color: var(--btn-text-color); border: none; border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }
        
        #task-list { list-style: none; max-height: 250px; overflow-y: auto; padding-right: 5px; margin-top: 5px;}
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 8px; border-radius: 12px; transition: all 0.2s; color: white;}
        .task-checkbox { accent-color: var(--accent-color); width: 18px; height: 18px; cursor: pointer;}
        .add-task-box { margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); }
        .task-item.completed .task-text { text-decoration: line-through; color: rgba(255,255,255,0.5); }
        .music-divider { height: 1px; background: rgba(255,255,255,0.2); margin: 15px 0; border: none; }
        .music-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .album-art { width: 48px; height: 48px; background: rgba(255,255,255,0.5); border-radius: 12px; background-size: cover; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        input[type=range] { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; margin-top: 5px; cursor: pointer; flex-grow: 1; }

        /* MUSIC STYLES - UPDATED */
        .spotify-container { margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .spotify-toggle { font-size: 13px; font-weight: bold; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 8px; opacity: 0.9; transition: 0.3s; }
        .spotify-toggle:hover { opacity: 1; color: var(--accent-color); }
        .spotify-input-group { display: none; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .spotify-input { flex-grow: 1; padding: 8px; border-radius: 8px; border: none; font-size: 12px; outline: none; background: rgba(255,255,255,0.8); color: #333; }
        .btn-spotify-load, .btn-spotify-stop { padding: 8px 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-spotify-load { background: #1DB954; }
        .btn-spotify-stop { background: #e74c3c; display: none; }
        #embed-container iframe { width: 100%; border-radius: 12px; border: none; margin-top: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        #external-audio-controls { display: none; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; }
        .ext-controls-row { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #eee; }
        
        #youtube-audio-container { position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px; opacity: 0; }

        /* MODE TOGGLE & BLUR */
        .audio-mode-toggle, .blur-control-container { display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.8); }
        .blur-control-container { display: block; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(16px); }

        .disabled-controls { opacity: 0.3; pointer-events: none; filter: grayscale(100%); transition: all 0.3s ease; }

        /* FOCUS MODE - DESKTOP */
        body.focus-active .left-sidebar { display: none !important; }
        body.focus-active #panel-flashcards { display: none !important; }
        body.focus-active .right-area { width: 100%; justify-content: center; align-items: center; height: 100%; overflow: hidden; }
        body.focus-active #panel-timer { transform: scale(1.4); transition: transform 0.5s ease; z-index: 50; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; min-height: 100vh; padding: 15px; gap: 20px; justify-content: flex-start; padding-top: 70px; }
            .top-nav-container { 
                position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-150%); margin-bottom: 0; 
                flex-wrap: nowrap; justify-content: flex-start; /* EDITED: Align left to avoid squishing */
                width: 95%; max-width: 500px; 
                transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; pointer-events: none; 
                box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
                overflow-x: auto; /* Allow scroll */
                padding: 10px; /* Comfortable padding */
            }
            .top-nav-container::-webkit-scrollbar { display: none; } /* Hide scrollbar */
            
            .top-nav-container.visible { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
            
            .nav-pill { 
                font-size: 12px; padding: 8px 16px; min-height: auto; white-space: nowrap; flex-shrink: 0; /* Prevent shrinking */
            }
            
            .left-sidebar, .right-area { width: 100%; max-height: none; padding: 0; overflow: visible; }
            .cozy-panel { margin-bottom: 15px; width: 100%; }
            #video-bg-container { position: fixed; }
            .btn-tool, .btn-adjust, .btn-fc, .mood-btn { min-height: 44px; }
            .btn-adjust { width: 40px; height: 40px; }
            #intro-overlay .mood-grid { grid-template-columns: repeat(2, 1fr); }
            body.focus-active { padding-top: 90px; align-items: center; justify-content: flex-start; }
            body.focus-active .right-area { height: auto; overflow: visible; display: flex; flex-direction: column; align-items: center; width: 100%; }
            body.focus-active #panel-timer { transform: none !important; width: 100% !important; margin-top: 10px; max-width: 400px; }
            #mute-btn { font-size: 24px; padding: 10px; }
            input[type=range] { height: 10px; }
            .btn-update-log { bottom: 15px; right: 15px; }
        }
    </style>
</head>
<body>

    <div id="video-bg-container"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <div id="youtube-audio-container"></div>

    <audio id="ambient-audio" loop></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-alarm" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="intro-overlay">
        <div class="intro-content">
            <div class="intro-title">Ch√†o b·∫°n, h√¥m nay b·∫°n th·∫ø n√†o?</div>
            <div class="intro-sub">Ch·ªçn m·ªôt tr·∫°ng th√°i ƒë·ªÉ thi·∫øt l·∫≠p kh√¥ng gian nh√©!</div>
            <div class="mood-grid">
                <button class="mood-btn" onclick="selectMood('morning'); playSFX('click')"><span class="mood-icon">üå§Ô∏è</span><span class="mood-text">H√†o h·ª©ng</span></button>
                <button class="mood-btn" onclick="selectMood('rain'); playSFX('click')"><span class="mood-icon">ü§Ø</span><span class="mood-text">CƒÉng th·∫≥ng</span></button>
                <button class="mood-btn" onclick="selectMood('library'); playSFX('click')"><span class="mood-icon">üìö</span><span class="mood-text">T·∫≠p trung</span></button>
                <button class="mood-btn" onclick="selectMood('night'); playSFX('click')"><span class="mood-icon">üåô</span><span class="mood-text">Chill & Relax</span></button>
                <button class="mood-btn" onclick="selectMood('sunset'); playSFX('click')"><span class="mood-icon">üé®</span><span class="mood-text">S√°ng t·∫°o</span></button>
                <button class="mood-btn" onclick="selectMood('cafe'); playSFX('click')"><span class="mood-icon">‚òï</span><span class="mood-text">Bu·ªìn ch√°n</span></button>
            </div>
        </div>
    </div>

    <div id="zen-overlay">
        <div class="breathing-circle" id="zen-circle"></div>
        <div class="zen-instruction" id="zen-text">H√≠t s√¢u...</div>
        <div class="zen-quote" id="zen-quote">"..."</div>
        <button class="btn-close-zen" onclick="closeZenMode(); playSFX('click')">M√¨nh ·ªïn r·ªìi, quay l·∫°i th√¥i</button>
    </div>

    <div id="update-log-modal">
        <div class="log-content">
            <button class="btn-close-log" onclick="toggleUpdateLog()"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="margin-bottom: 20px; text-align: center;">Nh·∫≠t k√Ω c·∫≠p nh·∫≠t üìú</h2>
            
            <div class="log-item">
                <div class="log-date"><span class="log-version">v14.2</span> 26/12/2025</div>
                <div class="log-desc">
                    - S·ª≠a l·ªói h√¨nh ·∫£nh b·∫°n b√® b·ªã gi·∫≠t khi di chu·ªôt.<br>
                    - C·∫£i thi·ªán giao di·ªán Menu tr√™n ƒëi·ªán tho·∫°i (Scroll ngang).<br>
                    - N√∫t ƒëang ch·ªçn s·∫Ω lu√¥n n·ªïi l√™n ƒë·ªÉ d·ªÖ nh·∫≠n bi·∫øt.
                </div>
            </div>
            <div class="log-item">
                <div class="log-date"><span class="log-version">v14.1</span> 26/12/2025</div>
                <div class="log-desc">
                    - S·ª≠a l·ªói SOS b·ªã ƒë√® ch·ªØ khi h√≠t th·ªü.<br>
                    - C·∫≠p nh·∫≠t nh·∫≠t k√Ω ƒë·∫ßy ƒë·ªß t·ª´ ƒë·∫ßu.<br>
                    - T·ªëi ∆∞u hi·ªáu ·ª©ng hover n·ªïi 3D.
                </div>
            </div>
             <div class="log-item">
                <div class="log-date"><span class="log-version">v13.x</span> 26/12/2025</div>
                <div class="log-desc">
                    - Th√™m ƒë·ªìng h·ªì th·ªùi gian th·ª±c.<br>
                    - Th√™m hi·ªáu ·ª©ng tia l·ª≠a (Fire Effect).<br>
                    - Clean Slate: X√≥a link c≈© khi reload ƒë·ªÉ tr√°nh l·ªói.
                </div>
            </div>
             <div class="log-item">
                <div class="log-date"><span class="log-version">v12.x</span> 25/12/2025</div>
                <div class="log-desc">
                    - Th√™m t√≠nh nƒÉng "Kh√≥a √Çm thanh m√¥i tr∆∞·ªùng" (Exclusive Mode).<br>
                    - T√°ch bi·ªát ƒëi·ªÅu khi·ªÉn √¢m l∆∞·ª£ng YouTube v√† M√¥i tr∆∞·ªùng.
                </div>
            </div>
             <div class="log-item">
                <div class="log-date"><span class="log-version">v10.x</span> 24/12/2025</div>
                <div class="log-desc">
                    - Phi√™n b·∫£n ƒë·∫ßu ti√™n v·ªõi √¢m thanh Local.<br>
                    - T√≠ch h·ª£p YouTube/SoundCloud c∆° b·∫£n.
                </div>
            </div>
        </div>
    </div>
    
    <button class="btn-update-log" onclick="toggleUpdateLog()" title="Xem nh·∫≠t k√Ω c·∫≠p nh·∫≠t">üìú</button>

    <div class="top-nav-container" id="main-nav">
        <div class="nav-pill nav-clock" id="real-time-clock">--:--</div>
        
        <div class="nav-pill fire-effect" onclick="triggerFireEffect(event); playSFX('click')"><i class="fa-solid fa-fire"></i> L·ª≠a</div>
        <div class="nav-pill active" id="btn-myspace" onclick="switchView('myspace'); playSFX('click')">Kh√¥ng gian</div>
        <div class="nav-pill" id="btn-focus" onclick="switchView('focus'); playSFX('click')">T·∫≠p trung</div>
        <div class="nav-pill sos-btn" onclick="openZenMode(); playSFX('click')">SOS Stress üÜò</div>
    </div>

    <div class="left-sidebar">
        <div class="cozy-panel" id="panel-left">
            <div class="panel-header" onclick="togglePanel('panel-left'); playSFX('click')">
                <h3>Kh√°m ph√° Kh√¥ng gian</h3>
                <div class="mini-display" id="mini-music"><i class="fa-solid fa-music"></i> <span id="mini-track-name">Chill Lofi</span></div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">H√¨nh n·ªÅn & √Çm thanh</p>
                <div class="explore-grid" id="explore-grid"></div>
                
                <div class="blur-control-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 12px; font-weight: bold;">L√†m m·ªù n·ªÅn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="blur-toggle" onchange="toggleBlur()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <input type="range" id="blur-slider" min="0" max="20" value="5" oninput="changeBlur(this.value)">
                </div>

                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px;">H·ªçc c√πng B·∫°n b√®</p>
                <div class="buddy-grid" id="buddy-grid"></div>
                <hr class="music-divider">
                
                <div id="local-player-controls">
                    <div class="music-player">
                        <div class="music-info">
                            <div class="album-art" id="album-art">üéµ</div>
                            <div>
                                <p class="track-name" id="track-name" style="font-weight:bold; font-size:14px;">Chill Lofi</p>
                                <p style="font-size: 10px; opacity: 0.8;">√Çm l∆∞·ª£ng m√¥i tr∆∞·ªùng</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-volume-high" id="mute-btn" onclick="toggleAmbientMute(); playSFX('click')" style="cursor: pointer; width: 30px; text-align:center; color: var(--accent-color);"></i>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" title="Ambient Volume" oninput="changeAmbientVolume(this.value)">
                        </div>
                    </div>
                </div>

                <div id="external-audio-controls">
                    <div class="ext-controls-row">
                        <i class="fa-brands fa-youtube" style="color:red; width:30px; text-align:center; font-size:18px;"></i>
                        <span style="flex-grow:1; font-weight:bold;">Nh·∫°c YouTube</span>
                        <i class="fa-solid fa-volume-high" id="ext-mute-btn" onclick="toggleExternalMute(); playSFX('click')" style="cursor: pointer; width:20px; text-align:center;"></i>
                        <input type="range" id="ext-volume-slider" min="0" max="100" value="50" oninput="changeExternalVolume(this.value)" style="width: 80px;">
                    </div>
                </div>

                <div class="spotify-container">
                    <div class="spotify-toggle" onclick="toggleSpotifyInput(); playSFX('click')">
                        <i class="fa-brands fa-youtube"></i> Nh·∫≠p link YouTube/SoundCloud
                    </div>
                    <div style="font-size: 10px; color: #eee; margin-bottom: 5px; margin-left: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">(Khuy√™n d√πng SoundCloud ƒë·ªÉ ·ªïn ƒë·ªãnh nh·∫•t)</div>
                    
                    <div class="spotify-input-group" id="spotify-input-group">
                        <input type="text" id="spotify-url" class="spotify-input" placeholder="D√°n link YouTube ho·∫∑c SoundCloud...">
                        <button class="btn-spotify-load" onclick="loadCustomEmbed(); playSFX('click')">Ph√°t</button>
                        <button class="btn-spotify-stop" id="btn-ext-stop" onclick="stopExternalMusic(); playSFX('click')" title="D·ª´ng nh·∫°c"><i class="fa-solid fa-stop"></i></button>
                    </div>
                    
                    <div class="audio-mode-toggle">
                        <span>Ch·∫ø ƒë·ªô: <strong>Tr·ªôn √¢m</strong></span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="audio-exclusive-mode" onchange="toggleAudioMode()">
                            <span class="slider"></span>
                        </label>
                        <span><strong>Ch·ªâ m·ªôt</strong></span>
                    </div>

                    <div id="embed-container"></div>
                </div>

            </div>
        </div>

        <div class="cozy-panel" id="panel-tasks">
            <div class="panel-header" onclick="togglePanel('panel-tasks'); playSFX('click')">
                <h3>Danh s√°ch Vi·ªác <span id="task-count" style="font-size: 14px; opacity: 0.8; font-weight: normal;">(0)</span></h3>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <ul id="task-list"></ul>
                <div class="add-task-box">
                    <div id="btn-show-add" onclick="showInput(); playSFX('click')" style="cursor: pointer;"><i class="fa-solid fa-plus-circle"></i> Th√™m vi·ªác m·ªõi</div>
                    <div id="input-group" style="display:none; gap:5px;">
                        <input type="text" id="new-task-input" placeholder="M·ª•c ti√™u c·ªßa b·∫°n l√† g√¨?" style="flex-grow:1; padding:8px; border:1px solid #eee; border-radius:8px;">
                        <button class="btn-add-confirm" onclick="addTask(); playSFX('click')" style="padding:5px 10px; background:var(--accent-color); color:white; border:none; border-radius:8px;">Th√™m</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-area">
        <div class="cozy-panel" id="panel-timer">
            <div class="panel-header" onclick="togglePanel('panel-timer'); playSFX('click')">
                <h3>ƒê·ªìng h·ªì</h3>
                <div class="mini-display" id="mini-timer" style="font-size: 18px;">25:00</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <div class="timer-controls">
                    <span id="btn-pomodoro" class="active" onclick="switchMode('pomodoro'); playSFX('click')">T·∫≠p trung</span>
                    <span id="btn-short" onclick="switchMode('short'); playSFX('click')">Ngh·ªâ ng·∫Øn</span>
                    <span id="btn-long" onclick="switchMode('long'); playSFX('click')">Ngh·ªâ d√†i</span>
                </div>
                <div class="timer-display" id="timer-text">25:00</div>
                <div class="adjust-container">
                    <button class="btn-adjust" onclick="adjustTime(-5); playSFX('click')">-5</button>
                    <button class="btn-adjust" onclick="adjustTime(-1); playSFX('click')">-1</button>
                    <input type="number" id="custom-minutes" class="custom-input" value="25" min="1">
                    <button class="btn-adjust" onclick="adjustTime(1); playSFX('click')">+1</button>
                    <button class="btn-adjust" onclick="adjustTime(5); playSFX('click')">+5</button>
                    <button class="btn-set-confirm" onclick="applyCustomTime(); playSFX('click')">ƒê·∫∑t</button>
                </div>
                <button class="btn-timer" id="btn-action" onclick="toggleTimer(); playSFX('click')">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>

        <div class="cozy-panel" id="panel-flashcards">
            <div class="panel-header" onclick="togglePanel('panel-flashcards'); playSFX('click')">
                <h3>H·ªçc Nhanh</h3>
                <div class="mini-display" id="mini-fc">0 Th·∫ª xong</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <div class="learning-filter">
                    <div class="filter-row">
                        <button class="btn-tool btn-add-sub" onclick="toggleAddSubjectForm(); playSFX('click')" title="Th√™m m√¥n"><i class="fa-solid fa-folder-plus"></i></button>
                        <button class="btn-tool btn-del-sub" onclick="deleteSubject(); playSFX('click')" title="X√≥a m√¥n"><i class="fa-solid fa-trash"></i></button>
                        <select id="subject-select" class="fc-select"></select>
                    </div>
                    <div class="filter-row">
                        <button class="btn-tool btn-add-lvl" onclick="toggleAddLevelForm(); playSFX('click')" title="Th√™m c·∫•p ƒë·ªô"><i class="fa-solid fa-layer-group"></i></button>
                        <button class="btn-tool btn-del-lvl" onclick="deleteLevel(); playSFX('click')" title="X√≥a c·∫•p ƒë·ªô"><i class="fa-solid fa-trash-can"></i></button>
                        <select id="level-select" class="fc-select"></select>
                    </div>
                    <button class="btn-tool btn-add-card" onclick="toggleAddCardForm(); playSFX('click')" title="Th√™m th·∫ª m·ªõi"><i class="fa-solid fa-plus"></i> ¬†Th√™m Th·∫ª</button>
                </div>

                <div id="add-subject-form" class="custom-form" style="display:none;">
                    <div class="form-title">T·∫°o m√¥n h·ªçc m·ªõi</div>
                    <input type="text" id="new-subject-name" class="fc-input" placeholder="T√™n m√¥n (VD: L·ªãch s·ª≠)">
                    <input type="text" id="new-subject-level" class="fc-input" placeholder="T√™n c·∫•p ƒë·ªô ƒë·∫ßu (VD: Ch∆∞∆°ng 1)">
                    <button class="btn-save-card" onclick="saveNewSubject(); playSFX('click')">T·∫°o M√¥n</button>
                </div>
                
                <div id="add-level-form" class="custom-form" style="display:none;">
                    <div class="form-title">Th√™m c·∫•p ƒë·ªô m·ªõi</div>
                    <input type="text" id="new-level-name" class="fc-input" placeholder="T√™n c·∫•p ƒë·ªô (VD: N√¢ng cao)">
                    <button class="btn-save-card" onclick="saveNewLevel(); playSFX('click')">Th√™m C·∫•p ƒê·ªô</button>
                </div>

                <div id="add-card-form" class="custom-form" style="display:none;">
                    <div class="form-title">Th√™m th·∫ª v√†o b√†i h·ªçc n√†y</div>
                    <input type="text" id="new-card-q" class="fc-input" placeholder="C√¢u h·ªèi / T·ª´ v·ª±ng">
                    <input type="text" id="new-card-a" class="fc-input" placeholder="ƒê√°p √°n / ƒê·ªãnh nghƒ©a">
                    <button class="btn-save-card" onclick="saveCustomCard(); playSFX('click')">L∆∞u Th·∫ª</button>
                </div>

                <div class="fc-progress"><div class="fc-bar" id="fc-bar"></div></div>
                <div class="flashcard-container" onclick="flipCard(this); playSFX('click')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <i class="fa-solid fa-trash fc-delete-btn" onclick="deleteCurrentCard(event); playSFX('click')" title="X√≥a th·∫ª n√†y"></i>
                            <div class="fc-category" id="fc-cat-front">Danh m·ª•c</div>
                            <div class="fc-content" id="fc-q">ƒêang t·∫£i...</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-top:15px;">(B·∫•m ƒë·ªÉ l·∫≠t)</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="fc-category" id="fc-cat-back">ƒê·ªãnh nghƒ©a</div>
                            <div class="fc-content" id="fc-a">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>
                <div class="fc-controls" id="fc-controls-area">
                    <button class="btn-fc btn-fc-review" onclick="nextCard(false); playSFX('click')">C·∫ßn √¥n l·∫°i üß†</button>
                    <button class="btn-fc btn-fc-master" onclick="nextCard(true); playSFX('success')">ƒê√£ thu·ªôc ‚úÖ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const THEMES = {
            morning: { emoji: "üå§Ô∏è", type: "local", bg: "media/8.mp4", track: "S·ªõm Mai", color: "#f3a683", audio: "audio/a2.m4a" }, 
            rain: { emoji: "üåßÔ∏è", type: "local", bg: "media/2.mp4", track: "Ng√†y M∆∞a", color: "#546de5", audio: "audio/a1.m4a" }, 
            cafe: { emoji: "‚òï", type: "local", bg: "media/4.mp4", track: "Qu√°n C√† Ph√™", color: "#cf6a87", audio: "audio/a5.mp3" }, 
            forest: { emoji: "üå≤", type: "local", bg: "media/3.mp4", track: "R·ª´ng S√¢u", color: "#63cdda", audio: "audio/a7.m4a" },
            sunset: { emoji: "üåá", type: "local", bg: "media/5.mp4", track: "Ho√†ng H√¥n", color: "#e77f67", audio: "audio/a4.m4a" }, 
            night: { emoji: "üåô", type: "local", bg: "media/6.mp4", track: "B·∫ßu Tr·ªùi ƒê√™m", color: "#596275", audio: "audio/a3.m4a" }, 
            library: { emoji: "üìö", type: "local", bg: "media/7.mp4", track: "Th∆∞ Vi·ªán", color: "#d1d8e0", audio: "audio/a6.m4a" }
        };
        
        const BUDDIES = {
            lofi: { type: "local", url: "media/lofigirl-loop-audio.mp4", name: "Lofi Girl (B·∫£n Local)", thumb: "https://img.youtube.com/vi/jfKfPfyJRdk/0.jpg" }
        };
        const LEARNING_DATABASE = {
            "Ti·∫øng Anh": { "C∆° b·∫£n": [{ q: "Hello", a: "Xin ch√†o" }, { q: "Apple", a: "Qu·∫£ t√°o" }], "IELTS": [{ q: "Serendipity", a: "S·ª± t√¨nh c·ªù may m·∫Øn" }] },
            "C√¥ng ngh·ªá": { "HTML": [{ q: "<div>", a: "Th·∫ª t·∫°o kh·ªëi" }] }
        };
        const ZEN_QUOTES = ["H√≠t v√†o s·ª± b√¨nh y√™n...", "B·∫°n l√†m t·ªët l·∫Øm...", "Ngh·ªâ ng∆°i x√≠u nh√©...", "H√£y nh·∫π nh√†ng v·ªõi b·∫£n th√¢n."];

        let studyQueue = [], masteredCount = 0, totalCards = 0, currentSubject = "", currentLevel = "";
        const exploreGrid = document.getElementById('explore-grid'), buddyGrid = document.getElementById('buddy-grid'), root = document.documentElement;
        const videoContainer = document.getElementById('video-bg-container');
        const ambientPlayer = document.getElementById('ambient-audio');
        
        let isAmbientMuted = false; 
        let lastAmbientVolume = 0.5;

        let youtubeAudioPlayer = null;
        let isYouTubeAudioPlaying = false;
        let currentExternalType = null; 
        let isExternalMuted = false;
        let lastExternalVolume = 50;
        let isYouTubeReady = false; 

        let isExclusiveMode = false;
        let pendingYouTubeId = null; 

        function toggleUpdateLog() {
            const modal = document.getElementById('update-log-modal');
            modal.classList.toggle('active');
        }

        // --- REAL TIME CLOCK ---
        function updateRealTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('real-time-clock').innerText = timeString;
        }
        setInterval(updateRealTime, 1000);

        // --- FIRE EFFECT FUNCTION ---
        function triggerFireEffect(e) {
            const numSparks = 12; 
            const container = document.body;
            for (let i = 0; i < numSparks; i++) {
                const spark = document.createElement('div');
                spark.classList.add('spark-particle');
                spark.style.left = e.clientX + 'px';
                spark.style.top = e.clientY + 'px';
                const angle = Math.random() * Math.PI * 2;
                const distance = 60 + Math.random() * 60; 
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                spark.style.setProperty('--tx', `${tx}px`);
                spark.style.setProperty('--ty', `${ty}px`);
                container.appendChild(spark);
                setTimeout(() => spark.remove(), 800);
            }
        }

        function toggleAudioMode() {
            isExclusiveMode = document.getElementById('audio-exclusive-mode').checked;
            checkExclusiveState();
        }

        function checkExclusiveState() {
            const controls = document.getElementById('local-player-controls');
            const isExternalPlaying = isYouTubeAudioPlaying || currentExternalType === 'soundcloud';
            
            if (isExclusiveMode && isExternalPlaying) {
                ambientPlayer.pause();
                controls.classList.add('disabled-controls');
            } else {
                controls.classList.remove('disabled-controls');
                if (ambientPlayer.paused && !isAmbientMuted) {
                    ambientPlayer.play().catch(e=>{});
                }
            }
        }

        function toggleBlur() {
            const isChecked = document.getElementById('blur-toggle').checked;
            const val = document.getElementById('blur-slider').value;
            const video = document.getElementById('video-bg-container');
            video.style.filter = isChecked ? `blur(${val}px)` : 'none';
        }

        function changeBlur(val) {
            const toggle = document.getElementById('blur-toggle');
            if (!toggle.checked) toggle.checked = true;
            const video = document.getElementById('video-bg-container');
            video.style.filter = `blur(${val}px)`;
        }

        function onYouTubeIframeAPIReady() {
            youtubeAudioPlayer = new YT.Player('youtube-audio-container', {
                height: '0', width: '0',
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1 },
                events: { 'onReady': onPlayerReady }
            });
        }
        
        function onPlayerReady(event) {
            isYouTubeReady = true; 
            if (pendingYouTubeId) {
                loadCustomEmbed();
            }
        }

        function playSFX(type) {
            const sound = document.getElementById(`sfx-${type}`);
            if(sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
        }

        document.addEventListener('touchstart', function() {
            if (ambientPlayer.paused && !isYouTubeAudioPlaying) { 
                ambientPlayer.play().then(() => ambientPlayer.pause());
            }
        }, { once: true });

        function toggleSpotifyInput() {
            const group = document.getElementById('spotify-input-group');
            group.style.display = group.style.display === 'flex' ? 'none' : 'flex';
        }

        function getYouTubeId(url) {
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }

        function stopExternalMusic() {
            const btn = document.getElementById('btn-ext-stop');
            const extControls = document.getElementById('external-audio-controls');
            
            document.getElementById('embed-container').innerHTML = '';
            document.getElementById('embed-container').style.display = 'none';
            btn.style.display = 'none';
            extControls.style.display = 'none';
            currentExternalType = null;
            
            if (youtubeAudioPlayer && isYouTubeAudioPlaying) {
                youtubeAudioPlayer.stopVideo();
                isYouTubeAudioPlaying = false;
            }
            
            checkExclusiveState();
        }

        function loadCustomEmbed() {
            let url = document.getElementById('spotify-url').value.trim();
            const container = document.getElementById('embed-container');
            const stopBtn = document.getElementById('btn-ext-stop');
            const extControls = document.getElementById('external-audio-controls');
            
            if(!url) return; 

            const youtubeId = getYouTubeId(url);
            
            // YOUTUBE LOGIC
            if (youtubeId) {
                if(!isYouTubeReady || !youtubeAudioPlayer || !youtubeAudioPlayer.loadVideoById) {
                    pendingYouTubeId = youtubeId;
                    container.innerHTML = `<div style="padding:10px; font-size:12px; color:var(--accent-color); background:rgba(255,255,255,0.8); border-radius:8px; text-align:center;">‚è≥ ƒêang k·∫øt n·ªëi YouTube...</div>`;
                    container.style.display = 'block';
                    return; 
                }

                youtubeAudioPlayer.loadVideoById(youtubeId);
                youtubeAudioPlayer.setVolume(lastExternalVolume);
                isYouTubeAudioPlaying = true;
                currentExternalType = 'youtube';
                
                container.innerHTML = `<div style="padding:15px; font-size:13px; font-weight:bold; color:var(--accent-color); background:rgba(255,255,255,0.8); border-radius:12px; text-align:center;"><i class="fa-brands fa-youtube" style="color:red;"></i> ƒêang ph√°t t·ª´ YouTube...</div>`;
                container.style.display = 'block';
                stopBtn.style.display = 'inline-block';
                extControls.style.display = 'block'; 
                
                checkExclusiveState();
                pendingYouTubeId = null;
                return;
            }
            
            // SOUNDCLOUD LOGIC
            let embedSrc = "";
            if (url.includes('soundcloud.com')) {
                const encodedUrl = encodeURIComponent(url);
                embedSrc = `https://w.soundcloud.com/player/?url=${encodedUrl}&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
                currentExternalType = 'soundcloud';
                extControls.style.display = 'none'; 
            } 
            
            if(embedSrc) {
                container.innerHTML = `<iframe src="${embedSrc}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                container.style.display = 'block';
                stopBtn.style.display = 'inline-block';
                checkExclusiveState();
            }
        }

        window.addEventListener('load', () => {
             document.getElementById('spotify-url').value = "";
             pendingYouTubeId = null;
             updateRealTime(); // Start clock immediately
        });

        // --- AMBIENT CONTROLS ---
        function changeAmbientVolume(val) {
            ambientPlayer.volume = val;
            isAmbientMuted = (val == 0);
            if (!isAmbientMuted) lastAmbientVolume = val;
            updateAmbientIcon();
        }

        function toggleAmbientMute() {
            if (ambientPlayer.muted || ambientPlayer.volume === 0) {
                ambientPlayer.muted = false;
                ambientPlayer.volume = lastAmbientVolume > 0 ? lastAmbientVolume : 0.5;
                document.getElementById('volume-slider').value = ambientPlayer.volume;
                ambientPlayer.play().catch(e => {});
                isAmbientMuted = false;
            } else {
                ambientPlayer.muted = true;
                document.getElementById('volume-slider').value = 0;
                isAmbientMuted = true;
            }
            updateAmbientIcon();
        }

        function updateAmbientIcon() {
            const btn = document.getElementById('mute-btn');
            if (isAmbientMuted || ambientPlayer.muted || ambientPlayer.volume === 0) { 
                btn.className = 'fa-solid fa-volume-xmark'; 
            } else if (ambientPlayer.volume < 0.5) { 
                btn.className = 'fa-solid fa-volume-low'; 
            } else { 
                btn.className = 'fa-solid fa-volume-high'; 
            }
        }

        // --- EXTERNAL CONTROLS (YOUTUBE) ---
        function changeExternalVolume(val) {
            lastExternalVolume = val;
            if(youtubeAudioPlayer && isYouTubeAudioPlaying) {
                youtubeAudioPlayer.setVolume(val);
                isExternalMuted = (val == 0);
                updateExternalIcon();
            }
        }

        function toggleExternalMute() {
            if(youtubeAudioPlayer && isYouTubeAudioPlaying) {
                if (youtubeAudioPlayer.isMuted()) {
                    youtubeAudioPlayer.unMute();
                    youtubeAudioPlayer.setVolume(lastExternalVolume);
                    document.getElementById('ext-volume-slider').value = lastExternalVolume;
                    isExternalMuted = false;
                } else {
                    youtubeAudioPlayer.mute();
                    document.getElementById('ext-volume-slider').value = 0;
                    isExternalMuted = true;
                }
                updateExternalIcon();
            }
        }

        function updateExternalIcon() {
            const btn = document.getElementById('ext-mute-btn');
            if(isExternalMuted) btn.className = 'fa-solid fa-volume-xmark';
            else btn.className = 'fa-solid fa-volume-high';
        }

        function switchView(view) {
            document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
            if(view === 'myspace') {
                document.getElementById('btn-myspace').classList.add('active');
                document.body.classList.remove('focus-active');
            } else if (view === 'focus') {
                document.getElementById('btn-focus').classList.add('active');
                document.body.classList.add('focus-active');
            }
        }

        function initApp() { 
            initExplore(); initLearningDropdowns(); updateDisplay(); updateCount(); 
            ambientPlayer.volume = 0.5; 
            document.getElementById('volume-slider').value = 0.5; 
            updateAmbientIcon();
        }

        function initLearningDropdowns() {
            const subjectSelect = document.getElementById('subject-select');
            const levelSelect = document.getElementById('level-select');
            subjectSelect.innerHTML = '';
            if(Object.keys(LEARNING_DATABASE).length === 0) {
                const opt = document.createElement('option'); opt.innerText = "Tr·ªëng"; subjectSelect.appendChild(opt);
                levelSelect.innerHTML = ''; return;
            }
            Object.keys(LEARNING_DATABASE).forEach(sub => {
                const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub;
                subjectSelect.appendChild(opt);
            });
            subjectSelect.onchange = () => {
                currentSubject = subjectSelect.value;
                if(!LEARNING_DATABASE[currentSubject]) return;
                const levels = Object.keys(LEARNING_DATABASE[currentSubject]);
                levelSelect.innerHTML = '';
                levels.forEach(lvl => {
                    const opt = document.createElement('option'); opt.value = lvl; opt.innerText = lvl;
                    levelSelect.appendChild(opt);
                });
                changeTopic();
            };
            levelSelect.onchange = changeTopic;
            subjectSelect.dispatchEvent(new Event('change'));
        }

        function changeTopic() {
            currentSubject = document.getElementById('subject-select').value;
            currentLevel = document.getElementById('level-select').value;
            if(!currentSubject || !currentLevel) {
                studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                return;
            }
            const originalCards = LEARNING_DATABASE[currentSubject][currentLevel];
            studyQueue = JSON.parse(JSON.stringify(originalCards));
            totalCards = studyQueue.length;
            masteredCount = 0;
            renderCard();
        }

        function toggleAddSubjectForm() { hideAllForms(); const f=document.getElementById('add-subject-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddLevelForm() { hideAllForms(); const f=document.getElementById('add-level-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddCardForm() { hideAllForms(); const f=document.getElementById('add-card-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function hideAllForms() {
            document.getElementById('add-subject-form').style.display='none';
            document.getElementById('add-level-form').style.display='none';
            document.getElementById('add-card-form').style.display='none';
        }

        function saveNewSubject() {
            const subName = document.getElementById('new-subject-name').value;
            const subLevel = document.getElementById('new-subject-level').value;
            if(subName && subLevel) {
                LEARNING_DATABASE[subName] = {}; LEARNING_DATABASE[subName][subLevel] = [];
                initLearningDropdowns();
                const subSelect = document.getElementById('subject-select'); subSelect.value = subName; subSelect.dispatchEvent(new Event('change'));
                document.getElementById('new-subject-name').value=''; document.getElementById('new-subject-level').value=''; toggleAddSubjectForm();
                playSFX('success');
            }
        }

        function saveNewLevel() {
            const newLvl = document.getElementById('new-level-name').value;
            if(newLvl && currentSubject) {
                LEARNING_DATABASE[currentSubject][newLvl] = [];
                const levelSelect = document.getElementById('level-select');
                const opt = document.createElement('option'); opt.value = newLvl; opt.innerText = newLvl;
                levelSelect.appendChild(opt);
                levelSelect.value = newLvl; 
                changeTopic();
                document.getElementById('new-level-name').value=''; toggleAddLevelForm();
                playSFX('success');
            }
        }

        function saveCustomCard() {
            const q = document.getElementById('new-card-q').value, a = document.getElementById('new-card-a').value;
            if(q && a) {
                LEARNING_DATABASE[currentSubject][currentLevel].push({q:q, a:a});
                studyQueue.push({q:q, a:a}); totalCards++;
                
                if (studyQueue.length === 1 && totalCards === 1) {
                    masteredCount = 0;
                    renderCard();
                } else {
                    document.getElementById('new-card-q').value=''; 
                    document.getElementById('new-card-a').value=''; 
                    toggleAddCardForm(); 
                    renderCard();
                }
                playSFX('success');
            }
        }

        function deleteSubject() {
            const sub = document.getElementById('subject-select').value;
            if(!sub || sub === "Tr·ªëng") return;
            if(confirm(`X√≥a m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub];
                initLearningDropdowns();
                if(Object.keys(LEARNING_DATABASE).length === 0) {
                    studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                }
            }
        }

        function deleteLevel() {
            const sub = document.getElementById('subject-select').value;
            const lvl = document.getElementById('level-select').value;
            if(!sub || !lvl) return;
            if(confirm(`X√≥a c·∫•p ƒë·ªô "${lvl}" c·ªßa m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub][lvl];
                document.getElementById('subject-select').dispatchEvent(new Event('change'));
            }
        }

        function deleteCurrentCard(event) {
            event.stopPropagation();
            if (studyQueue.length === 0) return;
            if(!confirm("X√≥a th·∫ª n√†y?")) return;
            const currentCard = studyQueue[0];
            const dbList = LEARNING_DATABASE[currentSubject][currentLevel];
            const index = dbList.findIndex(c => c.q === currentCard.q && c.a === currentCard.a);
            if(index > -1) dbList.splice(index, 1);
            studyQueue.shift(); totalCards--; renderCard();
        }

        function renderCard() {
            const container = document.querySelector('.flashcard-container');
            const controlsArea = document.getElementById('fc-controls-area');
            
            container.classList.remove('flipped');
            
            setTimeout(() => {
                if (studyQueue.length === 0) {
                    const isEmpty = totalCards === 0;
                    document.getElementById('fc-cat-front').innerText = currentSubject || "Tr·ªëng";
                    document.getElementById('fc-q').innerText = isEmpty ? "Ch∆∞a c√≥ th·∫ª n√†o" : "ƒê√£ xong!";
                    document.getElementById('fc-cat-back').innerText = "";
                    document.getElementById('fc-a').innerText = isEmpty ? "B·∫•m + ƒë·ªÉ th√™m" : "B·∫°n ƒë√£ h·ªçc h·∫øt b·ªô n√†y!";
                    
                    if (!isEmpty) {
                        controlsArea.innerHTML = `<button class="btn-fc btn-fc-restart" onclick="resetLearning(); playSFX('click')">H·ªçc l·∫°i t·ª´ ƒë·∫ßu ‚Ü∫</button>`;
                    } else {
                        controlsArea.innerHTML = '';
                    }
                    return;
                }
                
                controlsArea.innerHTML = `
                    <button class="btn-fc btn-fc-review" onclick="nextCard(false); playSFX('click')">C·∫ßn √¥n l·∫°i üß†</button>
                    <button class="btn-fc btn-fc-master" onclick="nextCard(true); playSFX('success')">ƒê√£ thu·ªôc ‚úÖ</button>
                `;
                
                const current = studyQueue[0];
                document.getElementById('fc-cat-front').innerText = currentSubject;
                document.getElementById('fc-q').innerText = current.q;
                document.getElementById('fc-cat-back').innerText = currentLevel;
                document.getElementById('fc-a').innerText = current.a;
            }, 200);
            
            const percent = totalCards > 0 ? (masteredCount / totalCards) * 100 : 0;
            document.getElementById('fc-bar').style.width = `${percent}%`;
            document.getElementById('mini-fc').innerText = `${masteredCount}/${totalCards} Done`;
        }

        function flipCard(el) { if (studyQueue.length > 0) { el.classList.toggle('flipped'); playSFX('click'); } }
        
        function nextCard(isMastered) {
            if (studyQueue.length === 0) return;
            document.querySelector('.flashcard-container').classList.remove('flipped');
            setTimeout(() => {
                const card = studyQueue.shift();
                if (isMastered) masteredCount++; else studyQueue.push(card);
                renderCard();
            }, 300);
        }
        
        function resetLearning() { changeTopic(); }

        function initExplore() {
            exploreGrid.innerHTML = '';
            for (const key in THEMES) {
                const item = document.createElement('div');
                item.className = 'explore-item'; 
                item.innerText = THEMES[key].emoji;
                item.onclick = (e) => { e.stopPropagation(); setTheme(key); playSFX('click'); }; item.id = `theme-${key}`;
                exploreGrid.appendChild(item);
            }
            buddyGrid.innerHTML = '';
            for (const key in BUDDIES) {
                const item = document.createElement('div');
                item.className = 'buddy-item'; item.style.backgroundImage = `url('${BUDDIES[key].thumb}')`;
                item.innerHTML = `<div class="buddy-name">${BUDDIES[key].name}</div>`;
                item.onclick = (e) => { e.stopPropagation(); setBodyDoubling(key); playSFX('click'); }; item.id = `buddy-${key}`;
                buddyGrid.appendChild(item);
            }
        }

        let transitionTimeout;

        function setTheme(key) {
            const data = THEMES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);

            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `<video id="bg-video-player" autoplay muted loop playsinline><source src="${data.bg}" type="video/mp4"></video>`;
                    vidContainer.classList.add('active');
                    document.body.style.backgroundImage = 'none';
                }
                
                if (key === 'morning' || key === 'forest' || key === 'rain' || key === 'cafe' || key === 'sunset') {
                    document.documentElement.style.setProperty('--text-main', '#333');
                    document.documentElement.style.setProperty('--btn-text-color', '#fff');
                } else {
                    document.documentElement.style.setProperty('--text-main', '#fff');
                    document.documentElement.style.setProperty('--btn-text-color', '#333');
                }
                
                document.body.style.backgroundColor = '#111'; 
                root.style.setProperty('--accent-color', data.color);
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = data.track;
                
                const art = document.getElementById('album-art');
                art.style.backgroundImage = 'none';
                art.innerHTML = data.emoji;

                if(!isYouTubeAudioPlaying) {
                    ambientPlayer.src = data.audio;
                    if (!ambientPlayer.muted && ambientPlayer.volume > 0) { 
                        ambientPlayer.play().catch(e => {}); 
                    }
                }

                resetStates(); document.getElementById(`theme-${key}`).classList.add('active'); 
                document.getElementById(`theme-${key}`).style.backgroundColor = data.color;
            }, 800);
        }

        function setBodyDoubling(key) {
            const data = BUDDIES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);
            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `<video id="bg-video-player" autoplay muted loop playsinline><source src="${data.url}" type="video/mp4"></video>`;
                    vidContainer.classList.add('active');
                    document.body.style.backgroundImage = 'none';
                }
                resetStates(); document.getElementById(`buddy-${key}`).classList.add('active');
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = `H·ªçc c√πng ${data.name}`;
            }, 800);
        }

        function resetStates() {
            document.querySelectorAll('.explore-item').forEach(el => { el.classList.remove('active'); el.style.backgroundColor = ''; el.style.boxShadow = ''; });
            document.querySelectorAll('.buddy-item').forEach(el => el.classList.remove('active'));
        }

        function selectMood(m) { 
            setTheme(m); 
            document.getElementById('intro-overlay').classList.add('hidden-intro');
            document.getElementById('main-nav').classList.add('visible');
        }
        function togglePanel(id) { document.getElementById(id).classList.toggle('collapsed'); }
        
        let zenInt, totalMin = 0;
        function openZenMode() { document.getElementById('zen-overlay').classList.add('active'); document.getElementById('zen-circle').classList.add('breathing-anim'); document.getElementById('zen-quote').innerText = `"${ZEN_QUOTES[Math.floor(Math.random()*ZEN_QUOTES.length)]}"`; updateBreath(); zenInt=setInterval(updateBreath,8000); }
        function updateBreath() { const t=document.getElementById('zen-text'); t.innerText="H√≠t s√¢u..."; setTimeout(()=>t.innerText="Gi·ªØ...",3500); setTimeout(()=>t.innerText="Th·ªü ra...",4500); }
        function closeZenMode() { document.getElementById('zen-overlay').classList.remove('active'); document.getElementById('zen-circle').classList.remove('breathing-anim'); clearInterval(zenInt); }

        const MODES = { pomodoro: 25, short: 5, long: 15 };
        let timeLeft = 25*60, timerInt, isRunning=false;
        function updateDisplay() { 
            const m=Math.floor(timeLeft/60).toString().padStart(2,'0'), s=(timeLeft%60).toString().padStart(2,'0'); 
            document.getElementById('timer-text').innerText=`${m}:${s}`; document.getElementById('mini-timer').innerText=`${m}:${s}`; document.title=isRunning?`(${m}:${s}) ƒêang t·∫≠p trung...`:"Kh√¥ng gian Chill";
        }
        function toggleTimer() {
            if(isRunning) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; }
            else { isRunning=true; document.getElementById('btn-action').textContent="T·∫°m d·ª´ng"; timerInt=setInterval(()=>{ if(timeLeft>0){ timeLeft--; updateDisplay(); if(timeLeft%60===0) totalMin++; if(totalMin>60){ if(confirm("B·∫°n ƒë√£ h·ªçc l√¢u r·ªìi, ngh·ªâ ng∆°i ch√∫t nh√©?")){openZenMode(); toggleTimer(); totalMin=0;} else totalMin=0; } } else { clearInterval(timerInt); isRunning=false; alert("H·∫øt gi·ªù r·ªìi!"); playSFX('alarm'); } },1000); }
        }
        function switchMode(m) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=MODES[m]*60; document.getElementById('custom-minutes').value=MODES[m]; updateDisplay(); document.querySelectorAll('.timer-controls span').forEach(el=>el.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); }
        function adjustTime(a) { let v=parseInt(document.getElementById('custom-minutes').value)||0; v+=a; if(v<1)v=1; document.getElementById('custom-minutes').value=v; }
        function applyCustomTime() { const v=parseInt(document.getElementById('custom-minutes').value); if(v>0){ clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=v*60; updateDisplay(); } }

        const taskInput = document.getElementById('new-task-input'), taskList = document.getElementById('task-list');
        function showInput() { document.getElementById('btn-show-add').style.display='none'; document.getElementById('input-group').style.display='flex'; taskInput.focus(); }
        function addTask() { if(!taskInput.value.trim()) return; const li=document.createElement('li'); li.className='task-item'; li.innerHTML=`<input type="checkbox" class="task-checkbox" onclick="toggleTask(this)"> <span class="task-text">${taskInput.value}</span> <i class="fa-solid fa-trash-can delete-btn" onclick="this.parentElement.remove(); updateCount()" style="color:#ffb8b8; cursor:pointer;"></i>`; taskList.appendChild(li); taskInput.value=''; document.getElementById('input-group').style.display='none'; document.getElementById('btn-show-add').style.display='flex'; updateCount(); }
        function toggleTask(cb) { cb.parentElement.classList.toggle('completed', cb.checked); if(cb.checked) playSFX('success'); else playSFX('click'); }
        taskInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addTask()});
        function updateCount() { document.getElementById('task-count').innerText=`(${taskList.children.length})`; }

        initApp();
    </script>
</body>
</html>