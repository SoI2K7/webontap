<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kh√¥ng Gian Chill - v16.5 Restored</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CORE CSS (CHU·∫®N v14.2) --- */
        :root {
            --card-bg: rgba(255, 255, 255, 0.25);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --text-main: #fff; 
            --text-sub: #eee;
            --accent-color: #a29bfe;
            --correct-color: #00b894;
            --wrong-color: #ff7675;
            --radius: 24px;
            --font-main: 'Quicksand', sans-serif;
            --btn-text-color: #fff;
        }

        select, input { color: #333 !important; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        
        body {
            height: 100vh; width: 100vw; overflow: hidden; background-color: #111; 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            display: flex; justify-content: space-between; padding: 25px;
            color: var(--text-main); 
            transition: background-image 1s ease-in-out, background-color 1s ease;
            position: relative;
        }

        /* Video Background */
        #video-bg-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
            z-index: 0; overflow: hidden; background-color: #000; pointer-events: none;
            opacity: 0; transition: opacity 1s ease-in-out, filter 0.5s ease;
        }
        #video-bg-container.active { opacity: 1; }
        
        #bg-video-player {
            position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%;
            width: auto; height: auto; transform: translate(-50%, -50%);
            object-fit: cover; width: 100vw; height: 100dvh; 
        }

        /* UI Layers */
        .left-sidebar, .right-area, .top-nav-container {
            position: relative; z-index: 10; pointer-events: auto;
        }

        /* --- NAV BAR (STYLE v14.2) --- */
        .top-nav-container {
            position: absolute;
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: var(--glass-border); box-shadow: var(--glass-shadow);
            top: 25px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 12px; padding: 10px; 
            border-radius: 50px; z-index: 999;
            transition: all 0.5s ease; opacity: 0; pointer-events: none;
            align-items: center; 
        }
        .top-nav-container.visible { opacity: 1; pointer-events: auto; }

        .nav-pill {
            padding: 10px 24px;
            border-radius: 30px; 
            font-weight: 700; font-size: 14px; cursor: pointer; color: #333; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            line-height: 1.2; 
        }
        
        .nav-pill.active { 
            background: var(--accent-color); 
            color: white; 
            transform: translateY(-4px); 
            box-shadow: 0 8px 20px rgba(162, 155, 254, 0.6); 
        }

        .nav-clock {
            background: rgba(0,0,0,0.5); color: #fff; cursor: default;
            font-variant-numeric: tabular-nums; border: 1px solid rgba(255,255,255,0.2);
            transform: none !important; box-shadow: none !important;
        }

        .nav-pill.fire-effect {
            background: linear-gradient(135deg, #ff4d4d, #ff9f43);
            color: white; font-weight: 800;
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.6);
            animation: firePulse 1.5s infinite alternate;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        @keyframes firePulse {
            0% { box-shadow: 0 0 10px rgba(255, 77, 77, 0.5); transform: scale(1); }
            100% { box-shadow: 0 0 25px rgba(255, 159, 67, 0.8); transform: scale(1.05); }
        }

        /* --- INTRO OVERLAY (FIXED) --- */
        #intro-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(30px); 
            z-index: 99999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 0.5s ease; 
        }
        #intro-overlay.hidden-intro { 
            opacity: 0; pointer-events: none; display: none !important; 
        }

        /* --- ZEN OVERLAY (SOS) --- */
        #zen-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(20, 40, 50, 0.95); z-index: 10000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            color: white; 
        }
        #zen-overlay.active { display: flex; }
        .breathing-circle { width: 200px; height: 200px; background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%); border-radius: 50%; box-shadow: 0 0 50px rgba(168, 230, 207, 0.4); margin-bottom: 80px; transform: scale(1); }
        .breathing-anim { animation: breathe 8s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.35); opacity: 1; } }

        /* --- PANEL STYLES --- */
        .cozy-panel { background: var(--card-bg); backdrop-filter: blur(20px) saturate(150%); -webkit-backdrop-filter: blur(20px) saturate(150%); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: var(--radius); transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; position: relative; overflow: hidden; height: auto; min-height: fit-content; flex-shrink: 0; pointer-events: auto; color: white; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 20px 25px; min-height: 70px; }
        .panel-header h3 { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: 18px; }
        .toggle-btn { color: rgba(255,255,255,0.9); }
        .panel-content { transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); opacity: 1; max-height: 800px; padding: 0 25px 25px 25px; overflow: hidden; }
        .cozy-panel.collapsed .toggle-btn { transform: rotate(180deg); }
        .cozy-panel.collapsed .panel-content { opacity: 0; max-height: 0; padding: 0 25px; margin: 0; }
        .cozy-panel.collapsed { flex-grow: 0 !important; height: auto !important; padding-bottom: 0 !important; }
        .mini-display { font-size: 14px; margin-left: auto; margin-right: 15px; font-weight: bold; color: var(--accent-color); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; display: flex; align-items: center; gap: 6px; }
        .cozy-panel.collapsed .mini-display { opacity: 1; }

        .left-sidebar, .right-area { width: 360px; display: flex; flex-direction: column; gap: 15px; max-height: 100%; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 10px; }
        :hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.8); }

        /* --- QUIZ STYLES (ƒê∆∞·ª£c l√†m to ra) --- */
        .quiz-option-btn { width: 100%; padding: 15px 20px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 16px; color: #333; font-weight: 600; font-size: 15px; cursor: pointer; text-align: left; transition: all 0.2s ease; position: relative; overflow: hidden; display: flex; align-items: center; }
        .quiz-option-btn:hover { background: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .quiz-option-btn.correct { background: var(--correct-color) !important; color: white !important; border-color: var(--correct-color) !important; }
        .quiz-option-btn.wrong { background: var(--wrong-color) !important; color: white !important; border-color: var(--wrong-color) !important; }
        .quiz-score-badge { background: var(--accent-color); color: white; padding: 5px 10px; border-radius: 12px; font-size: 14px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        .quiz-question-text { font-size: 20px; font-weight: bold; margin-bottom: 25px; line-height: 1.5; min-height: 60px; }

        /* --- QUIZ MODE STYLES (·∫®n hi·ªán) --- */
        body.quiz-active .left-sidebar { display: none !important; }
        body.quiz-active #panel-timer { display: none !important; }
        body.quiz-active #panel-flashcards { display: none !important; }
        body.quiz-active .right-area { 
            width: 100%; 
            align-items: center; 
            justify-content: center;
            height: 100%;
        }
        body.quiz-active #panel-quiz {
            display: flex !important;
            width: 80%;
            max-width: 800px;
            transform: scale(1.05); /* Ph√≥ng to nh·∫π */
        }
        
        /* Intro & Elements */
        .intro-content { text-align: center; background: rgba(255, 255, 255, 0.9); padding: 40px 60px; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 800px; width: 90%; animation: float 3s ease-in-out infinite; color: #333;}
        .intro-title { font-size: 36px; font-weight: 700; color: #333; margin-bottom: 10px; }
        .intro-sub { font-size: 16px; color: #666; margin-bottom: 30px; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .mood-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; transition: all 0.3s ease; }
        .mood-icon { font-size: 32px; }
        .mood-text { font-weight: 700; color: #333; font-size: 14px;}
        .mood-btn:hover { transform: translateY(-5px); background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 10px 20px rgba(143, 170, 194, 0.3); }
        .mood-btn:hover .mood-text { color: white; }

        .zen-instruction { font-size: 24px; font-weight: 300; margin-bottom: 20px; letter-spacing: 2px; }
        .zen-quote { font-size: 18px; font-style: italic; max-width: 600px; text-align: center; line-height: 1.6; opacity: 0.9; margin-bottom: 40px; }
        .btn-close-zen { padding: 12px 30px; border: 2px solid rgba(255,255,255,0.3); border-radius: 30px; background: transparent; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-close-zen:hover { background: white; color: #333; }

        /* Other common styles */
        .explore-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; padding-bottom: 5px;}
        .explore-item { font-size: 26px; cursor: pointer; text-align: center; padding: 8px; border-radius: 16px; background: rgba(255,255,255,0.5); transition: all 0.3s; }
        .explore-item.active { background: var(--accent-color); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .buddy-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .buddy-item { position: relative; height: 70px; border-radius: 12px; cursor: pointer; overflow: hidden; border: 2px solid transparent; background-size: cover; background-position: center; transition: all 0.3s; }
        .buddy-item:hover { transform: translateY(-4px) scale(1.02) !important; }
        .buddy-item.active { border-color: var(--accent-color); transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .buddy-name { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px; text-align: center; font-weight: bold;}

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; min-height: 100vh; padding: 15px; gap: 20px; justify-content: flex-start; padding-top: 70px; }
            .top-nav-container { 
                position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-150%); margin-bottom: 0; 
                flex-wrap: nowrap; justify-content: flex-start; 
                width: 95%; max-width: 500px; 
                transition: transform 0.5s ease, opacity 0.5s ease; opacity: 0; pointer-events: none; 
                box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
                overflow-x: auto; /* Scroll ngang */
                padding: 10px; 
            }
            .top-nav-container::-webkit-scrollbar { display: none; } 
            .top-nav-container.visible { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
            
            .nav-pill { font-size: 11px; padding: 10px 14px; min-height: auto; white-space: nowrap; flex-shrink: 0; }
            .left-sidebar, .right-area { width: 100%; max-height: none; padding: 0; overflow: visible; }
            .cozy-panel { margin-bottom: 15px; width: 100%; }
            #video-bg-container { position: fixed; }
            .btn-tool, .btn-adjust, .btn-fc, .mood-btn { min-height: 44px; }
            .btn-adjust { width: 40px; height: 40px; }
            #intro-overlay .mood-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* Mobile Quiz Mode */
            body.quiz-active .right-area { height: auto; display: flex; flex-direction: column; }
            body.quiz-active #panel-quiz { width: 100%; transform: none; }
        }
        
        /* Utility styles needed for JS */
        .spark-particle { position: fixed; width: 6px; height: 6px; background: radial-gradient(circle, #ffeb3b, #ff5722); border-radius: 50%; pointer-events: none; z-index: 10000; animation: spark-burst 0.8s ease-out forwards; }
        @keyframes spark-burst { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        
        /* ... (C√°c style c∆° b·∫£n kh√°c gi·ªØ nguy√™n nh∆∞ v14.2) ... */
        .timer-display { font-size: 56px; font-weight: 500; text-align: center; margin: 5px 0; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; }
        .timer-controls span { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; color: white; cursor: pointer; }
        .timer-controls span.active { background: white; color: var(--accent-color); }
        .btn-timer { width: 100%; padding: 12px; border: none; border-radius: 16px; background: var(--accent-color); color: white; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}

    </style>
</head>
<body>

    <div id="video-bg-container"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <div id="youtube-audio-container"></div>

    <audio id="ambient-audio" loop></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-alarm" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="intro-overlay">
        <div class="intro-content">
            <div class="intro-title">Ch√†o b·∫°n, h√¥m nay b·∫°n th·∫ø n√†o?</div>
            <div class="intro-sub">Ch·ªçn m·ªôt tr·∫°ng th√°i ƒë·ªÉ thi·∫øt l·∫≠p kh√¥ng gian nh√©!</div>
            <div class="mood-grid">
                <button class="mood-btn" onclick="selectMood('morning'); playSFX('click')"><span class="mood-icon">üå§Ô∏è</span><span class="mood-text">H√†o h·ª©ng</span></button>
                <button class="mood-btn" onclick="selectMood('rain'); playSFX('click')"><span class="mood-icon">ü§Ø</span><span class="mood-text">CƒÉng th·∫≥ng</span></button>
                <button class="mood-btn" onclick="selectMood('library'); playSFX('click')"><span class="mood-icon">üìö</span><span class="mood-text">T·∫≠p trung</span></button>
                <button class="mood-btn" onclick="selectMood('night'); playSFX('click')"><span class="mood-icon">üåô</span><span class="mood-text">Chill & Relax</span></button>
                <button class="mood-btn" onclick="selectMood('sunset'); playSFX('click')"><span class="mood-icon">üé®</span><span class="mood-text">S√°ng t·∫°o</span></button>
                <button class="mood-btn" onclick="selectMood('cafe'); playSFX('click')"><span class="mood-icon">‚òï</span><span class="mood-text">Bu·ªìn ch√°n</span></button>
            </div>
        </div>
    </div>

    <div id="zen-overlay">
        <div class="breathing-circle" id="zen-circle"></div>
        <div class="zen-instruction" id="zen-text">H√≠t s√¢u...</div>
        <div class="zen-quote" id="zen-quote">"..."</div>
        <button class="btn-close-zen" onclick="closeZenMode(); playSFX('click')">M√¨nh ·ªïn r·ªìi, quay l·∫°i th√¥i</button>
    </div>

    <div class="top-nav-container" id="main-nav">
        <div class="nav-pill nav-clock" id="real-time-clock">--:--</div>
        <div class="nav-pill fire-effect" onclick="triggerFireEffect(event); playSFX('click')"><i class="fa-solid fa-fire"></i> L·ª≠a</div>
        <div class="nav-pill active" id="btn-myspace" onclick="switchView('myspace'); playSFX('click')">Kh√¥ng gian</div>
        <div class="nav-pill" id="btn-focus" onclick="switchView('focus'); playSFX('click')">T·∫≠p trung</div>
        <div class="nav-pill" id="btn-quiz" onclick="switchView('quiz'); playSFX('click')"><i class="fa-solid fa-brain"></i> √în t·∫≠p</div>
        <div class="nav-pill sos-btn" onclick="openZenMode(); playSFX('click')">SOS Stress üÜò</div>
    </div>

    <div class="left-sidebar">
        <div class="cozy-panel" id="panel-left">
            <div class="panel-header" onclick="togglePanel('panel-left'); playSFX('click')">
                <h3>Kh√°m ph√° Kh√¥ng gian</h3>
                <div class="mini-display" id="mini-music"><i class="fa-solid fa-music"></i> <span id="mini-track-name">Chill Lofi</span></div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">H√¨nh n·ªÅn & √Çm thanh</p>
                <div class="explore-grid" id="explore-grid"></div>
                
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 12px; font-weight: bold;">L√†m m·ªù n·ªÅn</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="blur-toggle" onchange="toggleBlur()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <input type="range" id="blur-slider" min="0" max="20" value="5" oninput="changeBlur(this.value)">
                </div>

                <p style="font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px;">H·ªçc c√πng B·∫°n b√®</p>
                <div class="buddy-grid" id="buddy-grid"></div>
                <hr style="height: 1px; background: rgba(255,255,255,0.2); margin: 15px 0; border: none;">
                
                <div id="local-player-controls">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div class="album-art" id="album-art">üéµ</div>
                        <div>
                            <p class="track-name" id="track-name" style="font-weight:bold; font-size:14px;">Chill Lofi</p>
                            <p style="font-size: 10px; opacity: 0.8;">√Çm l∆∞·ª£ng m√¥i tr∆∞·ªùng</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-volume-high" id="mute-btn" onclick="toggleAmbientMute(); playSFX('click')" style="cursor: pointer; width: 30px; text-align:center; color: var(--accent-color);"></i>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" title="Ambient Volume" oninput="changeAmbientVolume(this.value)">
                    </div>
                </div>

                <div id="external-audio-controls" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: #eee;">
                        <i class="fa-brands fa-youtube" style="color:red; width:30px; text-align:center; font-size:18px;"></i>
                        <span style="flex-grow:1; font-weight:bold;">Nh·∫°c YouTube</span>
                        <i class="fa-solid fa-volume-high" id="ext-mute-btn" onclick="toggleExternalMute(); playSFX('click')" style="cursor: pointer; width:20px; text-align:center;"></i>
                        <input type="range" id="ext-volume-slider" min="0" max="100" value="50" oninput="changeExternalVolume(this.value)" style="width: 80px;">
                    </div>
                </div>

                <div class="spotify-container" style="margin-top: 10px;">
                    <div class="spotify-toggle" onclick="toggleSpotifyInput(); playSFX('click')" style="font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
                        <i class="fa-brands fa-youtube"></i> Nh·∫≠p link YouTube/SoundCloud
                    </div>
                    <div style="font-size: 10px; color: #eee; margin-bottom: 5px; margin-left: 5px;">(Khuy√™n d√πng SoundCloud ƒë·ªÉ ·ªïn ƒë·ªãnh nh·∫•t)</div>
                    
                    <div id="spotify-input-group" style="display: none; gap: 5px; margin-bottom: 10px;">
                        <input type="text" id="spotify-url" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: none; font-size: 12px; outline: none; background: rgba(255,255,255,0.8); color: #333;" placeholder="D√°n link...">
                        <button onclick="loadCustomEmbed(); playSFX('click')" style="padding: 8px 12px; border: none; border-radius: 8px; color: white; background: #1DB954; font-weight: bold; cursor: pointer; font-size: 12px;">Ph√°t</button>
                        <button id="btn-ext-stop" onclick="stopExternalMusic(); playSFX('click')" style="padding: 8px 12px; border: none; border-radius: 8px; color: white; background: #e74c3c; font-weight: bold; cursor: pointer; font-size: 12px; display: none;"><i class="fa-solid fa-stop"></i></button>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: rgba(255,255,255,0.8);">
                        <span>Ch·∫ø ƒë·ªô: <strong>Tr·ªôn √¢m</strong></span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="audio-exclusive-mode" onchange="toggleAudioMode()">
                            <span class="slider"></span>
                        </label>
                        <span><strong>Ch·ªâ m·ªôt</strong></span>
                    </div>

                    <div id="embed-container"></div>
                </div>

            </div>
        </div>

        <div class="cozy-panel" id="panel-tasks">
            <div class="panel-header" onclick="togglePanel('panel-tasks'); playSFX('click')">
                <h3>Danh s√°ch Vi·ªác <span id="task-count" style="font-size: 14px; opacity: 0.8; font-weight: normal;">(0)</span></h3>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <ul id="task-list"></ul>
                <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div id="btn-show-add" onclick="showInput(); playSFX('click')" style="cursor: pointer;"><i class="fa-solid fa-plus-circle"></i> Th√™m vi·ªác m·ªõi</div>
                    <div id="input-group" style="display:none; gap:5px;">
                        <input type="text" id="new-task-input" placeholder="M·ª•c ti√™u c·ªßa b·∫°n l√† g√¨?" style="flex-grow:1; padding:8px; border:1px solid #eee; border-radius:8px;">
                        <button onclick="addTask(); playSFX('click')" style="padding:5px 10px; background:var(--accent-color); color:white; border:none; border-radius:8px;">Th√™m</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-area">
        <div class="cozy-panel" id="panel-timer">
            <div class="panel-header" onclick="togglePanel('panel-timer'); playSFX('click')">
                <h3>ƒê·ªìng h·ªì</h3>
                <div class="mini-display" id="mini-timer" style="font-size: 18px;">25:00</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <div class="timer-controls">
                    <span id="btn-pomodoro" class="active" onclick="switchMode('pomodoro'); playSFX('click')">T·∫≠p trung</span>
                    <span id="btn-short" onclick="switchMode('short'); playSFX('click')">Ngh·ªâ ng·∫Øn</span>
                    <span id="btn-long" onclick="switchMode('long'); playSFX('click')">Ngh·ªâ d√†i</span>
                </div>
                <div class="timer-display" id="timer-text">25:00</div>
                <button class="btn-timer" id="btn-action" onclick="toggleTimer(); playSFX('click')">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>

        <div class="cozy-panel" id="panel-flashcards">
            <div class="panel-header" onclick="togglePanel('panel-flashcards'); playSFX('click')">
                <h3>H·ªçc Nhanh</h3>
                <div class="mini-display" id="mini-fc">0 Th·∫ª xong</div>
                <i class="fa-solid fa-chevron-up toggle-btn"></i>
            </div>
            <div class="panel-content">
                <div class="learning-filter">
                    <div class="filter-row">
                        <select id="subject-select" class="fc-select"></select>
                    </div>
                    <div class="filter-row">
                        <select id="level-select" class="fc-select"></select>
                    </div>
                </div>

                <div class="flashcard-container" onclick="flipCard(this); playSFX('click')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div class="fc-category" id="fc-cat-front">Danh m·ª•c</div>
                            <div class="fc-content" id="fc-q">ƒêang t·∫£i...</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-top:15px;">(B·∫•m ƒë·ªÉ l·∫≠t)</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="fc-category" id="fc-cat-back">ƒê·ªãnh nghƒ©a</div>
                            <div class="fc-content" id="fc-a">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                </div>
                <div class="fc-controls" id="fc-controls-area">
                    <button class="btn-fc btn-fc-review" onclick="nextCard(false); playSFX('click')">C·∫ßn √¥n l·∫°i üß†</button>
                    <button class="btn-fc btn-fc-master" onclick="nextCard(true); playSFX('success')">ƒê√£ thu·ªôc ‚úÖ</button>
                </div>
            </div>
        </div>

        <div class="cozy-panel" id="panel-quiz" style="display:none;">
            <div class="panel-header" style="cursor: default;">
                <h3><i class="fa-solid fa-robot"></i> Auto-Quiz AI</h3>
                <div class="mini-display" id="quiz-streak" style="opacity: 1; color: var(--accent-color);">Streak: 0 üî•</div>
            </div>
            <div class="panel-content" id="quiz-content-area">
                <div class="quiz-score-badge" id="quiz-category-badge">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                <div class="quiz-question-text" id="quiz-question">Vui l√≤ng ch·ªçn m√¥n h·ªçc b√™n tab "H·ªçc Nhanh" ƒë·ªÉ b·∫Øt ƒë·∫ßu!</div>
                <div id="quiz-options-container">
                    </div>
                <button class="btn-fc btn-fc-restart" onclick="generateQuiz()" style="margin-top:15px; width: 100%;">C√¢u h·ªèi ti·∫øp theo ‚ûù</button>
            </div>
        </div>

    </div>

    <script>
        const THEMES = {
            morning: { emoji: "üå§Ô∏è", type: "local", bg: "media/8.mp4", track: "S·ªõm Mai", color: "#f3a683", audio: "audio/a2.m4a" }, 
            rain: { emoji: "üåßÔ∏è", type: "local", bg: "media/2.mp4", track: "Ng√†y M∆∞a", color: "#546de5", audio: "audio/a1.m4a" }, 
            cafe: { emoji: "‚òï", type: "local", bg: "media/4.mp4", track: "Qu√°n C√† Ph√™", color: "#cf6a87", audio: "audio/a5.mp3" }, 
            forest: { emoji: "üå≤", type: "local", bg: "media/3.mp4", track: "R·ª´ng S√¢u", color: "#63cdda", audio: "audio/a7.m4a" },
            sunset: { emoji: "üåá", type: "local", bg: "media/5.mp4", track: "Ho√†ng H√¥n", color: "#e77f67", audio: "audio/a4.m4a" }, 
            night: { emoji: "üåô", type: "local", bg: "media/6.mp4", track: "B·∫ßu Tr·ªùi ƒê√™m", color: "#596275", audio: "audio/a3.m4a" }, 
            library: { emoji: "üìö", type: "local", bg: "media/7.mp4", track: "Th∆∞ Vi·ªán", color: "#d1d8e0", audio: "audio/a6.m4a" }
        };
        
        const BUDDIES = {
            lofi: { type: "local", url: "media/lofigirl-loop-audio.mp4", name: "Lofi Girl (B·∫£n Local)", thumb: "https://img.youtube.com/vi/jfKfPfyJRdk/0.jpg" }
        };

        const LEARNING_DATABASE = {
            "C∆° s·ªü t·∫°o h√¨nh": {
                "√în t·∫≠p": [
                    { q: "C∆° s·ªü t·∫°o h√¨nh l√† g√¨?", a: "L√† t·∫≠p h·ª£p ki·∫øn th·ª©c c∆° s·ªü n·ªÅn t·∫£ng ƒë∆∞·ª£c nghi√™n c·ª©u s·∫Øp x·∫øp khoa h·ªçc ƒë·∫°t hi·ªáu qu·∫£ th·ªã gi√°c cao." },
                    { q: "Ch·ª©c nƒÉng xung th·∫ßn kinh th·ªã gi√°c l√† g√¨?", a: "Chuy·ªÉn th√¥ng tin t·ªõi b·ªô nh·ªõ gi√°c quan." },
                    { q: "Th·ªã gi√°c l√† g√¨?", a: "Kh·∫£ nƒÉng ti·∫øp nh·∫≠n v√† di·ªÖn gi·∫£i th√¥ng tin t·ª´ √°nh s√°ng truy·ªÅn v√†o m·∫Øt." },
                    { q: "Nh·∫≠n th·ª©c th·ªã gi√°c l√† g√¨?", a: "Kh·∫£ nƒÉng hi·ªÉu n·ªôi dung th√¥ng tin t·ª´ √°nh s√°ng truy·ªÅn v√†o m·∫Øt." },
                    { q: "ƒêi·ªÅu ki·ªán ƒë·∫ßy ƒë·ªß c·∫£m nh·∫≠n th·ªã gi√°c l√† g√¨?", a: "M·∫Øt, √Ånh s√°ng nh√¨n ƒë∆∞·ª£c, T√≠n hi·ªáu h√¨nh ·∫£nh." },
                    { q: "H·ªá th·ªëng x·ª≠ l√Ω th√¥ng tin c·ªßa con ng∆∞·ªùi c√≥ bao nhi√™u c·∫•u tr√∫c ch√≠nh?", a: "3 c·∫•u tr√∫c ch√≠nh (B·ªô nh·ªõ gi√°c quan, B·ªô nh·ªõ l√†m vi·ªác, B·ªô nh·ªõ d√†i h·∫°n)." },
                    { q: "Nhi·ªám v·ª• b·ªô nh·ªõ gi√°c quan l√† g√¨?", a: "L·ªçc th√¥ng tin." },
                    { q: "Nhi·ªám v·ª• b·ªô nh·ªõ l√†m vi·ªác l√† g√¨?", a: "Hi·ªÉu th√¥ng tin." },
                    { q: "Nhi·ªám v·ª• b·ªô nh·ªõ d√†i h·∫°n l√† g√¨?", a: "L∆∞u tr·ªØ th√¥ng tin." },
                    { q: "Quy tr√¨nh nh·∫≠n th·ª©c th·ªã gi√°c c·ªßa con ng∆∞·ªùi?", a: "√Ånh s√°ng -> H√¨nh ·∫£nh -> B·ªô nh·ªõ gi√°c quan -> B·ªô nh·ªõ l√†m vi·ªác -> M√£ h√≥a -> B·ªô nh·ªõ d√†i h·∫°n." },
                    { q: "L·ª±c th·ªã gi√°c l√† g√¨?", a: "S·ª± ch√∫ √Ω, t·∫≠p trung c·ªßa m·∫Øt t·ªõi m·ªôt ƒë·ªëi t∆∞·ª£ng." },
                    { q: "Tr∆∞·ªùng l·ª±c l√† g√¨?", a: "S·ª± h·∫•p d·∫´n t·ªèa ra xung quanh t√≠n hi·ªáu h√¨nh ·∫£nh." },
                    { q: "C∆∞·ªùng l·ª±c th·ªã gi√°c l√† g√¨?", a: "M·ª©c ƒë·ªô l·ªõn nh·ªè c·ªßa tr∆∞·ªùng l·ª±c." },
                    { q: "Tr∆∞·ªùng th·ªã gi√°c c·ªßa con ng∆∞·ªùi l√† g√¨?", a: "Gi·ªõi h·∫°n m·∫Øt ng∆∞·ªùi nh√¨n ƒë∆∞·ª£c trong m·ªôt kh√¥ng gian b·∫•t k·ª≥." },
                    { q: "T·ªïng gi·ªõi h·∫°n tr√°i ‚Äì ph·∫£i c·ªßa tr∆∞·ªùng th·ªã gi√°c con ng∆∞·ªùi?", a: "130 ƒë·ªô (65 tr√°i + 65 ph·∫£i)." },
                    { q: "T·ªïng gi·ªõi h·∫°n tr√™n ‚Äì d∆∞·ªõi c·ªßa tr∆∞·ªùng th·ªã gi√°c con ng∆∞·ªùi?", a: "75 ƒë·ªô (30 tr√™n + 45 d∆∞·ªõi)." },
                    { q: "Tr∆∞·ªùng th·ªã gi√°c quy ∆∞·ªõc ƒë∆∞·ª£c x√°c ƒë·ªãnh nh∆∞ th·∫ø n√†o?", a: "H√¨nh ch√≥p n√≥n ƒë·ªÅu ƒë√°y tr√≤n, g√≥c ·ªü ƒë·ªânh 30 ƒë·ªô." },
                    { q: "C√¢n b·∫±ng th·ªã gi√°c l√† g√¨?", a: "S·ª± s·∫Øp x·∫øp t·∫°o ƒë·ªô nh·∫•n ho·∫∑c s·ª©c cƒÉng th·ªã gi√°c h·ª£p l√Ω cho c√°c y·∫øu t·ªë h√¨nh th·ªÉ." },
                    { q: "Tr·ªçng l∆∞·ª£ng th·ªã gi√°c l√† g√¨?", a: "Kh√≠a c·∫°nh n·∫∑ng nh·∫π c·ªßa h√¨nh ·∫£nh." },
                    { q: "Y·∫øu t·ªë ·∫£nh h∆∞·ªüng t·ªõi c√¢n b·∫±ng th·ªã gi√°c?", a: "T∆∞∆°ng ph·∫£n, h∆∞·ªõng, v·ªã tr√≠." },
                    { q: "C√≥ bao nhi√™u c·∫∑p c√¢n b·∫±ng th·ªã gi√°c?", a: "3 c·∫∑p: Tr√™n-d∆∞·ªõi, Tr√°i-ph·∫£i, Tr∆∞·ªõc-sau." },
                    { q: "H√¨nh d·∫°ng th·ªã gi√°c l√† g√¨?", a: "H√¨nh d·∫°ng v·∫≠t l√Ω ƒë∆∞·ª£c nh√¨n th·∫•y, c√≥ th√¥ng tin v√† c√≥ nghƒ©a." },
                    { q: "C·∫•u tr√∫c t·ª∑ l·ªá ƒë∆°n gi·∫£n th∆∞·ªùng g·∫∑p?", a: "T·ª∑ l·ªá 1/3 v√† T·ª∑ l·ªá v√†ng (1.618)." },
                    { q: "H√¨nh tr√≤n l√† h√¨nh c√≥ h∆∞·ªõng nh∆∞ n√†o?", a: "V√¥ h∆∞·ªõng." },
                    { q: "H√¨nh vu√¥ng v√† h√¨nh ch·ªØ nh·∫≠t c√≥ h∆∞·ªõng nh∆∞ n√†o?", a: "H∆∞·ªõng ƒë·ªëi l·∫≠p." },
                    { q: "H√¨nh l·ª•c gi√°c c√≥ h∆∞·ªõng nh∆∞ n√†o?", a: "ƒêa h∆∞·ªõng." },
                    { q: "H√¨nh ƒë·ªãnh h∆∞·ªõng l√† g√¨?", a: "H√¨nh c√≥ chuy·ªÉn ƒë·ªông r√µ v·ªÅ m·ªôt ph√≠a." },
                    { q: "ƒê·ªãnh h∆∞·ªõng chuy·ªÉn ƒë·ªông th·ªã gi√°c l√† g√¨?", a: "T·ªï ch·ª©c hi·ªáu ·ª©ng h√¨nh ·∫£nh theo h∆∞·ªõng ƒë∆°n tuy·∫øn." },
                    { q: "T·∫°i sao ph·∫£i ƒë·ªãnh h∆∞·ªõng chuy·ªÉn ƒë·ªông th·ªã gi√°c?", a: "ƒê·ªÉ ng∆∞·ªùi xem ti·∫øp nh·∫≠n to√†n b·ªô th√¥ng tin thu·∫≠n l·ª£i nh·∫•t." },
                    { q: "T·∫°i sao sinh vi√™n ƒêa ph∆∞∆°ng ti·ªán c·∫ßn hi·ªÉu h·ªá th·ªëng x·ª≠ l√Ω th√¥ng tin?", a: "ƒê·ªÉ ·ª©ng d·ª•ng ƒë·∫∑c ƒëi·ªÉm ƒë√≥ v√†o thi·∫øt k·∫ø hi·ªáu qu·∫£." },
                    { q: "M·ªëi quan h·ªá gi·ªØa l·ª±c th·ªã gi√°c v√† tr∆∞·ªùng l·ª±c?", a: "T·ªâ l·ªá thu·∫≠n." },
                    { q: "C·∫•u tr√∫c ·∫©n c·ªßa h√¨nh vu√¥ng cho th·∫•y g√¨?", a: "L·ª±c t√¢m m·∫°nh nh·∫•t, gi·∫£m d·∫ßn khi ra xa; tr·ª•c c√≥ xu h∆∞·ªõng c√¢n b·∫±ng." },
                    { q: "L·ª±c th·ªã gi√°c b·ªã chi ph·ªëi b·ªüi g√¨?", a: "M√†u s·∫Øc, t∆∞∆°ng ph·∫£n, k√≠ch th∆∞·ªõc, s·ªë l∆∞·ª£ng, h√¨nh d·∫°ng, chuy·ªÉn ƒë·ªông..." },
                    { q: "M·ªëi quan h·ªá k√≠ch th∆∞·ªõc v√† c∆∞·ªùng ƒë·ªô l·ª±c th·ªã gi√°c?", a: "T·ªâ l·ªá thu·∫≠n." },
                    { q: "Trong c√¢n b·∫±ng th·ªã gi√°c, h√¨nh h∆∞·ªõng l√™n cho c·∫£m gi√°c g√¨?", a: "Nh·∫π." },
                    { q: "Trong c√¢n b·∫±ng th·ªã gi√°c, h√¨nh h∆∞·ªõng xu·ªëng cho c·∫£m gi√°c g√¨?", a: "N·∫∑ng." },
                    { q: "Trong c√¢n b·∫±ng th·ªã gi√°c, v·ªã tr√≠ trung t√¢m cho c·∫£m gi√°c g√¨?", a: "·ªîn ƒë·ªãnh nh·∫•t." },
                    { q: "Trong c√¢n b·∫±ng th·ªã gi√°c, v·ªã tr√≠ l·ªách t√¢m cho c·∫£m gi√°c g√¨?", a: "K√©m c√¢n b·∫±ng, kh√¥ng ·ªïn ƒë·ªãnh." },
                    { q: "Tr·ªçng l∆∞·ª£ng th·ªã gi√°c c·∫∑p tr√™n - d∆∞·ªõi?", a: "D∆∞·ªõi n·∫∑ng h∆°n tr√™n." },
                    { q: "Tr·ªçng l∆∞·ª£ng th·ªã gi√°c c·∫∑p tr√°i - ph·∫£i?", a: "Tr√°i n·∫∑ng h∆°n ph·∫£i." },
                    { q: "Tr·ªçng l∆∞·ª£ng th·ªã gi√°c c·∫∑p tr∆∞·ªõc - sau?", a: "Tr∆∞·ªõc n·∫∑ng h∆°n sau." },
                    { q: "Nguy√™n l√Ω 'l√†m b·∫±ng nhau' c·ªßa m·∫Øt l√† g√¨?", a: "G·ªôp c√°c h√¨nh d·∫°ng/m√†u s·∫Øc/k√≠ch th∆∞·ªõc g·∫ßn gi·ªëng nhau th√†nh m·ªôt nh√≥m chung." },
                    { q: "H√¨nh v√¥ h∆∞·ªõng ƒë·∫∑t c·∫°nh h√¨nh ƒë·ªãnh h∆∞·ªõng s·∫Ω ra sao?", a: "H√¨nh v√¥ h∆∞·ªõng c√≥ xu h∆∞·ªõng chuy·ªÉn ƒë·ªông theo h√¨nh ƒë·ªãnh h∆∞·ªõng." },
                    { q: "Y·∫øu t·ªë ·∫£nh h∆∞·ªüng l·ªõn nh·∫•t ƒë·∫øn ƒë·ªãnh h∆∞·ªõng chuy·ªÉn ƒë·ªông th·ªã gi√°c?", a: "B·ªë c·ª•c." },
                    { q: "T·ªëc ƒë·ªô chuy·ªÉn ƒë·ªông th·ªã gi√°c ph·ª• thu·ªôc v√†o?", a: "Ph√¥ng h√¨nh, v·ªã tr√≠, m√†u s·∫Øc." },
                    { q: "T·∫°i sao qu·∫£ng c√°o hay d√πng √¢m thanh/h√¨nh ·∫£nh m·∫°nh?", a: "T·∫°o l·ª±c th·ªã gi√°c l·ªõn ƒë·ªÉ h·∫•p d·∫´n v√† g√¢y nh·ªõ." },
                    { q: "Khi n√†o t·∫°o ra ·∫£o gi√°c?", a: "Khi c∆∞·ªùng ƒë·ªô l·ª±c th·ªã gi√°c ƒë·∫©y l√™n qu√° cao." },
                    { q: "T·∫°i sao thi·∫øt k·∫ø cho tr·∫ª em th∆∞·ªùng bo tr√≤n?", a: "T·∫°o c·∫£m gi√°c d·ªÖ th∆∞∆°ng, an to√†n." },
                    { q: "K·ªãch b·∫£n ƒë·ªì h·ªça (Storyboard) ·ª©ng d·ª•ng r√µ nh·∫•t ·ªü ƒë√¢u?", a: "L√†m phim." },
                    { q: "Giao di·ªán (UI) ·ª©ng d·ª•ng r√µ nh·∫•t ·ªü ƒë√¢u?", a: "Thi·∫øt k·∫ø Web." },
                    { q: "ƒêi·ªÉm c√≥ ƒë·∫∑c t√≠nh g√¨?", a: "V√¥ h∆∞·ªõng, c√≥ t√≠nh t·∫≠p trung, kh√¥ng c√≥ chi·ªÅu." },
                    { q: "N√©t c√≥ ƒë·∫∑c t√≠nh g√¨?", a: "C√≥ chi·ªÅu d√†i, kh√¥ng c√≥ chi·ªÅu r·ªông/s√¢u." },
                    { q: "Di·ªán c√≥ ƒë·∫∑c t√≠nh g√¨?", a: "C√≥ d√†i, r·ªông, kh√¥ng c√≥ s√¢u." },
                    { q: "Kh·ªëi c√≥ ƒë·∫∑c t√≠nh g√¨?", a: "C√≥ d√†i, r·ªông, s√¢u (3 chi·ªÅu)." },
                    { q: "C√≥ bao nhi√™u lo·∫°i n√©t?", a: "4 lo·∫°i: C√≥ nghƒ©a, Li√™n t∆∞·ªüng, ƒêa nghƒ©a, C·∫•u t·∫°o." },
                    { q: "Hi·ªáu qu·∫£ t·∫°o rung l√† g√¨?", a: "M·∫Øt b·ªã gi√°n ƒëo·∫°n tr∆∞·ªõc hai tr∆∞·ªùng l·ª±c b·∫±ng nhau c·∫°nh nhau." },
                    { q: "Ph√¥ng h√¨nh l√† g√¨?", a: "T√≠n hi·ªáu h√¨nh ·∫£nh nh·ªè ƒë·∫∑t tr√™n n·ªÅn r·ªông." },
                    { q: "Hai lo·∫°i √°nh s√°ng c∆° b·∫£n?", a: "T·ª± nhi√™n v√† Nh√¢n t·∫°o." },
                    { q: "√Ånh s√°ng m·∫∑t tr·ªùi t·∫°o hi·ªáu qu·∫£ g√¨?", a: "H√¨nh kh·ªëi r√µ n√©t." },
                    { q: "M√†u c·ªông c∆° b·∫£n?", a: "ƒê·ªè (Red), Xanh l·ª•c (Green), Xanh lam (Blue)." },
                    { q: "M√†u tr·ª´ c∆° b·∫£n (in ·∫•n)?", a: "Xanh l∆° (Cyan), H·ªìng c√°nh sen (Magenta), V√†ng (Yellow)." },
                    { q: "Tr·ªôn t·∫•t c·∫£ m√†u c·ªông ra m√†u g√¨?", a: "M√†u tr·∫Øng." },
                    { q: "Tr·ªôn t·∫•t c·∫£ m√†u tr·ª´ ra m√†u g√¨?", a: "M√†u ƒëen." },
                    { q: "M√†u v√¥ s·∫Øc l√† g√¨?", a: "ƒêen, Tr·∫Øng, X√°m." },
                    { q: "Gam m√†u n√≥ng l√† g√¨?", a: "B∆∞·ªõc s√≥ng d√†i, g√¢y c·∫£m gi√°c ·∫•m √°p (ƒê·ªè, Cam, V√†ng...)." },
                    { q: "Gam m√†u l·∫°nh l√† g√¨?", a: "B∆∞·ªõc s√≥ng ng·∫Øn, g√¢y c·∫£m gi√°c m√°t m·∫ª (Xanh...)." },
                    { q: "Ph·ªëi c·∫£nh m·ªôt ƒëi·ªÉm t·ª• m·∫°nh v·ªÅ g√¨?", a: "Chi·ªÅu s√¢u." },
                    { q: "Ph·ªëi c·∫£nh hai ƒëi·ªÉm t·ª• m·∫°nh v·ªÅ g√¨?", a: "Chi·ªÅu s√¢u v√† chi·ªÅu r·ªông." },
                    { q: "Ph·ªëi c·∫£nh ba ƒëi·ªÉm t·ª• m·∫°nh v·ªÅ g√¨?", a: "Chi·ªÅu s√¢u, r·ªông v√† cao." },
                    { q: "B·ªë c·ª•c ƒëƒÉng ƒë·ªëi l√† g√¨?", a: "S·∫Øp x·∫øp ƒë·ªëi x·ª©ng qua tr·ª•c/t√¢m." },
                    { q: "B·ªë c·ª•c ƒë∆∞·ªùng di·ªÅm l√† g√¨?", a: "L·∫∑p l·∫°i theo m·ªôt chi·ªÅu (d·ªçc/ngang)." },
                    { q: "B·ªë c·ª•c d√†n tr·∫£i l√† g√¨?", a: "L·∫∑p l·∫°i theo c·∫£ hai chi·ªÅu (hoa vƒÉn v·∫£i...)." },
                    { q: "T·ª∑ l·ªá v√†ng l√† bao nhi√™u?", a: "X·∫•p x·ªâ 1.618." },
                    { q: "Ai nghi√™n c·ª©u t·ª∑ l·ªá v√†ng?", a: "Fibonacci (trong t·ª± nhi√™n)." },
                    { q: "Ai nghi√™n c·ª©u h√¨nh ch·ªØ nh·∫≠t v√†ng trong ki·∫øn tr√∫c?", a: "Le Corbusier." },
                    { q: "Nh·ªãp ƒëi·ªáu l√† g√¨?", a: "S·ª± l·∫∑p l·∫°i c√≥ t·ªï ch·ª©c." },
                    { q: "4 lo·∫°i nh·ªãp ƒëi·ªáu c∆° b·∫£n?", a: "Li√™n t·ª•c, Ti·ªám bi·∫øn, L·ªìi l√µm, Giao thoa." },
                    { q: "T∆∞∆°ng ph·∫£n l√† g√¨?", a: "S·ª± kh√°c bi·ªát, tr√°i ng∆∞·ª£c gi·ªØa c√°c t√≠n hi·ªáu th·ªã gi√°c." },
                    { q: "Vi bi·∫øn l√† g√¨?", a: "S·ª± t∆∞∆°ng ph·∫£n nh·∫π, chuy·ªÉn bi·∫øn d·∫ßn d·∫ßn." },
                    { q: "T∆∞∆°ng ph·∫£n hay Vi bi·∫øn t·∫°o ·∫•n t∆∞·ª£ng m·∫°nh h∆°n?", a: "T∆∞∆°ng ph·∫£n (thu h√∫t th·ªã gi√°c t·ªët h∆°n)." }
                ]
            },
            "Ti·∫øng Anh": { "C∆° b·∫£n": [{ q: "Hello", a: "Xin ch√†o" }, { q: "Apple", a: "Qu·∫£ t√°o" }], "IELTS": [{ q: "Serendipity", a: "S·ª± t√¨nh c·ªù may m·∫Øn" }] },
            "C√¥ng ngh·ªá": { "HTML": [{ q: "<div>", a: "Th·∫ª t·∫°o kh·ªëi" }] }
        };

        const ZEN_QUOTES = ["H√≠t v√†o s·ª± b√¨nh y√™n...", "B·∫°n l√†m t·ªët l·∫Øm...", "Ngh·ªâ ng∆°i x√≠u nh√©...", "H√£y nh·∫π nh√†ng v·ªõi b·∫£n th√¢n."];

        let studyQueue = [], masteredCount = 0, totalCards = 0, currentSubject = "", currentLevel = "";
        const exploreGrid = document.getElementById('explore-grid'), buddyGrid = document.getElementById('buddy-grid'), root = document.documentElement;
        const videoContainer = document.getElementById('video-bg-container');
        const ambientPlayer = document.getElementById('ambient-audio');
        
        let isAmbientMuted = false; 
        let lastAmbientVolume = 0.5;

        let youtubeAudioPlayer = null;
        let isYouTubeAudioPlaying = false;
        let currentExternalType = null; 
        let isExternalMuted = false;
        let lastExternalVolume = 50;
        let isYouTubeReady = false; 

        let isExclusiveMode = false;
        let pendingYouTubeId = null; 
        
        // Quiz vars
        let quizScore = 0;
        let currentQuizData = null;

        function updateRealTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('real-time-clock').innerText = timeString;
        }
        setInterval(updateRealTime, 1000);

        function triggerFireEffect(e) {
            const numSparks = 12; 
            const container = document.body;
            for (let i = 0; i < numSparks; i++) {
                const spark = document.createElement('div');
                spark.classList.add('spark-particle');
                spark.style.left = e.clientX + 'px';
                spark.style.top = e.clientY + 'px';
                const angle = Math.random() * Math.PI * 2;
                const distance = 60 + Math.random() * 60; 
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                spark.style.setProperty('--tx', `${tx}px`);
                spark.style.setProperty('--ty', `${ty}px`);
                container.appendChild(spark);
                setTimeout(() => spark.remove(), 800);
            }
        }

        function toggleAudioMode() {
            isExclusiveMode = document.getElementById('audio-exclusive-mode').checked;
            checkExclusiveState();
        }

        function checkExclusiveState() {
            const controls = document.getElementById('local-player-controls');
            const isExternalPlaying = isYouTubeAudioPlaying || currentExternalType === 'soundcloud';
            
            if (isExclusiveMode && isExternalPlaying) {
                ambientPlayer.pause();
                controls.classList.add('disabled-controls');
            } else {
                controls.classList.remove('disabled-controls');
                if (ambientPlayer.paused && !isAmbientMuted) {
                    ambientPlayer.play().catch(e=>{});
                }
            }
        }

        function toggleBlur() {
            const isChecked = document.getElementById('blur-toggle').checked;
            const val = document.getElementById('blur-slider').value;
            const video = document.getElementById('video-bg-container');
            video.style.filter = isChecked ? `blur(${val}px)` : 'none';
        }

        function changeBlur(val) {
            const toggle = document.getElementById('blur-toggle');
            if (!toggle.checked) toggle.checked = true;
            const video = document.getElementById('video-bg-container');
            video.style.filter = `blur(${val}px)`;
        }

        function onYouTubeIframeAPIReady() {
            youtubeAudioPlayer = new YT.Player('youtube-audio-container', {
                height: '0', width: '0',
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1 },
                events: { 'onReady': onPlayerReady }
            });
        }
        
        function onPlayerReady(event) {
            isYouTubeReady = true; 
            if (pendingYouTubeId) {
                loadCustomEmbed();
            }
        }

        function playSFX(type) {
            const sound = document.getElementById(`sfx-${type}`);
            if(sound) { sound.currentTime = 0; sound.play().catch(e => {}); }
        }

        document.addEventListener('touchstart', function() {
            if (ambientPlayer.paused && !isYouTubeAudioPlaying) { 
                ambientPlayer.play().then(() => ambientPlayer.pause());
            }
        }, { once: true });

        function toggleSpotifyInput() {
            const group = document.getElementById('spotify-input-group');
            group.style.display = group.style.display === 'flex' ? 'none' : 'flex'; // Toggle between none and flex
        }

        function getYouTubeId(url) {
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }

        function stopExternalMusic() {
            const btn = document.getElementById('btn-ext-stop');
            const extControls = document.getElementById('external-audio-controls');
            
            document.getElementById('embed-container').innerHTML = '';
            document.getElementById('embed-container').style.display = 'none';
            btn.style.display = 'none';
            extControls.style.display = 'none';
            currentExternalType = null;
            
            if (youtubeAudioPlayer && isYouTubeAudioPlaying) {
                youtubeAudioPlayer.stopVideo();
                isYouTubeAudioPlaying = false;
            }
            
            checkExclusiveState();
        }

        function loadCustomEmbed() {
            let url = document.getElementById('spotify-url').value.trim();
            const container = document.getElementById('embed-container');
            const stopBtn = document.getElementById('btn-ext-stop');
            const extControls = document.getElementById('external-audio-controls');
            
            if(!url) return; 

            const youtubeId = getYouTubeId(url);
            
            if (youtubeId) {
                if(!isYouTubeReady || !youtubeAudioPlayer || !youtubeAudioPlayer.loadVideoById) {
                    pendingYouTubeId = youtubeId;
                    container.innerHTML = `<div style="padding:10px; font-size:12px; color:var(--accent-color); background:rgba(255,255,255,0.8); border-radius:8px; text-align:center;">‚è≥ ƒêang k·∫øt n·ªëi YouTube...</div>`;
                    container.style.display = 'block';
                    return; 
                }

                youtubeAudioPlayer.loadVideoById(youtubeId);
                youtubeAudioPlayer.setVolume(lastExternalVolume);
                isYouTubeAudioPlaying = true;
                currentExternalType = 'youtube';
                
                container.innerHTML = `<div style="padding:15px; font-size:13px; font-weight:bold; color:var(--accent-color); background:rgba(255,255,255,0.8); border-radius:12px; text-align:center;"><i class="fa-brands fa-youtube" style="color:red;"></i> ƒêang ph√°t t·ª´ YouTube...</div>`;
                container.style.display = 'block';
                stopBtn.style.display = 'inline-block';
                extControls.style.display = 'block'; 
                
                checkExclusiveState();
                pendingYouTubeId = null;
                return;
            }
            
            let embedSrc = "";
            if (url.includes('soundcloud.com')) {
                const encodedUrl = encodeURIComponent(url);
                embedSrc = `https://w.soundcloud.com/player/?url=${encodedUrl}&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
                currentExternalType = 'soundcloud';
                extControls.style.display = 'none'; 
            } 
            
            if(embedSrc) {
                container.innerHTML = `<iframe src="${embedSrc}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                container.style.display = 'block';
                stopBtn.style.display = 'inline-block';
                checkExclusiveState();
            }
        }

        window.addEventListener('load', () => {
             document.getElementById('spotify-url').value = "";
             pendingYouTubeId = null;
             updateRealTime(); 
        });

        function changeAmbientVolume(val) {
            ambientPlayer.volume = val;
            isAmbientMuted = (val == 0);
            if (!isAmbientMuted) lastAmbientVolume = val;
            updateAmbientIcon();
        }

        function toggleAmbientMute() {
            if (ambientPlayer.muted || ambientPlayer.volume === 0) {
                ambientPlayer.muted = false;
                ambientPlayer.volume = lastAmbientVolume > 0 ? lastAmbientVolume : 0.5;
                document.getElementById('volume-slider').value = ambientPlayer.volume;
                ambientPlayer.play().catch(e => {});
                isAmbientMuted = false;
            } else {
                ambientPlayer.muted = true;
                document.getElementById('volume-slider').value = 0;
                isAmbientMuted = true;
            }
            updateAmbientIcon();
        }

        function updateAmbientIcon() {
            const btn = document.getElementById('mute-btn');
            if (isAmbientMuted || ambientPlayer.muted || ambientPlayer.volume === 0) { 
                btn.className = 'fa-solid fa-volume-xmark'; 
            } else if (ambientPlayer.volume < 0.5) { 
                btn.className = 'fa-solid fa-volume-low'; 
            } else { 
                btn.className = 'fa-solid fa-volume-high'; 
            }
        }

        function changeExternalVolume(val) {
            lastExternalVolume = val;
            if(youtubeAudioPlayer && isYouTubeAudioPlaying) {
                youtubeAudioPlayer.setVolume(val);
                isExternalMuted = (val == 0);
                updateExternalIcon();
            }
        }

        function toggleExternalMute() {
            if(youtubeAudioPlayer && isYouTubeAudioPlaying) {
                if (youtubeAudioPlayer.isMuted()) {
                    youtubeAudioPlayer.unMute();
                    youtubeAudioPlayer.setVolume(lastExternalVolume);
                    document.getElementById('ext-volume-slider').value = lastExternalVolume;
                    isExternalMuted = false;
                } else {
                    youtubeAudioPlayer.mute();
                    document.getElementById('ext-volume-slider').value = 0;
                    isExternalMuted = true;
                }
                updateExternalIcon();
            }
        }

        function updateExternalIcon() {
            const btn = document.getElementById('ext-mute-btn');
            if(isExternalMuted) btn.className = 'fa-solid fa-volume-xmark';
            else btn.className = 'fa-solid fa-volume-high';
        }

        function switchView(view) {
            document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
            document.body.classList.remove('quiz-active'); // Remove quiz active state
            
            // Default panel state
            document.getElementById('panel-left').style.display = 'flex';
            document.getElementById('panel-timer').style.display = 'flex';
            document.getElementById('panel-flashcards').style.display = 'flex'; 
            document.getElementById('panel-quiz').style.display = 'none';

            if(view === 'myspace') {
                document.getElementById('btn-myspace').classList.add('active');
            } else if (view === 'focus') {
                document.getElementById('btn-focus').classList.add('active');
                document.body.classList.add('quiz-active'); // Re-use this for focus mode to hide sidebar
                document.getElementById('panel-flashcards').style.display = 'none';
            } else if (view === 'quiz') {
                document.getElementById('btn-quiz').classList.add('active');
                document.body.classList.add('quiz-active'); // Special quiz layout
                document.getElementById('panel-flashcards').style.display = 'none';
                document.getElementById('panel-timer').style.display = 'none';
                document.getElementById('panel-quiz').style.display = 'flex';
                generateQuiz(); 
            }
        }

        // --- QUIZ LOGIC (AI) ---
        function generateQuiz() {
            const container = document.getElementById('quiz-options-container');
            const questionEl = document.getElementById('quiz-question');
            const badgeEl = document.getElementById('quiz-category-badge');
            const streakEl = document.getElementById('quiz-streak');
            
            container.innerHTML = '';
            streakEl.innerText = `Streak: ${quizScore} üî•`;

            if(!currentSubject || !currentLevel || !LEARNING_DATABASE[currentSubject] || !LEARNING_DATABASE[currentSubject][currentLevel]) {
                questionEl.innerText = "Vui l√≤ng ch·ªçn M√¥n h·ªçc v√† C·∫•p ƒë·ªô ·ªü tab 'H·ªçc Nhanh' tr∆∞·ªõc!";
                badgeEl.innerText = "Ch∆∞a ch·ªçn m√¥n";
                return;
            }

            badgeEl.innerText = `${currentSubject} - ${currentLevel}`;
            
            const list = LEARNING_DATABASE[currentSubject][currentLevel];
            if(list.length < 4) {
                 questionEl.innerText = "C·∫ßn √≠t nh·∫•t 4 th·∫ª ƒë·ªÉ t·∫°o tr·∫Øc nghi·ªám!";
                 return;
            }

            const correctItem = list[Math.floor(Math.random() * list.length)];
            currentQuizData = correctItem;
            questionEl.innerText = correctItem.q;

            let answers = [correctItem.a];
            while(answers.length < 4) {
                const randomItem = list[Math.floor(Math.random() * list.length)];
                if(!answers.includes(randomItem.a)) {
                    answers.push(randomItem.a);
                }
            }

            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option-btn';
                btn.innerText = ans;
                btn.onclick = () => checkQuizAnswer(btn, ans, correctItem.a);
                container.appendChild(btn);
            });
        }

        function checkQuizAnswer(btn, selected, correct) {
            const allBtns = document.querySelectorAll('.quiz-option-btn');
            
            allBtns.forEach(b => b.disabled = true);

            if(selected === correct) {
                btn.classList.add('correct');
                playSFX('success');
                quizScore++;
                document.getElementById('quiz-streak').innerText = `Streak: ${quizScore} üî•`;
                setTimeout(generateQuiz, 1500); 
            } else {
                btn.classList.add('wrong');
                playSFX('click'); 
                quizScore = 0;
                document.getElementById('quiz-streak').innerText = `Streak: ${quizScore} üî•`;
                
                allBtns.forEach(b => {
                    if(b.innerText === correct) b.classList.add('correct');
                });
            }
        }

        function initApp() { 
            initExplore(); initLearningDropdowns(); updateDisplay(); updateCount(); 
            ambientPlayer.volume = 0.5; 
            document.getElementById('volume-slider').value = 0.5; 
            updateAmbientIcon();
        }

        function initLearningDropdowns() {
            const subjectSelect = document.getElementById('subject-select');
            const levelSelect = document.getElementById('level-select');
            subjectSelect.innerHTML = '';
            if(Object.keys(LEARNING_DATABASE).length === 0) {
                const opt = document.createElement('option'); opt.innerText = "Tr·ªëng"; subjectSelect.appendChild(opt);
                levelSelect.innerHTML = ''; return;
            }
            Object.keys(LEARNING_DATABASE).forEach(sub => {
                const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub;
                subjectSelect.appendChild(opt);
            });
            subjectSelect.onchange = () => {
                currentSubject = subjectSelect.value;
                if(!LEARNING_DATABASE[currentSubject]) return;
                const levels = Object.keys(LEARNING_DATABASE[currentSubject]);
                levelSelect.innerHTML = '';
                levels.forEach(lvl => {
                    const opt = document.createElement('option'); opt.value = lvl; opt.innerText = lvl;
                    levelSelect.appendChild(opt);
                });
                changeTopic();
            };
            levelSelect.onchange = changeTopic;
            subjectSelect.dispatchEvent(new Event('change'));
        }

        function changeTopic() {
            currentSubject = document.getElementById('subject-select').value;
            currentLevel = document.getElementById('level-select').value;
            if(!currentSubject || !currentLevel) {
                studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                return;
            }
            const originalCards = LEARNING_DATABASE[currentSubject][currentLevel];
            studyQueue = JSON.parse(JSON.stringify(originalCards));
            totalCards = studyQueue.length;
            masteredCount = 0;
            renderCard();
        }

        function toggleAddSubjectForm() { hideAllForms(); const f=document.getElementById('add-subject-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddLevelForm() { hideAllForms(); const f=document.getElementById('add-level-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function toggleAddCardForm() { hideAllForms(); const f=document.getElementById('add-card-form'); f.style.display=f.style.display==='flex'?'none':'flex'; }
        function hideAllForms() {
            document.getElementById('add-subject-form').style.display='none';
            document.getElementById('add-level-form').style.display='none';
            document.getElementById('add-card-form').style.display='none';
        }

        function saveNewSubject() {
            const subName = document.getElementById('new-subject-name').value;
            const subLevel = document.getElementById('new-subject-level').value;
            if(subName && subLevel) {
                LEARNING_DATABASE[subName] = {}; LEARNING_DATABASE[subName][subLevel] = [];
                initLearningDropdowns();
                const subSelect = document.getElementById('subject-select'); subSelect.value = subName; subSelect.dispatchEvent(new Event('change'));
                document.getElementById('new-subject-name').value=''; document.getElementById('new-subject-level').value=''; toggleAddSubjectForm();
                playSFX('success');
            }
        }

        function saveNewLevel() {
            const newLvl = document.getElementById('new-level-name').value;
            if(newLvl && currentSubject) {
                LEARNING_DATABASE[currentSubject][newLvl] = [];
                const levelSelect = document.getElementById('level-select');
                const opt = document.createElement('option'); opt.value = newLvl; opt.innerText = newLvl;
                levelSelect.appendChild(opt);
                levelSelect.value = newLvl; 
                changeTopic();
                document.getElementById('new-level-name').value=''; toggleAddLevelForm();
                playSFX('success');
            }
        }

        function saveCustomCard() {
            const q = document.getElementById('new-card-q').value, a = document.getElementById('new-card-a').value;
            if(q && a) {
                LEARNING_DATABASE[currentSubject][currentLevel].push({q:q, a:a});
                studyQueue.push({q:q, a:a}); totalCards++;
                
                if (studyQueue.length === 1 && totalCards === 1) {
                    masteredCount = 0;
                    renderCard();
                } else {
                    document.getElementById('new-card-q').value=''; 
                    document.getElementById('new-card-a').value=''; 
                    toggleAddCardForm(); 
                    renderCard();
                }
                playSFX('success');
            }
        }

        function deleteSubject() {
            const sub = document.getElementById('subject-select').value;
            if(!sub || sub === "Tr·ªëng") return;
            if(confirm(`X√≥a m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub];
                initLearningDropdowns();
                if(Object.keys(LEARNING_DATABASE).length === 0) {
                    studyQueue = []; totalCards=0; masteredCount=0; renderCard();
                }
            }
        }

        function deleteLevel() {
            const sub = document.getElementById('subject-select').value;
            const lvl = document.getElementById('level-select').value;
            if(!sub || !lvl) return;
            if(confirm(`X√≥a c·∫•p ƒë·ªô "${lvl}" c·ªßa m√¥n "${sub}"?`)) {
                delete LEARNING_DATABASE[sub][lvl];
                document.getElementById('subject-select').dispatchEvent(new Event('change'));
            }
        }

        function deleteCurrentCard(event) {
            event.stopPropagation();
            if (studyQueue.length === 0) return;
            if(!confirm("X√≥a th·∫ª n√†y?")) return;
            const currentCard = studyQueue[0];
            const dbList = LEARNING_DATABASE[currentSubject][currentLevel];
            const index = dbList.findIndex(c => c.q === currentCard.q && c.a === currentCard.a);
            if(index > -1) dbList.splice(index, 1);
            studyQueue.shift(); totalCards--; renderCard();
        }

        function renderCard() {
            const container = document.querySelector('.flashcard-container');
            const controlsArea = document.getElementById('fc-controls-area');
            
            container.classList.remove('flipped');
            
            setTimeout(() => {
                if (studyQueue.length === 0) {
                    const isEmpty = totalCards === 0;
                    document.getElementById('fc-cat-front').innerText = currentSubject || "Tr·ªëng";
                    document.getElementById('fc-q').innerText = isEmpty ? "Ch∆∞a c√≥ th·∫ª n√†o" : "ƒê√£ xong!";
                    document.getElementById('fc-cat-back').innerText = "";
                    document.getElementById('fc-a').innerText = isEmpty ? "B·∫•m + ƒë·ªÉ th√™m" : "B·∫°n ƒë√£ h·ªçc h·∫øt b·ªô n√†y!";
                    
                    if (!isEmpty) {
                        controlsArea.innerHTML = `<button class="btn-fc btn-fc-restart" onclick="resetLearning(); playSFX('click')">H·ªçc l·∫°i t·ª´ ƒë·∫ßu ‚Ü∫</button>`;
                    } else {
                        controlsArea.innerHTML = '';
                    }
                    return;
                }
                
                controlsArea.innerHTML = `
                    <button class="btn-fc btn-fc-review" onclick="nextCard(false); playSFX('click')">C·∫ßn √¥n l·∫°i üß†</button>
                    <button class="btn-fc btn-fc-master" onclick="nextCard(true); playSFX('success')">ƒê√£ thu·ªôc ‚úÖ</button>
                `;
                
                const current = studyQueue[0];
                document.getElementById('fc-cat-front').innerText = currentSubject;
                document.getElementById('fc-q').innerText = current.q;
                document.getElementById('fc-cat-back').innerText = currentLevel;
                document.getElementById('fc-a').innerText = current.a;
            }, 200);
            
            const percent = totalCards > 0 ? (masteredCount / totalCards) * 100 : 0;
            document.getElementById('fc-bar').style.width = `${percent}%`;
            document.getElementById('mini-fc').innerText = `${masteredCount}/${totalCards} Done`;
        }

        function flipCard(el) { if (studyQueue.length > 0) { el.classList.toggle('flipped'); playSFX('click'); } }
        
        function nextCard(isMastered) {
            if (studyQueue.length === 0) return;
            document.querySelector('.flashcard-container').classList.remove('flipped');
            setTimeout(() => {
                const card = studyQueue.shift();
                if (isMastered) masteredCount++; else studyQueue.push(card);
                renderCard();
            }, 300);
        }
        
        function resetLearning() { changeTopic(); }

        function initExplore() {
            exploreGrid.innerHTML = '';
            for (const key in THEMES) {
                const item = document.createElement('div');
                item.className = 'explore-item'; 
                item.innerText = THEMES[key].emoji;
                item.onclick = (e) => { e.stopPropagation(); setTheme(key); playSFX('click'); }; item.id = `theme-${key}`;
                exploreGrid.appendChild(item);
            }
            buddyGrid.innerHTML = '';
            for (const key in BUDDIES) {
                const item = document.createElement('div');
                item.className = 'buddy-item'; item.style.backgroundImage = `url('${BUDDIES[key].thumb}')`;
                item.innerHTML = `<div class="buddy-name">${BUDDIES[key].name}</div>`;
                item.onclick = (e) => { e.stopPropagation(); setBodyDoubling(key); playSFX('click'); }; item.id = `buddy-${key}`;
                buddyGrid.appendChild(item);
            }
        }

        let transitionTimeout;

        function setTheme(key) {
            const data = THEMES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            
            document.body.style.backgroundColor = data.color;

            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);

            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `<video id="bg-video-player" autoplay muted loop playsinline><source src="${data.bg}" type="video/mp4"></video>`;
                    vidContainer.classList.add('active');
                }
                
                if (key === 'morning' || key === 'forest' || key === 'rain' || key === 'cafe' || key === 'sunset') {
                    document.documentElement.style.setProperty('--text-main', '#333');
                    document.documentElement.style.setProperty('--btn-text-color', '#fff');
                } else {
                    document.documentElement.style.setProperty('--text-main', '#fff');
                    document.documentElement.style.setProperty('--btn-text-color', '#333');
                }
                
                root.style.setProperty('--accent-color', data.color);
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = data.track;
                
                const art = document.getElementById('album-art');
                art.style.backgroundImage = 'none';
                art.innerHTML = data.emoji;

                if(!isYouTubeAudioPlaying) {
                    ambientPlayer.src = data.audio;
                    if (!ambientPlayer.muted && ambientPlayer.volume > 0) { 
                        ambientPlayer.play().catch(e => {}); 
                    }
                }

                resetStates(); document.getElementById(`theme-${key}`).classList.add('active'); 
                document.getElementById(`theme-${key}`).style.backgroundColor = data.color;
            }, 800); 
        }

        function setBodyDoubling(key) {
            const data = BUDDIES[key]; 
            const vidContainer = document.getElementById('video-bg-container');
            
            vidContainer.classList.remove('active');

            if (transitionTimeout) clearTimeout(transitionTimeout);
            transitionTimeout = setTimeout(() => {
                if(data.type === "local") {
                    vidContainer.innerHTML = `<video id="bg-video-player" autoplay muted loop playsinline><source src="${data.url}" type="video/mp4"></video>`;
                    vidContainer.classList.add('active');
                    document.body.style.backgroundImage = 'none';
                }
                resetStates(); document.getElementById(`buddy-${key}`).classList.add('active');
                if(document.getElementById('track-name')) document.getElementById('track-name').innerText = `H·ªçc c√πng ${data.name}`;
            }, 800);
        }

        function resetStates() {
            document.querySelectorAll('.explore-item').forEach(el => { el.classList.remove('active'); el.style.backgroundColor = ''; el.style.boxShadow = ''; });
            document.querySelectorAll('.buddy-item').forEach(el => el.classList.remove('active'));
        }

        function selectMood(m) { 
            setTheme(m); 
            // INTRO HIDE LOGIC
            document.getElementById('intro-overlay').classList.add('hidden-intro');
            document.getElementById('main-nav').classList.add('visible');
        }
        function togglePanel(id) { document.getElementById(id).classList.toggle('collapsed'); }
        
        let zenInt, totalMin = 0;
        function openZenMode() { document.getElementById('zen-overlay').classList.add('active'); document.getElementById('zen-circle').classList.add('breathing-anim'); document.getElementById('zen-quote').innerText = `"${ZEN_QUOTES[Math.floor(Math.random()*ZEN_QUOTES.length)]}"`; updateBreath(); zenInt=setInterval(updateBreath,8000); }
        function updateBreath() { const t=document.getElementById('zen-text'); t.innerText="H√≠t s√¢u..."; setTimeout(()=>t.innerText="Gi·ªØ...",3500); setTimeout(()=>t.innerText="Th·ªü ra...",4500); }
        function closeZenMode() { document.getElementById('zen-overlay').classList.remove('active'); document.getElementById('zen-circle').classList.remove('breathing-anim'); clearInterval(zenInt); }

        const MODES = { pomodoro: 25, short: 5, long: 15 };
        let timeLeft = 25*60, timerInt, isRunning=false;
        function updateDisplay() { 
            const m=Math.floor(timeLeft/60).toString().padStart(2,'0'), s=(timeLeft%60).toString().padStart(2,'0'); 
            document.getElementById('timer-text').innerText=`${m}:${s}`; document.getElementById('mini-timer').innerText=`${m}:${s}`; document.title=isRunning?`(${m}:${s}) ƒêang t·∫≠p trung...`:"Kh√¥ng gian Chill";
        }
        function toggleTimer() {
            if(isRunning) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; }
            else { isRunning=true; document.getElementById('btn-action').textContent="T·∫°m d·ª´ng"; timerInt=setInterval(()=>{ if(timeLeft>0){ timeLeft--; updateDisplay(); if(timeLeft%60===0) totalMin++; if(totalMin>60){ if(confirm("B·∫°n ƒë√£ h·ªçc l√¢u r·ªìi, ngh·ªâ ng∆°i ch√∫t nh√©?")){openZenMode(); toggleTimer(); totalMin=0;} else totalMin=0; } } else { clearInterval(timerInt); isRunning=false; alert("H·∫øt gi·ªù r·ªìi!"); playSFX('alarm'); } },1000); }
        }
        function switchMode(m) { clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=MODES[m]*60; document.getElementById('custom-minutes').value=MODES[m]; updateDisplay(); document.querySelectorAll('.timer-controls span').forEach(el=>el.classList.remove('active')); document.getElementById(`btn-${m}`).classList.add('active'); }
        function adjustTime(a) { let v=parseInt(document.getElementById('custom-minutes').value)||0; v+=a; if(v<1)v=1; document.getElementById('custom-minutes').value=v; }
        function applyCustomTime() { const v=parseInt(document.getElementById('custom-minutes').value); if(v>0){ clearInterval(timerInt); isRunning=false; document.getElementById('btn-action').textContent="B·∫Øt ƒë·∫ßu"; timeLeft=v*60; updateDisplay(); } }

        const taskInput = document.getElementById('new-task-input'), taskList = document.getElementById('task-list');
        function showInput() { document.getElementById('btn-show-add').style.display='none'; document.getElementById('input-group').style.display='flex'; taskInput.focus(); }
        function addTask() { if(!taskInput.value.trim()) return; const li=document.createElement('li'); li.className='task-item'; li.innerHTML=`<input type="checkbox" class="task-checkbox" onclick="toggleTask(this)"> <span class="task-text">${taskInput.value}</span> <i class="fa-solid fa-trash-can delete-btn" onclick="this.parentElement.remove(); updateCount()" style="color:#ffb8b8; cursor:pointer;"></i>`; taskList.appendChild(li); taskInput.value=''; document.getElementById('input-group').style.display='none'; document.getElementById('btn-show-add').style.display='flex'; updateCount(); }
        function toggleTask(cb) { cb.parentElement.classList.toggle('completed', cb.checked); if(cb.checked) playSFX('success'); else playSFX('click'); }
        taskInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')addTask()});
        function updateCount() { document.getElementById('task-count').innerText=`(${taskList.children.length})`; }

        initApp();
    </script>
</body>
</html>